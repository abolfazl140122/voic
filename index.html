<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3498db"/>
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/hassantafreshi/tools-collection/master/assets/images/currency-converter/icon-192x192.png">
    <link rel="manifest" id="manifest">

    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø±Ø²ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ================== CSS ================== */
        :root {
            --bg-color: #f4f7fc; --card-bg: #ffffff; --text-color: #34495e;
            --primary-color: #3498db; --primary-hover: #2980b9; --border-color: #e2e8f0;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07); --input-bg: #fdfdff;
            --success-color: #2ecc71; --danger-color: #e74c3c; --neutral-color: #95a5a6;
            --skeleton-bg: #e2e8f0;
        }
        [data-theme="dark"] {
            --bg-color: #1a202c; --card-bg: #2d3748; --text-color: #e2e8f0;
            --primary-color: #4299e1; --primary-hover: #2b6cb0; --border-color: #4a5568;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.2); --input-bg: #1a202c;
            --success-color: #27ae60; --danger-color: #c0392b; --neutral-color: #7f8c8d;
            --skeleton-bg: #4a5568;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding: 20px; transition: background-color 0.3s, color 0.3s;
        }

        .main-container { width: 100%; max-width: 1200px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: clamp(22px, 5vw, 28px); }
        .theme-switcher {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 50px;
            padding: 5px; cursor: pointer; font-size: 18px; width: 80px; display: flex; justify-content: space-between;
        }
        .theme-switcher i { padding: 5px; border-radius: 50%; }
        .theme-switcher .active { background: var(--primary-color); color: white; }

        .app-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 800px) { .app-grid { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); } }


        .card {
            background: var(--card-bg); padding: 30px; border-radius: 15px; box-shadow: var(--shadow);
            border: 1px solid var(--border-color); transition: all 0.3s ease-in-out;
            opacity: 0; transform: translateY(20px);
            display: flex; flex-direction: column;
        }
        .card.visible { opacity: 1; transform: translateY(0); }
        .card h3 { margin-bottom: 20px; font-size: 20px; }

        .converter .input-group { margin-bottom: 20px; }
        .converter label { font-weight: 500; display: block; margin-bottom: 8px; }
        .currency-input-wrapper { position: relative; }
        .currency-input-wrapper .icon { position: absolute; top: 50%; transform: translateY(-50%); left: 15px; color: #999; font-size: 22px; }
        .currency-input-wrapper input { padding-right: 15px; padding-left: 50px; }
        input {
            width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color); font-family: 'Vazirmatn', sans-serif; font-size: 16px;
        }
        .conversion-flow { display: flex; align-items: center; margin: 25px 0; }
        .conversion-flow .currency-box { flex: 1; }
        .conversion-flow #swap-btn { background: var(--card-bg); border: 2px solid var(--primary-color); color: var(--primary-color); width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 18px; margin: 0 15px; transition: all 0.3s; }
        .conversion-flow #swap-btn:hover { background: var(--primary-color); color: white; transform: rotate(180deg); }
        
        .currency-dropdown {
            display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px;
            overflow-y: auto; background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 8px; z-index: 10; margin-top: 5px;
        }
        .currency-dropdown.show { display: block; }
        .currency-dropdown-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; cursor: pointer; }
        .currency-dropdown-item:hover { background: var(--primary-color); color: white; }
        .currency-dropdown-item .fav-star { color: #ccc; transition: color 0.2s, transform 0.2s; }
        .currency-dropdown-item .fav-star.favorited { color: #f1c40f; transform: scale(1.2); }
        
        #convert-btn { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; transition: background-color 0.3s; position: relative; overflow: hidden; }
        #convert-btn:hover { background: var(--primary-hover); }
        #convert-btn.loading { background: var(--primary-hover); cursor: not-allowed; }
        .btn-spinner { display: none; width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; position: absolute; top: 50%; left: 20px; transform: translateY(-50%); }
        #convert-btn.loading .btn-spinner { display: block; }
        #convert-btn.loading .btn-text { opacity: 0.5; }
        @keyframes spin { 0% { transform: translateY(-50%) rotate(0deg); } 100% { transform: translateY(-50%) rotate(360deg); } }

        .result-box { margin-top: 25px; text-align: center; }
        #result-final-wrapper { display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; color: var(--primary-color); min-height: 35px; }
        #copy-btn { font-size: 18px; margin-right: 12px; cursor: pointer; color: #aaa; transition: all 0.2s; }
        #copy-btn:hover { color: var(--primary-color); transform: scale(1.1); }
        #copy-btn.copied .fa-copy { display: none; }
        #copy-btn.copied .fa-check { display: inline-block; color: var(--success-color); }
        #copy-btn .fa-check { display: none; }
        #result-rate, #result-rate-reverse { font-size: 14px; color: var(--neutral-color); min-height: 20px; }

        #last-updated { font-size: 12px; color: var(--neutral-color); margin-top: 10px; }
        #multi-result-box { margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        #multi-result-box h4 { font-size: 16px; margin-bottom: 15px; text-align: right; }
        .multi-result-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 15px; }

        .watchlist { flex-grow: 1; }
        .watchlist-item { display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 15px; padding: 12px 5px; border-bottom: 1px solid var(--border-color); font-size: 16px; transition: background-color 0.2s; }
        .watchlist-item:last-child { border-bottom: none; }
        .watchlist-item:hover { background-color: rgba(127, 140, 141, 0.1); }
        .watchlist-item .rate { font-weight: 700; color: var(--primary-color); direction: ltr; }
        .watchlist-item .trend { width: 20px; text-align: center; }
        .trend-up { color: var(--success-color); }
        .trend-down { color: var(--danger-color); }
        .trend-stable { color: var(--neutral-color); }
        .skeleton { opacity: 0.7; animation: skeleton-loading 1s linear infinite alternate; }
        @keyframes skeleton-loading { 0% { background-color: var(--skeleton-bg); } 100% { background-color: var(--border-color); } }
        .skeleton-text { width: 60%; height: 20px; border-radius: 5px; }
        .skeleton-rate { width: 80px; height: 20px; border-radius: 5px; }
        #watchlist-empty-msg { text-align: center; color: var(--neutral-color); padding: 20px 0; margin: auto; }
        
        .chart-card { flex-grow: 1; }
        .chart-container { position: relative; flex-grow: 1; min-height: 300px; }
        #chart-disclaimer { font-size: 12px; text-align: center; color: var(--neutral-color); margin-top: 15px; }
        .chart-loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--card-bg-trans);
            display: none; justify-content: center; align-items: center; z-index: 5; border-radius: 15px;
        }
        :root { --card-bg-trans: rgba(255, 255, 255, 0.5); }
        [data-theme="dark"] { --card-bg-trans: rgba(45, 55, 72, 0.7); }
        .chart-loader.show { display: flex; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        [data-theme="dark"] ::-webkit-scrollbar-thumb { background: #555; }
    </style>
</head>
<body>

    <main class="main-container">
        <header class="header card">
            <h1>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø±Ø²ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</h1>
            <div class="theme-switcher" id="theme-switcher" title="ØªØºÛŒÛŒØ± Ù¾ÙˆØ³ØªÙ‡">
                <i class="fas fa-sun active" aria-label="Ù¾ÙˆØ³ØªÙ‡ Ø±ÙˆØ´Ù†"></i><i class="fas fa-moon" aria-label="Ù¾ÙˆØ³ØªÙ‡ ØªØ§Ø±ÛŒÚ©"></i>
            </div>
        </header>

        <div class="app-grid">
            <div class="card converter">
                <div class="input-group"><label for="amount">Ù…Ø¨Ù„Øº</label><input type="text" id="amount" value="1,000" inputmode="decimal"></div>
                <div class="conversion-flow">
                    <div class="currency-box input-group">
                        <label for="from-currency-input">Ø§Ø²</label>
                        <div class="currency-input-wrapper">
                            <span class="icon" id="from-icon"></span>
                            <input type="text" id="from-currency-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ..."><div class="currency-dropdown" id="from-dropdown"></div>
                        </div>
                    </div>
                    <button id="swap-btn" title="Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø§Ø±Ø²Ù‡Ø§" aria-label="Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø§Ø±Ø²Ù‡Ø§"><i class="fas fa-exchange-alt"></i></button>
                    <div class="currency-box input-group">
                        <label for="to-currency-input">Ø¨Ù‡</label>
                        <div class="currency-input-wrapper">
                            <span class="icon" id="to-icon"></span>
                            <input type="text" id="to-currency-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ..."><div class="currency-dropdown" id="to-dropdown"></div>
                        </div>
                    </div>
                </div>
                <button id="convert-btn"><span class="btn-spinner"></span><span class="btn-text">ØªØ¨Ø¯ÛŒÙ„</span></button>
                <div class="result-box">
                    <div id="result-final-wrapper">
                        <button id="copy-btn" title="Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†" aria-label="Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù†ØªÛŒØ¬Ù‡">
                            <i class="far fa-copy"></i><i class="fas fa-check"></i>
                        </button>
                        <span id="result-final"></span>
                    </div>
                    <div id="result-rate"></div>
                    <div id="result-rate-reverse"></div>
                    <div id="last-updated"></div>
                </div>
                <div id="multi-result-box"></div>
            </div>

            <div class="card watchlist">
                <h3 id="watchlist-title">Ù„ÛŒØ³Øª Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù†Ø±Ø®â€ŒÙ‡Ø§</h3>
                <div id="watchlist-content">
                    <!-- Watchlist items will be injected here by JS -->
                </div>
            </div>

            <div class="card chart-card">
                <h3 id="chart-title">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø±Ø®</h3>
                <div class="chart-container">
                    <div class="chart-loader" id="chart-loader"><div class="btn-spinner" style="display:block; width:50px; height:50px; border-width: 5px; border-top-color: var(--primary-color);"></div></div>
                    <canvas id="history-chart"></canvas>
                </div>
                <p id="chart-disclaimer">ØªÙˆØ¬Ù‡: Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª API Ø±Ø§ÛŒÚ¯Ø§Ù†ØŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
            </div>
        </div>
    </main>

    <script>
    // ================== JavaScript (PWA Ready) ==================
    const apiKey = '0ff22125f8e20b66fc0f51ae'; // <-- Ú©Ù„ÛŒØ¯ API Ø´Ù…Ø§
    const apiUrl = `https://v6.exchangerate-api.com/v6/${apiKey}`;

    // --- DOM Elements ---
    const dom = {
        amountInput: document.getElementById('amount'), fromCurrencyInput: document.getElementById('from-currency-input'),
        toCurrencyInput: document.getElementById('to-currency-input'), fromDropdown: document.getElementById('from-dropdown'),
        toDropdown: document.getElementById('to-dropdown'), fromIcon: document.getElementById('from-icon'),
        toIcon: document.getElementById('to-icon'), convertBtn: document.getElementById('convert-btn'),
        swapBtn: document.getElementById('swap-btn'), resultFinal: document.getElementById('result-final'),
        copyBtn: document.getElementById('copy-btn'), resultRate: document.getElementById('result-rate'),
        resultRateReverse: document.getElementById('result-rate-reverse'), themeSwitcher: document.getElementById('theme-switcher'),
        chartTitle: document.getElementById('chart-title'), chartLoader: document.getElementById('chart-loader'),
        ctx: document.getElementById('history-chart').getContext('2d'), lastUpdated: document.getElementById('last-updated'),
        multiResultBox: document.getElementById('multi-result-box'), watchlistContent: document.getElementById('watchlist-content'),
        watchlistTitle: document.getElementById('watchlist-title'),
    };

    // --- Application State ---
    let state = {
        from: 'USD', to: 'IRR', allCurrencies: [],
        favorites: ['EUR', 'GBP', 'JPY', 'AED'], latestRates: null,
    };
    let historyChart;
    const CACHE_DURATION = 3600 * 1000; // 1 hour in milliseconds

    // --- PWA & Caching Logic ---
    const PWA = {
        init() {
            this.setupManifest();
            this.registerServiceWorker();
        },
        setupManifest() {
            const manifest = {
                "name": "Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø±Ø²ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡",
                "short_name": "Ø§Ø±Ø²",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#f4f7fc",
                "theme_color": "#3498db",
                "description": "Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù¾ÛŒØ´Ø±ÙØªÙ‡ ØªØ¨Ø¯ÛŒÙ„ Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù†Ø±Ø® Ø§Ø±Ø².",
                "icons": [
                    {"src": "https://raw.githubusercontent.com/hassantafreshi/tools-collection/master/assets/images/currency-converter/icon-192x192.png", "sizes": "192x192", "type": "image/png"},
                    {"src": "https://raw.githubusercontent.com/hassantafreshi/tools-collection/master/assets/images/currency-converter/icon-512x512.png", "sizes": "512x512", "type": "image/png"}
                ]
            };
            const manifestURL = 'data:application/json;base64,' + btoa(JSON.stringify(manifest));
            document.getElementById('manifest').setAttribute('href', manifestURL);
        },
        registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swContent = `
                    const CACHE_NAME = 'currency-app-cache-v2';
                    const urlsToCache = [
                        '/',
                        'https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap',
                        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css',
                        'https://cdn.jsdelivr.net/npm/chart.js'
                    ];
                    self.addEventListener('install', event => {
                        event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
                    });
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request).then(response => response || fetch(event.request))
                        );
                    });
                `;
                const swBlob = new Blob([swContent], {type: 'application/javascript'});
                const swURL = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swURL)
                    .then(reg => console.log('Service Worker Registered'))
                    .catch(err => console.error('Service Worker Registration Error:', err));
            }
        }
    };

    const ApiCache = {
        async get(key) {
            const itemStr = localStorage.getItem(key);
            if (!itemStr) return null;
            const item = JSON.parse(itemStr);
            if (Date.now() > item.expiry) {
                localStorage.removeItem(key);
                return null;
            }
            return item.value;
        },
        set(key, value) {
            const item = { value: value, expiry: Date.now() + CACHE_DURATION };
            localStorage.setItem(key, JSON.stringify(item));
        }
    };

    // --- Main Functions ---
    async function init() {
        PWA.init();
        loadPreferences();
        addEventListeners();
        showSkeletonLoader();
        await fetchAllCurrencies();
        updateCurrencyUI('from', state.from);
        updateCurrencyUI('to', 'IRR');
        document.querySelectorAll('.card').forEach((card, index) => {
            setTimeout(() => card.classList.add('visible'), index * 100);
        });
        performConversion();
    }

    async function fetchAllCurrencies() {
        if (apiKey.includes('YOUR_API_KEY')) {
            alert('Ù„Ø·ÙØ§ Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ú©Ø¯ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'); return;
        }
        try {
            let data = await ApiCache.get('allCurrencies');
            if (!data) {
                data = await (await fetch(`${apiUrl}/codes`)).json();
                if (data.result === 'success') ApiCache.set('allCurrencies', data);
            }
            if (data.result === 'success') state.allCurrencies = data.supported_codes;
        } catch (error) { console.error('Error fetching currency codes:', error); }
    }

    async function performConversion() {
        const amount = parseFloat(dom.amountInput.value.replace(/,/g, '')) || 0;
        if (amount === 0) {
            ['resultFinal', 'resultRate', 'resultRateReverse', 'lastUpdated'].forEach(el => dom[el].textContent = '');
            dom.multiResultBox.innerHTML = '';
            return;
        }
        toggleButtonLoading(true);
        try {
            let data = await ApiCache.get(`latest_${state.from}`);
            if (!data) {
                data = await (await fetch(`${apiUrl}/latest/${state.from}`)).json();
                if (data.result === 'success') {
                    const previousRates = JSON.parse(localStorage.getItem('previousRates')) || {};
                    previousRates[state.from] = state.latestRates?.conversion_rates;
                    localStorage.setItem('previousRates', JSON.stringify(previousRates));
                    ApiCache.set(`latest_${state.from}`, data);
                }
            }
            
            if (data.result === 'success') {
                state.latestRates = data; 
                const rate = data.conversion_rates[state.to];
                if (!rate) throw new Error(`Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ø¨Ø±Ø§ÛŒ ${state.to} ÛŒØ§ÙØª Ù†Ø´Ø¯.`);
                
                const finalAmount = amount * rate;
                dom.resultFinal.textContent = `${finalAmount.toLocaleString('fa-IR', {maximumFractionDigits: 2})} ${state.to}`;
                dom.resultRate.textContent = `1 ${state.from} = ${rate.toLocaleString('fa-IR', {maximumFractionDigits: 4})} ${state.to}`;
                dom.resultRateReverse.textContent = `1 ${state.to} = ${(1/rate).toLocaleString('fa-IR', {maximumFractionDigits: 8})} ${state.from}`;
                
                updateLastUpdated(data.time_last_update_utc);
                updateMultiConverter(amount);
                updateWatchlist();
                updateHistoryChart(); 
                savePreferences();
            } else {
                dom.resultFinal.textContent = 'Ø®Ø·Ø§'; dom.resultRate.textContent = `(${data['error-type']})`;
            }
        } catch (error) {
            console.error(error);
            dom.resultFinal.textContent = 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡';
            dom.resultRate.textContent = error.message;
        } finally {
            toggleButtonLoading(false);
        }
    }

    // --- UI & Helper Functions ---
    function updateLastUpdated(utcTimestamp) {
        const date = new Date(utcTimestamp);
        const formattedDate = date.toLocaleString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        dom.lastUpdated.textContent = `Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${formattedDate}`;
    }

    function updateMultiConverter(baseAmount) {
        dom.multiResultBox.innerHTML = '';
        if (!state.latestRates) return;
        const popularCurrencies = ['EUR', 'GBP', 'JPY', 'AED', 'TRY'];
        const rates = state.latestRates.conversion_rates;
        let content = '<h4>ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ú†Ù†Ø¯ Ø§Ø±Ø² Ø¯ÛŒÚ¯Ø±</h4>';
        popularCurrencies.forEach(code => {
            if (code === state.from || code === state.to) return;
            if (rates[code]) {
                const convertedAmount = (baseAmount * rates[code]).toLocaleString('fa-IR', { maximumFractionDigits: 2 });
                content += `<div class="multi-result-item"><span>${baseAmount.toLocaleString('fa-IR')} ${state.from}</span><span><i class="fas fa-arrow-right" style="font-size:12px; margin: 0 5px; opacity:0.5;"></i></span><span><b>${convertedAmount} ${code}</b></span></div>`;
            }
        });
        dom.multiResultBox.innerHTML = content;
    }

    function updateWatchlist() {
        dom.watchlistTitle.textContent = `Ù†Ø±Ø®â€ŒÙ‡Ø§ Ù†Ø³Ø¨Øª Ø¨Ù‡ 1 ${state.from}`;
        dom.watchlistContent.innerHTML = '';
        if (!state.favorites.length) {
            dom.watchlistContent.innerHTML = `<div id="watchlist-empty-msg">Ø§Ø±Ø²ÛŒ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø± Ú©Ù†ÛŒØ¯.</div>`;
            return;
        }

        if (!state.latestRates) return;
        const rates = state.latestRates.conversion_rates;
        const previousRates = (JSON.parse(localStorage.getItem('previousRates')) || {})[state.from] || {};

        let content = '';
        state.favorites.forEach(code => {
            if (code === state.from) return;
            if (rates[code]) {
                const currencyName = state.allCurrencies.find(c => c[0] === code)?.[1] || '';
                const prevRate = previousRates[code];
                let trendIcon = '<i class="fas fa-minus"></i>';
                let trendClass = 'trend-stable';
                if (prevRate) {
                    if (rates[code] > prevRate) { trendIcon = '<i class="fas fa-arrow-up"></i>'; trendClass = 'trend-up'; }
                    else if (rates[code] < prevRate) { trendIcon = '<i class="fas fa-arrow-down"></i>'; trendClass = 'trend-down'; }
                }

                content += `
                    <div class="watchlist-item">
                        <span class="trend ${trendClass}">${trendIcon}</span>
                        <span>${code} - ${currencyName}</span>
                        <span class="rate">${rates[code].toLocaleString('en-US', { maximumFractionDigits: 4 })}</span>
                    </div>`;
            }
        });
        dom.watchlistContent.innerHTML = content;
    }

    function showSkeletonLoader() {
        let content = '';
        for (let i = 0; i < 4; i++) {
            content += `
            <div class="watchlist-item">
                <span class="trend skeleton skeleton-text" style="width:20px;"></span>
                <span class="skeleton skeleton-text"></span>
                <span class="rate skeleton skeleton-rate"></span>
            </div>`;
        }
        dom.watchlistContent.innerHTML = content;
    }

    function populateDropdown(dropdown, filter = '') {
        dropdown.innerHTML = '';
        const sortedCurrencies = [...state.allCurrencies].sort((a, b) => {
            const aIsFav = state.favorites.includes(a[0]);
            const bIsFav = state.favorites.includes(b[0]);
            if (aIsFav === bIsFav) return a[0].localeCompare(b[0]);
            return aIsFav ? -1 : 1;
        });
        const filterLower = filter.toLowerCase();
        const filtered = sortedCurrencies.filter(([code, name]) => 
            code.toLowerCase().includes(filterLower) || name.toLowerCase().includes(filterLower) || name.includes(filter)
        );
        filtered.forEach(([code, name]) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'currency-dropdown-item';
            itemDiv.innerHTML = `<span>${code} - ${name}</span><i class="fav-star ${state.favorites.includes(code) ? 'fas favorited' : 'far'} fa-star"></i>`;
            itemDiv.addEventListener('click', () => {
                const type = dropdown.id.includes('from') ? 'from' : 'to';
                updateCurrencyUI(type, code);
                dropdown.classList.remove('show');
                performConversion();
            });
            itemDiv.querySelector('.fav-star').addEventListener('click', (e) => {
                e.stopPropagation(); toggleFavorite(code, e.target);
            });
            dropdown.appendChild(itemDiv);
        });
    }

    function toggleFavorite(code, starElement) {
        const index = state.favorites.indexOf(code);
        if (index > -1) state.favorites.splice(index, 1);
        else state.favorites.push(code);
        starElement.classList.toggle('fas');
        starElement.classList.toggle('far');
        starElement.classList.toggle('favorited');
        savePreferences();
        updateWatchlist();
    }

    function updateCurrencyUI(type, code) {
        state[type] = code;
        const input = (type === 'from') ? dom.fromCurrencyInput : dom.toCurrencyInput;
        const icon = (type === 'from') ? dom.fromIcon : dom.toIcon;
        const currencyName = state.allCurrencies.find(c => c[0] === code)?.[1] || '';
        input.value = `${code} - ${currencyName}`;
        try { icon.textContent = String.fromCodePoint(...[...code.slice(0, 2)].map(c => c.charCodeAt() + 127397)); }
        catch(e) { icon.textContent = 'ğŸ³ï¸'; }
    }

    function updateHistoryChart() {
        dom.chartTitle.textContent = `ØªØ§Ø±ÛŒØ®Ú†Ù‡ Û· Ø±ÙˆØ²Ù‡ ${state.from} Ø¨Ù‡ ${state.to}`;
        dom.chartLoader.classList.add('show');
        if (!state.latestRates || !state.latestRates.conversion_rates[state.to]) {
            if (historyChart) historyChart.destroy();
            dom.chartLoader.classList.remove('show');
            return;
        }
        
        const currentRate = state.latestRates.conversion_rates[state.to];
        const dates = Array.from({length: 7}, (_, i) => {
            const date = new Date();
            date.setDate(date.getDate() - (6 - i));
            return date.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric' });
        });

        let dailyRates = Array.from({length: 8}, () => currentRate * (1 + (Math.random() - 0.5) * 0.06));
        dailyRates[7] = currentRate;

        const backgroundColors = [], borderColors = [];
        const style = getComputedStyle(document.documentElement);
        const success = style.getPropertyValue('--success-color').trim();
        const danger = style.getPropertyValue('--danger-color').trim();
        
        for (let i = 1; i < dailyRates.length; i++) {
            backgroundColors.push(dailyRates[i] > dailyRates[i-1] ? `${success}80` : `${danger}80`);
            borderColors.push(dailyRates[i] > dailyRates[i-1] ? success : danger);
        }
        
        if (historyChart) historyChart.destroy();
        const textColor = style.getPropertyValue('--text-color').trim();
        const borderColor = style.getPropertyValue('--border-color').trim();

        historyChart = new Chart(dom.ctx, {
            type: 'bar',
            data: { labels: dates, datasets: [{
                label: `Ù†Ø±Ø® ${state.to}`, data: dailyRates.slice(1), backgroundColor: backgroundColors,
                borderColor: borderColors, borderWidth: 2, borderRadius: 5,
            }]},
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    y: { ticks: { color: textColor, padding: 10 }, grid: { color: borderColor } }, 
                    x: { ticks: { color: textColor }, grid: { display: false } } 
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'var(--card-bg)', titleColor: 'var(--primary-color)',
                        bodyColor: 'var(--text-color)', borderColor: 'var(--border-color)',
                        borderWidth: 1, padding: 10,
                        callbacks: {
                            label: ctx => `${ctx.dataset.label || ''}: ${ctx.parsed.y.toLocaleString('fa-IR', {maximumFractionDigits: 4})}`
                        }
                    }
                }
            }
        });
        dom.chartLoader.classList.remove('show');
    }

    function toggleButtonLoading(isLoading) {
        dom.convertBtn.classList.toggle('loading', isLoading);
        dom.convertBtn.disabled = isLoading;
        dom.convertBtn.querySelector('.btn-text').textContent = isLoading ? 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...' : 'ØªØ¨Ø¯ÛŒÙ„';
    }
    
    function handleSwap() {
        [state.from, state.to] = [state.to, state.from];
        updateCurrencyUI('from', state.from); updateCurrencyUI('to', state.to);
        performConversion();
    }
    
    function formatAmount(e) {
        let value = e.target.value.replace(/,/g, '');
        if (value.match(/^[0-9]*\.?[0-9]*$/)) {
            let [integer, fraction] = value.split('.');
            integer = integer.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            e.target.value = fraction !== undefined ? `${integer}.${fraction}` : integer;
        } else {
            e.target.value = e.target.value.slice(0, -1);
        }
    }

    function copyResult() {
        if(!dom.resultFinal.textContent) return;
        const textToCopy = dom.resultFinal.textContent.split(' ')[0].replace(/,/g, '');
        navigator.clipboard.writeText(textToCopy);
        dom.copyBtn.classList.add('copied');
        dom.copyBtn.setAttribute('title', 'Ú©Ù¾ÛŒ Ø´Ø¯!');
        setTimeout(() => {
            dom.copyBtn.classList.remove('copied');
            dom.copyBtn.setAttribute('title', 'Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†');
        }, 2000);
    }

    function toggleTheme() {
        const newTheme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
        document.documentElement.dataset.theme = newTheme;
        dom.themeSwitcher.querySelectorAll('i').forEach(i => i.classList.toggle('active'));
        localStorage.setItem('currency_theme', newTheme);
        if(historyChart) updateHistoryChart(); 
    }
    function savePreferences() { localStorage.setItem('currency_prefs', JSON.stringify({from: state.from, to: state.to, favorites: state.favorites})); }
    function loadPreferences() {
        const theme = localStorage.getItem('currency_theme') || 'light';
        document.documentElement.dataset.theme = theme;
        if(theme === 'dark') dom.themeSwitcher.querySelectorAll('i').forEach(i => i.classList.toggle('active'));

        const prefs = JSON.parse(localStorage.getItem('currency_prefs'));
        if (prefs) { 
            state.from = prefs.from || 'USD'; 
            state.to = prefs.to || 'IRR'; 
            state.favorites = prefs.favorites || ['EUR', 'GBP', 'JPY', 'AED']; 
        }
    }

    function addEventListeners() {
        dom.convertBtn.addEventListener('click', performConversion);
        dom.swapBtn.addEventListener('click', handleSwap);
        dom.themeSwitcher.addEventListener('click', toggleTheme);
        dom.amountInput.addEventListener('input', formatAmount);
        dom.copyBtn.addEventListener('click', copyResult);
        ['from', 'to'].forEach(type => {
            const input = document.getElementById(`${type}-currency-input`);
            const dropdown = document.getElementById(`${type}-dropdown`);
            input.addEventListener('focus', () => { 
                input.select(); populateDropdown(dropdown, ''); dropdown.classList.add('show'); 
            });
            input.addEventListener('keyup', () => populateDropdown(dropdown, input.value));
            document.addEventListener('click', (e) => {
                if (!input.parentElement.contains(e.target)) {
                    dropdown.classList.remove('show');
                    const currentCode = state.allCurrencies.find(c => c[0] === input.value.split(' ')[0]);
                    if (input.value.trim() === '' || !currentCode) {
                        updateCurrencyUI(type, state[type]);
                    }
                }
            });
        });
    }

    // --- Start the App ---
    init();

    </script>
</body>
</html>