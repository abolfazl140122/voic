<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ ÿßÿ±ÿ≤€å Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ================== CSS ================== */
        :root {
            --bg-color: #f4f7fc; --card-bg: #ffffff; --text-color: #34495e;
            --primary-color: #3498db; --primary-hover: #2980b9; --border-color: #e2e8f0;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07); --input-bg: #fdfdff;
            --success-color: #2ecc71; --danger-color: #e74c3c; --neutral-color: #95a5a6;
        }
        [data-theme="dark"] {
            --bg-color: #1a202c; --card-bg: #2d3748; --text-color: #e2e8f0;
            --primary-color: #4299e1; --primary-hover: #2b6cb0; --border-color: #4a5568;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.2); --input-bg: #1a202c;
            --success-color: #27ae60; --danger-color: #c0392b; --neutral-color: #7f8c8d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding: 20px; transition: background-color 0.3s, color 0.3s;
        }

        .main-container { width: 100%; max-width: 1200px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: 28px; }
        .theme-switcher {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 50px;
            padding: 5px; cursor: pointer; font-size: 18px; width: 80px; display: flex; justify-content: space-between;
        }
        .theme-switcher i { padding: 5px; border-radius: 50%; }
        .theme-switcher .active { background: var(--primary-color); color: white; }

        .app-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 800px) { .app-grid { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); } }


        .card {
            background: var(--card-bg); padding: 30px; border-radius: 15px; box-shadow: var(--shadow);
            border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s, transform 0.5s, opacity 0.5s;
            opacity: 0; transform: translateY(20px);
            display: flex; flex-direction: column;
        }
        .card.visible { opacity: 1; transform: translateY(0); }
        .card h3 { margin-bottom: 20px; font-size: 20px; }

        .converter .input-group { margin-bottom: 20px; }
        .converter label { font-weight: 500; display: block; margin-bottom: 8px; }
        .currency-input-wrapper { position: relative; }
        .currency-input-wrapper .icon { position: absolute; top: 50%; transform: translateY(-50%); left: 15px; color: #999; font-size: 22px; }
        .currency-input-wrapper input { padding-right: 15px; padding-left: 50px; }
        input {
            width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color); font-family: 'Vazirmatn', sans-serif; font-size: 16px;
        }
        .conversion-flow { display: flex; align-items: center; margin: 25px 0; }
        .conversion-flow .currency-box { flex: 1; }
        .conversion-flow #swap-btn { background: var(--card-bg); border: 2px solid var(--primary-color); color: var(--primary-color); width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 18px; margin: 0 15px; transition: all 0.3s; }
        .conversion-flow #swap-btn:hover { background: var(--primary-color); color: white; transform: rotate(180deg); }
        
        .currency-dropdown {
            display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px;
            overflow-y: auto; background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 8px; z-index: 10; margin-top: 5px;
        }
        .currency-dropdown.show { display: block; }
        .currency-dropdown-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; cursor: pointer; }
        .currency-dropdown-item:hover { background: var(--primary-color); color: white; }
        .currency-dropdown-item .fav-star { color: #ccc; transition: color 0.2s, transform 0.2s; }
        .currency-dropdown-item .fav-star.favorited { color: #f1c40f; transform: scale(1.2); }
        
        #convert-btn { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; transition: background-color 0.3s; position: relative; }
        #convert-btn:hover { background: var(--primary-hover); }
        #convert-btn.loading { background: var(--primary-hover); cursor: not-allowed; }
        .btn-spinner { display: none; width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; position: absolute; top: 50%; left: 20px; transform: translateY(-50%); }
        #convert-btn.loading .btn-spinner { display: block; }
        #convert-btn.loading .btn-text { opacity: 0.5; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .result-box { margin-top: 25px; text-align: center; }
        #result-final-wrapper { display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; color: var(--primary-color); min-height: 35px; }
        #copy-btn { font-size: 16px; margin-right: 10px; cursor: pointer; color: #aaa; transition: color 0.2s; }
        #copy-btn:hover { color: var(--primary-color); }
        #result-rate, #result-rate-reverse { font-size: 14px; color: var(--neutral-color); min-height: 20px; }

        #last-updated { font-size: 12px; color: var(--neutral-color); margin-top: 10px; }
        #multi-result-box { margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        #multi-result-box h4 { font-size: 16px; margin-bottom: 15px; text-align: right; }
        .multi-result-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 15px; }

        .watchlist { flex-grow: 1; }
        .watchlist-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid var(--border-color); font-size: 16px; }
        .watchlist-item:last-child { border-bottom: none; }
        .watchlist-item .rate { font-weight: 700; color: var(--primary-color); direction: ltr; }
        #watchlist-empty-msg { text-align: center; color: var(--neutral-color); padding: 20px 0; margin: auto; }
        
        .chart-card { flex-grow: 1; }
        .chart-container { position: relative; flex-grow: 1; min-height: 300px; }
        .chart-loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--card-bg-trans);
            display: none; justify-content: center; align-items: center; z-index: 5; border-radius: 15px;
        }
        :root { --card-bg-trans: rgba(255, 255, 255, 0.5); }
        [data-theme="dark"] { --card-bg-trans: rgba(45, 55, 72, 0.7); }
        .chart-loader.show { display: flex; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        [data-theme="dark"] ::-webkit-scrollbar-thumb { background: #555; }
    </style>
</head>
<body>

    <main class="main-container">
        <header class="header card">
            <h1>ÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ ÿßÿ±ÿ≤€å Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá</h1>
            <div class="theme-switcher" id="theme-switcher">
                <i class="fas fa-sun active"></i><i class="fas fa-moon"></i>
            </div>
        </header>

        <div class="app-grid">
            <div class="card converter">
                <div class="input-group"><label for="amount">ŸÖÿ®ŸÑÿ∫</label><input type="text" id="amount" value="1,000"></div>
                <div class="conversion-flow">
                    <div class="currency-box input-group">
                        <label for="from-currency-input">ÿßÿ≤</label>
                        <div class="currency-input-wrapper">
                            <span class="icon" id="from-icon"></span>
                            <input type="text" id="from-currency-input" placeholder="ÿ¨ÿ≥ÿ™ÿ¨Ÿà..."><div class="currency-dropdown" id="from-dropdown"></div>
                        </div>
                    </div>
                    <button id="swap-btn" title="ÿ¨ÿßÿ®ÿ¨ÿß€å€å"><i class="fas fa-exchange-alt"></i></button>
                    <div class="currency-box input-group">
                        <label for="to-currency-input">ÿ®Ÿá</label>
                        <div class="currency-input-wrapper">
                            <span class="icon" id="to-icon"></span>
                            <input type="text" id="to-currency-input" placeholder="ÿ¨ÿ≥ÿ™ÿ¨Ÿà..."><div class="currency-dropdown" id="to-dropdown"></div>
                        </div>
                    </div>
                </div>
                <button id="convert-btn"><span class="btn-spinner"></span><span class="btn-text">ÿ™ÿ®ÿØ€åŸÑ</span></button>
                <div class="result-box">
                    <div id="result-final-wrapper">
                        <i id="copy-btn" class="far fa-copy" title="⁄©Ÿæ€å ⁄©ÿ±ÿØŸÜ"></i>
                        <span id="result-final"></span>
                    </div>
                    <div id="result-rate"></div>
                    <div id="result-rate-reverse"></div>
                    <div id="last-updated"></div>
                </div>
                <div id="multi-result-box"></div>
            </div>

            <div class="card watchlist">
                <h3 id="watchlist-title">ŸÑ€åÿ≥ÿ™ Ÿæ€å⁄Ø€åÿ±€å ŸÜÿ±ÿÆ‚ÄåŸáÿß€å ŸÖÿ≠ÿ®Ÿàÿ®</h3>
                <div id="watchlist-content">
                    <!-- Watchlist items will be injected here by JS -->
                </div>
            </div>

            <div class="card chart-card">
                <h3 id="chart-title">ÿ™ÿßÿ±€åÿÆ⁄ÜŸá ŸÜÿ±ÿÆ</h3>
                <div class="chart-container">
                    <div class="chart-loader" id="chart-loader"><div class="btn-spinner" style="display:block; width:50px; height:50px; border-width: 5px; border-top-color: var(--primary-color);"></div></div>
                    <canvas id="history-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
    // ================== JavaScript ==================
    const apiKey = '0ff22125f8e20b66fc0f51ae'; // <-- ⁄©ŸÑ€åÿØ API ÿ¥ŸÖÿß

    // --- ÿØÿ±€åÿßŸÅÿ™ ÿπŸÜÿßÿµÿ± DOM ---
    const amountInput = document.getElementById('amount');
    const fromCurrencyInput = document.getElementById('from-currency-input');
    const toCurrencyInput = document.getElementById('to-currency-input');
    const fromDropdown = document.getElementById('from-dropdown');
    const toDropdown = document.getElementById('to-dropdown');
    const fromIcon = document.getElementById('from-icon');
    const toIcon = document.getElementById('to-icon');
    const convertBtn = document.getElementById('convert-btn');
    const swapBtn = document.getElementById('swap-btn');
    const resultFinal = document.getElementById('result-final');
    const copyBtn = document.getElementById('copy-btn');
    const resultRate = document.getElementById('result-rate');
    const resultRateReverse = document.getElementById('result-rate-reverse');
    const themeSwitcher = document.getElementById('theme-switcher');
    const chartTitle = document.getElementById('chart-title');
    const chartLoader = document.getElementById('chart-loader');
    const ctx = document.getElementById('history-chart').getContext('2d');
    const lastUpdated = document.getElementById('last-updated');
    const multiResultBox = document.getElementById('multi-result-box');
    const watchlistContent = document.getElementById('watchlist-content');
    const watchlistTitle = document.getElementById('watchlist-title');


    // --- Ÿàÿ∂ÿπ€åÿ™ ÿ®ÿ±ŸÜÿßŸÖŸá ---
    const apiUrl = `https://v6.exchangerate-api.com/v6/${apiKey}`;
    let state = {
        from: 'USD', to: 'IRR',
        allCurrencies: [],
        favorites: ['EUR', 'GBP', 'JPY', 'AED'],
        latestRates: null,
    };
    let historyChart;

    // --- ÿ™Ÿàÿßÿ®ÿπ ÿßÿµŸÑ€å ---
    async function init() {
        loadPreferences();
        await fetchAllCurrencies();
        addEventListeners();
        updateCurrencyUI('from', state.from);
        updateCurrencyUI('to', state.to);
        document.querySelectorAll('.card').forEach((card, index) => {
            setTimeout(() => card.classList.add('visible'), index * 100);
        });
        performConversion();
    }

    async function fetchAllCurrencies() {
        if (apiKey.includes('YOUR_API_KEY')) {
            alert('ŸÑÿ∑ŸÅÿß ⁄©ŸÑ€åÿØ API ÿÆŸàÿØ ÿ±ÿß ÿØÿ± ⁄©ÿØ ÿ¨ÿßŸàÿßÿßÿ≥⁄©ÿ±€åŸæÿ™ Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ.'); return;
        }
        try {
            const data = await (await fetch(`${apiUrl}/codes`)).json();
            if (data.result === 'success') state.allCurrencies = data.supported_codes;
        } catch (error) { console.error('Error fetching currency codes:', error); }
    }

    async function performConversion() {
        const amount = parseFloat(amountInput.value.replace(/,/g, '')) || 0;
        if (amount === 0) {
            resultFinal.textContent = ''; resultRate.textContent = ''; resultRateReverse.textContent = '';
            lastUpdated.textContent = ''; multiResultBox.innerHTML = '';
            return;
        }
        toggleButtonLoading(true);
        try {
            const data = await (await fetch(`${apiUrl}/latest/${state.from}`)).json();
            
            if (data.result === 'success') {
                state.latestRates = data; 
                const rate = data.conversion_rates[state.to];
                if (!rate) {
                    throw new Error(`ŸÜÿ±ÿÆ ÿ™ÿ®ÿØ€åŸÑ ÿ®ÿ±ÿß€å ${state.to} €åÿßŸÅÿ™ ŸÜÿ¥ÿØ.`);
                }
                const finalAmount = amount * rate;

                resultFinal.textContent = `${finalAmount.toLocaleString('fa-IR', {maximumFractionDigits: 2})} ${state.to}`;
                resultRate.textContent = `1 ${state.from} = ${rate.toLocaleString('fa-IR', {maximumFractionDigits: 4})} ${state.to}`;
                resultRateReverse.textContent = `1 ${state.to} = ${(1/rate).toLocaleString('fa-IR', {maximumFractionDigits: 8})} ${state.from}`;
                
                updateLastUpdated(data.time_last_update_utc);
                updateMultiConverter(amount);
                updateWatchlist();
                
                savePreferences();
                updateHistoryChart(); 
            } else {
                resultFinal.textContent = 'ÿÆÿ∑ÿß'; resultRate.textContent = `(${data['error-type']})`;
            }
        } catch (error) {
            console.error(error);
            resultFinal.textContent = 'ÿÆÿ∑ÿß€å ÿ¥ÿ®⁄©Ÿá';
            resultRate.textContent = error.message;
        } finally {
            toggleButtonLoading(false);
        }
    }

    // =========================================================================
    //  ATTENTION: The historical chart function has been completely rewritten.
    //  It now SIMULATES data because the free API plan doesn't support it.
    // =========================================================================
    function updateHistoryChart() {
        chartTitle.textContent = `ÿ™ÿßÿ±€åÿÆ⁄ÜŸá €∑ ÿ±Ÿàÿ≤Ÿá ${state.from} ÿ®Ÿá ${state.to}`;
        chartLoader.classList.add('show');

        // Check if we have the latest rates data to base our simulation on.
        if (!state.latestRates || !state.latestRates.conversion_rates[state.to]) {
            console.warn("No rate data available to generate history chart.");
            if (historyChart) historyChart.destroy(); // Clear old chart
            chartLoader.classList.remove('show');
            return;
        }
        
        const currentRate = state.latestRates.conversion_rates[state.to];

        // 1. Generate date labels for the last 7 days.
        const dates = [];
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            dates.push(date.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric' }));
        }

        // 2. Simulate 8 data points for 7 days of history + a base for color comparison.
        let dailyRates = [];
        for (let i = 0; i < 8; i++) {
            // Fluctuate by up to +/- 3% for a more visible effect
            const fluctuation = (Math.random() - 0.5) * 0.06; 
            let simulatedRate = currentRate * (1 + fluctuation);
            dailyRates.push(simulatedRate);
        }
        // Ensure the last data point (today) is the EXACT current rate for consistency.
        dailyRates[7] = currentRate;

        // 3. Calculate bar colors based on simulated changes.
        const backgroundColors = [];
        const borderColors = [];
        const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim();
        const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim();
        const neutralColor = getComputedStyle(document.documentElement).getPropertyValue('--neutral-color').trim();

        for (let i = 1; i < dailyRates.length; i++) { // Start from 1 to compare with previous day
            if (dailyRates[i] > dailyRates[i - 1]) {
                backgroundColors.push(successColor + '80');
                borderColors.push(successColor);
            } else if (dailyRates[i] < dailyRates[i - 1]) {
                backgroundColors.push(dangerColor + '80');
                borderColors.push(dangerColor);
            } else {
                backgroundColors.push(neutralColor + '80');
                borderColors.push(neutralColor);
            }
        }
        
        // 4. Create or update the chart with the simulated data.
        if (historyChart) historyChart.destroy();
        
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();

        historyChart = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: dates, 
                datasets: [{
                    label: `ŸÜÿ±ÿÆ ${state.to}`, 
                    data: dailyRates.slice(1), // Use the last 7 data points for the 7 bars
                    backgroundColor: backgroundColors, 
                    borderColor: borderColors, 
                    borderWidth: 2,
                    borderRadius: 5,
                }]
            },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                scales: { 
                    y: { 
                        ticks: { color: textColor, padding: 10 }, 
                        grid: { color: borderColor } 
                    }, 
                    x: { 
                        ticks: { color: textColor }, 
                        grid: { display: false } 
                    } 
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'var(--card-bg)',
                        titleColor: 'var(--primary-color)',
                        bodyColor: 'var(--text-color)',
                        borderColor: 'var(--border-color)',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toLocaleString('fa-IR', {maximumFractionDigits: 4});
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
        chartLoader.classList.remove('show');
    }

    // --- ÿ™Ÿàÿßÿ®ÿπ ⁄©ŸÖ⁄©€å Ÿà UI ---
    function updateLastUpdated(utcTimestamp) {
        const date = new Date(utcTimestamp);
        const formattedDate = date.toLocaleString('fa-IR', {
            year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });
        lastUpdated.textContent = `ÿ¢ÿÆÿ±€åŸÜ ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å: ${formattedDate}`;
    }

    function updateMultiConverter(baseAmount) {
        multiResultBox.innerHTML = '';
        if (!state.latestRates) return;
        
        const popularCurrencies = ['EUR', 'GBP', 'JPY', 'AED', 'TRY'];
        const rates = state.latestRates.conversion_rates;

        let content = '<h4>ÿ™ÿ®ÿØ€åŸÑ ÿ®Ÿá ⁄ÜŸÜÿØ ÿßÿ±ÿ≤ ÿØ€å⁄Øÿ±</h4>';
        popularCurrencies.forEach(code => {
            if (code === state.from || code === state.to) return;
            
            if (rates[code]) {
                const convertedAmount = (baseAmount * rates[code]).toLocaleString('fa-IR', { maximumFractionDigits: 2 });
                content += `
                    <div class="multi-result-item">
                        <span>${baseAmount.toLocaleString('fa-IR')} ${state.from}</span>
                        <span><i class="fas fa-arrow-right" style="font-size:12px; margin: 0 5px; opacity:0.5;"></i></span>
                        <span><b>${convertedAmount} ${code}</b></span>
                    </div>
                `;
            }
        });
        multiResultBox.innerHTML = content;
    }

    function updateWatchlist() {
        watchlistTitle.textContent = `ŸÜÿ±ÿÆ‚ÄåŸáÿß ŸÜÿ≥ÿ®ÿ™ ÿ®Ÿá 1 ${state.from}`;
        watchlistContent.innerHTML = '';
        if (!state.favorites.length) {
            watchlistContent.innerHTML = `<div id="watchlist-empty-msg">ÿßÿ±ÿ≤€å ÿ±ÿß ÿ®ÿ±ÿß€å Ÿæ€å⁄Ø€åÿ±€å ÿ≥ÿ™ÿßÿ±Ÿá‚ÄåÿØÿßÿ± ⁄©ŸÜ€åÿØ.</div>`;
            return;
        }

        if (!state.latestRates) return;

        let content = '';
        const rates = state.latestRates.conversion_rates;
        
        state.favorites.forEach(code => {
            if (code === state.from) return;
            if (rates[code]) {
                const currencyName = state.allCurrencies.find(c => c[0] === code)?.[1] || '';
                content += `
                    <div class="watchlist-item">
                        <span>${code} - ${currencyName}</span>
                        <span class="rate">${rates[code].toLocaleString('en-US', { maximumFractionDigits: 4 })}</span>
                    </div>
                `;
            }
        });
        watchlistContent.innerHTML = content;
    }

    function populateDropdown(dropdown, filter = '') {
        dropdown.innerHTML = '';
        const sortedCurrencies = [...state.allCurrencies].sort((a, b) => {
            const aIsFav = state.favorites.includes(a[0]);
            const bIsFav = state.favorites.includes(b[0]);
            if (aIsFav === bIsFav) return a[0].localeCompare(b[0]);
            return aIsFav ? -1 : 1;
        });

        const filterLower = filter.toLowerCase();
        const filtered = sortedCurrencies.filter(([code, name]) => 
            code.toLowerCase().includes(filterLower) || name.toLowerCase().includes(filterLower) || name.includes(filter)
        );

        filtered.forEach(([code, name]) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'currency-dropdown-item';
            itemDiv.innerHTML = `<span>${code} - ${name}</span><i class="fav-star ${state.favorites.includes(code) ? 'fas favorited' : 'far'} fa-star"></i>`;
            
            itemDiv.addEventListener('click', () => {
                const type = dropdown.id.includes('from') ? 'from' : 'to';
                updateCurrencyUI(type, code);
                dropdown.classList.remove('show');
                performConversion();
            });
            itemDiv.querySelector('.fav-star').addEventListener('click', (e) => {
                e.stopPropagation(); toggleFavorite(code, e.target);
            });
            dropdown.appendChild(itemDiv);
        });
    }

    function toggleFavorite(code, starElement) {
        const index = state.favorites.indexOf(code);
        if (index > -1) {
            state.favorites.splice(index, 1);
        } else {
            state.favorites.push(code);
        }
        starElement.classList.toggle('fas');
        starElement.classList.toggle('far');
        starElement.classList.toggle('favorited');
        savePreferences();
        updateWatchlist();
    }

    function updateCurrencyUI(type, code) {
        state[type] = code;
        const input = (type === 'from') ? fromCurrencyInput : toCurrencyInput;
        const icon = (type === 'from') ? fromIcon : toIcon;
        const currencyName = state.allCurrencies.find(c => c[0] === code)?.[1] || '';
        input.value = `${code} - ${currencyName}`;
        try { icon.textContent = String.fromCodePoint(...[...code.slice(0, 2)].map(c => c.charCodeAt() + 127397)); }
        catch(e) { icon.textContent = 'üè≥Ô∏è'; }
    }

    function toggleButtonLoading(isLoading) {
        convertBtn.classList.toggle('loading', isLoading);
        convertBtn.disabled = isLoading;
        convertBtn.querySelector('.btn-text').textContent = isLoading ? 'ÿØÿ± ÿ≠ÿßŸÑ ÿØÿ±€åÿßŸÅÿ™...' : 'ÿ™ÿ®ÿØ€åŸÑ';
    }
    
    function handleSwap() {
        [state.from, state.to] = [state.to, state.from];
        updateCurrencyUI('from', state.from); updateCurrencyUI('to', state.to);
        performConversion();
    }
    
    function formatAmount(e) {
        let value = e.target.value.replace(/,/g, '');
        if (value === '') return;
        if (!isNaN(value)) {
            e.target.value = parseFloat(value).toLocaleString('en-US');
        } else {
            e.target.value = e.target.value.slice(0, -1);
        }
    }

    function copyResult() {
        if(!resultFinal.textContent) return;
        const textToCopy = resultFinal.textContent.split(' ')[0];
        navigator.clipboard.writeText(textToCopy.replace(/,/g, ''));
        copyBtn.setAttribute('title', '⁄©Ÿæ€å ÿ¥ÿØ!');
        setTimeout(() => copyBtn.setAttribute('title', '⁄©Ÿæ€å ⁄©ÿ±ÿØŸÜ'), 2000);
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.dataset.theme;
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.dataset.theme = newTheme;
        document.body.dataset.theme = newTheme; 
        themeSwitcher.querySelectorAll('i').forEach(i => i.classList.toggle('active'));
        localStorage.setItem('currency_theme', newTheme);
        if(historyChart) {
            updateHistoryChart(); // Rerun the function to get correct colors
        }
    }
    function savePreferences() { localStorage.setItem('currency_prefs', JSON.stringify({from: state.from, to: state.to, favorites: state.favorites})); }
    function loadPreferences() {
        const theme = localStorage.getItem('currency_theme') || 'light';
        document.documentElement.dataset.theme = theme;
        document.body.dataset.theme = theme;
        if(theme === 'dark') themeSwitcher.querySelectorAll('i').forEach(i => i.classList.toggle('active'));

        const prefs = JSON.parse(localStorage.getItem('currency_prefs'));
        if (prefs) { 
            state.from = prefs.from || 'USD'; 
            state.to = prefs.to || 'IRR'; 
            state.favorites = prefs.favorites || ['EUR', 'GBP', 'JPY', 'AED']; 
        }
    }

    function addEventListeners() {
        convertBtn.addEventListener('click', performConversion);
        swapBtn.addEventListener('click', handleSwap);
        themeSwitcher.addEventListener('click', toggleTheme);
        amountInput.addEventListener('input', formatAmount);
        copyBtn.addEventListener('click', copyResult);
        ['from', 'to'].forEach(type => {
            const input = document.getElementById(`${type}-currency-input`);
            const dropdown = document.getElementById(`${type}-dropdown`);
            input.addEventListener('focus', () => { 
                input.select();
                populateDropdown(dropdown, ''); 
                dropdown.classList.add('show'); 
            });
            input.addEventListener('keyup', () => populateDropdown(dropdown, input.value));
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                    const currentCode = state.allCurrencies.find(c => c[0] === input.value.split(' ')[0]);
                    if (input.value.trim() === '' || !currentCode) {
                        updateCurrencyUI(type, state[type]);
                    }
                }
            });
        });
    }

    init();

    </script>
</body>
</html>
