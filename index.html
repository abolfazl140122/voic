<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ù†ÙˆØ¨ÛŒØªÚ©Ø³</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ================== CSS (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ================== */
        :root {
            --bg-color: #f4f7fc; --card-bg: #ffffff; --text-color: #34495e;
            --primary-color: #3498db; --primary-hover: #2980b9; --border-color: #e2e8f0;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07); --input-bg: #fdfdff;
            --success-color: #2ecc71; --danger-color: #e74c3c; --neutral-color: #95a5a6;
            --success-bg: rgba(46, 204, 113, 0.1); --danger-bg: rgba(231, 76, 60, 0.1);
        }
        [data-theme="dark"] {
            --bg-color: #1a202c; --card-bg: #2d3748; --text-color: #e2e8f0;
            --primary-color: #4299e1; --primary-hover: #2b6cb0; --border-color: #4a5568;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.2); --input-bg: #1a202c;
            --success-color: #27ae60; --danger-color: #c0392b; --neutral-color: #7f8c8d;
            --success-bg: rgba(39, 174, 96, 0.15); --danger-bg: rgba(192, 57, 43, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding: 20px; transition: background-color 0.3s, color 0.3s;
        }

        .main-container { width: 100%; max-width: 1400px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 20px 30px; }
        .header h1 { font-size: 28px; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .theme-switcher {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 50px;
            padding: 5px; cursor: pointer; font-size: 18px; width: 80px; display: flex; justify-content: space-between; transition: all 0.3s;
        }
        .theme-switcher:hover { border-color: var(--primary-color); }
        .theme-switcher i { padding: 5px; border-radius: 50%; }
        .theme-switcher .active { background: var(--primary-color); color: white; }

        .app-grid {
            display: grid; gap: 25px;
            grid-template-columns: 1fr;
            grid-template-areas: "converter" "chart" "watchlist";
        }
        @media (min-width: 1024px) {
            .app-grid {
                grid-template-columns: 1.2fr 1fr;
                grid-template-areas: "converter watchlist" "chart watchlist";
            }
        }

        .converter-card { grid-area: converter; }
        .chart-card { grid-area: chart; }
        .watchlist-card { grid-area: watchlist; }

        .card {
            background: var(--card-bg); padding: 30px; border-radius: 20px; box-shadow: var(--shadow);
            border: 1px solid var(--border-color); transition: all 0.3s;
            opacity: 0; transform: translateY(20px); animation: fadeIn 0.5s forwards;
            display: flex; flex-direction: column;
        }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .header { animation-delay: 0s; }
        .converter-card { animation-delay: 0.1s; }
        .chart-card { animation-delay: 0.2s; }
        .watchlist-card { animation-delay: 0.3s; }

        .card h3 { margin-bottom: 20px; font-size: 20px; color: var(--primary-color); }

        .converter .input-group { margin-bottom: 20px; }
        .converter label { font-weight: 500; display: block; margin-bottom: 8px; }
        .currency-input-wrapper { position: relative; }
        .currency-input-wrapper .icon { position: absolute; top: 50%; transform: translateY(-50%); right: 15px; color: var(--neutral-color); font-size: 22px; }
        input {
            width: 100%; padding: 14px 50px 14px 15px; border-radius: 10px; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color); font-family: 'Vazirmatn', sans-serif; font-size: 16px; transition: all 0.3s;
        }
        input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        
        .conversion-flow { display: flex; align-items: center; margin: 25px 0; }
        .conversion-flow .currency-box { flex: 1; }
        #swap-btn { background: var(--card-bg); border: 2px solid var(--primary-color); color: var(--primary-color); width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 18px; margin: 0 15px; transition: all 0.3s; flex-shrink: 0;}
        #swap-btn:hover { background: var(--primary-color); color: white; transform: rotate(180deg); }
        
        .currency-dropdown {
            display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 220px;
            overflow-y: auto; background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 10px; z-index: 10; margin-top: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .currency-dropdown.show { display: block; }
        .currency-dropdown-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .currency-dropdown-item:hover { background: var(--primary-hover); color: white; }
        .currency-dropdown-item .fav-star { color: #ccc; transition: color 0.2s, transform 0.2s; }
        .currency-dropdown-item .fav-star.favorited { color: #f1c40f; transform: scale(1.2); }
        
        .result-box { margin-top: 25px; text-align: center; }
        #result-final-wrapper { display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 700; color: var(--primary-color); min-height: 40px; }
        #copy-btn { font-size: 16px; margin-right: 12px; cursor: pointer; color: var(--neutral-color); transition: color 0.2s; }
        #copy-btn:hover { color: var(--primary-color); }
        #result-rate, #result-rate-reverse { font-size: 14px; color: var(--neutral-color); min-height: 20px; margin-top: 5px; }

        #last-updated { font-size: 12px; color: var(--neutral-color); margin-top: 15px; text-align: center; }
        
        .watchlist-card { flex-grow: 1; }
        .watchlist-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; border-bottom: 1px solid var(--border-color); font-size: 16px; }
        .watchlist-item:last-child { border-bottom: none; }
        .watchlist-item .currency-info { display: flex; align-items: center; }
        .watchlist-item .currency-info .trend-arrow { width: 20px; text-align: center; margin-left: 8px; }
        .watchlist-item .currency-info .trend-arrow.up { color: var(--success-color); }
        .watchlist-item .currency-info .trend-arrow.down { color: var(--danger-color); }
        .watchlist-item .rate { font-weight: 700; color: var(--text-color); direction: ltr; }
        .watchlist-item .remove-fav-btn { background: none; border: none; color: var(--neutral-color); cursor: pointer; font-size: 16px; transition: color 0.2s; }
        .watchlist-item .remove-fav-btn:hover { color: var(--danger-color); }
        #watchlist-empty-msg { text-align: center; color: var(--neutral-color); padding: 20px 0; margin: auto; }
        .skeleton { background-color: var(--border-color); border-radius: 5px; animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .watchlist-skeleton-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; }
        .watchlist-skeleton-item .left { width: 120px; height: 20px; }
        .watchlist-skeleton-item .right { width: 80px; height: 20px; }

        .chart-card { flex-grow: 1; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; }
        .chart-controls button { background: none; border: 1px solid var(--border-color); color: var(--neutral-color); padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: all 0.3s; margin: 0 2px; }
        .chart-controls button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .chart-container { position: relative; flex-grow: 1; min-height: 300px; margin-top: 20px; }
        .chart-loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--card-bg-trans);
            display: none; justify-content: center; align-items: center; z-index: 5; border-radius: 15px;
        }
        :root { --card-bg-trans: rgba(255, 255, 255, 0.7); }
        [data-theme="dark"] { --card-bg-trans: rgba(45, 55, 72, 0.7); }
        .spinner { display: block; width: 50px; height: 50px; border: 5px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chart-loader.show { display: flex; }
        
        #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            padding: 15px 20px; background-color: var(--card-bg); color: var(--text-color); border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); border-left: 5px solid var(--primary-color);
            display: flex; align-items: center; gap: 10px;
            transform: translateX(-120%); animation: slideIn 0.5s forwards, slideOut 0.5s 4s forwards;
        }
        .toast.error { border-left-color: var(--danger-color); }
        .toast.success { border-left-color: var(--success-color); }
        @keyframes slideIn { to { transform: translateX(0); } }
        @keyframes slideOut { to { transform: translateX(-120%); opacity: 0; } }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        [data-theme="dark"] ::-webkit-scrollbar-thumb { background: #555; }

        /* ================== Announcement CSS (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ================== */
        .announcement-icon {
            font-size: 22px; color: var(--neutral-color); cursor: pointer;
            transition: color 0.3s, transform 0.3s;
        }
        .announcement-icon:hover { color: var(--primary-color); transform: scale(1.1); }
        .announcement-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 2000; display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .announcement-overlay.show { opacity: 1; }
        .announcement-modal {
            background-color: var(--card-bg); border-radius: 20px; max-width: 450px;
            width: 90%; text-align: center; position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            transform: scale(0.8) translateY(20px); opacity: 0;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s;
            overflow: hidden;
        }
        .announcement-overlay.show .announcement-modal { transform: scale(1) translateY(0); opacity: 1; }
        .announcement-image { width: 100%; height: 150px; object-fit: cover; }
        .announcement-content { padding: 10px 30px 30px; }
        .announcement-close-btn {
            position: absolute; top: 10px; left: 10px; background: none; border: none;
            font-size: 28px; color: var(--neutral-color); cursor: pointer;
            width: 40px; height: 40px; line-height: 40px; border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
        }
        .announcement-close-btn:hover { background-color: var(--border-color); color: var(--danger-color); }
        .announcement-modal h2 { font-size: 24px; color: var(--primary-color); margin-bottom: 15px; }
        .announcement-modal p { font-size: 16px; line-height: 1.8; margin-bottom: 25px; white-space: pre-wrap; }
        .announcement-confirm-btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 12px 35px; border-radius: 50px; font-size: 18px; font-family: 'Vazirmatn';
            cursor: pointer; transition: background-color 0.3s, transform 0.2s;
            font-weight: 700;
        }
        .announcement-confirm-btn:hover { background-color: var(--primary-hover); transform: translateY(-2px); }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <main class="main-container">
        <header class="header card">
            <h1>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„</h1>
            <div class="header-controls">
                <i class="fas fa-scroll announcement-icon" id="announcement-icon" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø¹Ù„Ø§Ù…ÛŒÙ‡" style="display: none;"></i>
                <div class="theme-switcher" id="theme-switcher">
                    <i class="fas fa-sun active"></i><i class="fas fa-moon"></i>
                </div>
            </div>
        </header>

        <div class="app-grid">
            <div class="card converter-card">
                <h3>Ù…Ø¨Ø¯Ù„ Ø¢Ù†ÛŒ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„</h3>
                <div class="input-group">
                    <label for="amount">Ù…Ø¨Ù„Øº</label>
                    <input type="text" id="amount" value="1" inputmode="decimal">
                </div>
                <div class="conversion-flow">
                    <div class="currency-box input-group">
                        <label for="from-currency-input">Ø§Ø²</label>
                        <div class="currency-input-wrapper">
                            <span class="icon" id="from-icon"></span>
                            <input type="text" id="from-currency-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
                            <div class="currency-dropdown" id="from-dropdown"></div>
                        </div>
                    </div>
                    <button id="swap-btn" title="Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ø§Ø±Ø²Ù‡Ø§"><i class="fas fa-exchange-alt"></i></button>
                    <div class="currency-box input-group">
                        <label for="to-currency-input">Ø¨Ù‡</label>
                        <div class="currency-input-wrapper">
                            <span class="icon" id="to-icon"></span>
                            <input type="text" id="to-currency-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
                            <div class="currency-dropdown" id="to-dropdown"></div>
                        </div>
                    </div>
                </div>
                
                <div class="result-box">
                    <div id="result-final-wrapper">
                        <i id="copy-btn" class="far fa-copy" title="Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†"></i>
                        <span id="result-final"></span>
                    </div>
                    <div id="result-rate"></div>
                    <div id="result-rate-reverse"></div>
                </div>
                <div id="last-updated"></div>
            </div>

            <div class="card watchlist-card">
                <h3 id="watchlist-title">Ù„ÛŒØ³Øª Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</h3>
                <div id="watchlist-content">
                    <!-- Watchlist items or skeleton loaders will be injected here -->
                </div>
            </div>

            <div class="card chart-card">
                <div class="chart-header">
                    <h3 id="chart-title">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø±Ø®</h3>
                    <div class="chart-controls" id="chart-controls">
                        <button data-range="7" class="active">7 Ø±ÙˆØ²</button>
                        <button data-range="15">15 Ø±ÙˆØ²</button>
                        <button data-range="30">30 Ø±ÙˆØ²</button>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-loader" id="chart-loader"><div class="spinner"></div></div>
                    <canvas id="history-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- ==== Ø³Ø§Ø®ØªØ§Ø± Ù…ÙˆØ¯Ø§Ù„ Ø§Ø¹Ù„Ø§Ù…ÛŒÙ‡ ==== -->
    <div id="announcement-overlay" class="announcement-overlay" style="display: none;">
        <div id="announcement-modal" class="announcement-modal">
            <img id="announcement-image" src="" alt="Ø¨Ù†Ø± Ø§Ø¹Ù„Ø§Ù…ÛŒÙ‡" class="announcement-image">
            <div class="announcement-content">
                <h2 id="announcement-title"></h2>
                <p id="announcement-text"></p>
                <button id="announcement-confirm-btn" class="announcement-confirm-btn"></button>
            </div>
            <button id="announcement-close-btn" class="announcement-close-btn" title="Ø¨Ø³ØªÙ†">&times;</button>
        </div>
    </div>


<script>
// ================== Ø¨Ø®Ø´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø¹Ù„Ø§Ù…ÛŒÙ‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) ==================
const ANNOUNCEMENT_CONFIG = {
    id: "v20240521-nobitex-launch",
    title: "Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†ÙˆØ¨ÛŒØªÚ©Ø³ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!",
    text: "Ø§ÛŒÙ† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ú©Ù†ÙˆÙ† Ø§Ø² API Ø¹Ù…ÙˆÙ…ÛŒ Ù†ÙˆØ¨ÛŒØªÚ©Ø³ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.\nÙ„Ø°Øª Ø¨Ø¨Ø±ÛŒØ¯!",
    buttonText: "Ø¹Ø§Ù„ÛŒÙ‡!",
    imageUrl: "https://images.unsplash.com/photo-1621419799329-094c6f3703c0?q=80&w=1974&auto=format&fit=crop"
};


// ================== JavaScript (Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ¨ÛŒØªÚ©Ø³) ==================
const nobitexApiUrl = 'https://api.nobitex.ir';

// --- Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø§Ø±Ø²Ù‡Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) ---
const currencyNames = {
    IRT: "ØªÙˆÙ…Ø§Ù† Ø§ÛŒØ±Ø§Ù†", BTC: "Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†", ETH: "Ø§ØªØ±ÛŒÙˆÙ…", USDT: "ØªØªØ±",
    LTC: "Ù„Ø§ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†", XRP: "Ø±ÛŒÙ¾Ù„", BCH: "Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ† Ú©Ø´", BNB: "Ø¨Ø§ÛŒÙ†Ù†Ø³ Ú©ÙˆÛŒÙ†",
    EOS: "Ø§ÛŒØ§Ø³", XLM: "Ø§Ø³ØªÙ„Ø§Ø±", TRX: "ØªØ±ÙˆÙ†", ADA: "Ú©Ø§Ø±Ø¯Ø§Ù†Ùˆ", DOT: "Ù¾ÙˆÙ„Ú©Ø§Ø¯Ø§Øª",
    DOGE: "Ø¯ÙˆØ¬â€ŒÚ©ÙˆÛŒÙ†", SHIB: "Ø´ÛŒØ¨Ø§ Ø§ÛŒÙ†Ùˆ", LINK: "Ú†ÛŒÙ†â€ŒÙ„ÛŒÙ†Ú©", UNI: "ÛŒÙˆÙ†ÛŒâ€ŒØ³ÙˆØ§Ù¾"
};

// --- Ø¯Ø±ÛŒØ§ÙØª Ø¹Ù†Ø§ØµØ± DOM ---
const dom = {
    amountInput: document.getElementById('amount'),
    fromCurrencyInput: document.getElementById('from-currency-input'),
    toCurrencyInput: document.getElementById('to-currency-input'),
    fromDropdown: document.getElementById('from-dropdown'),
    toDropdown: document.getElementById('to-dropdown'),
    fromIcon: document.getElementById('from-icon'),
    toIcon: document.getElementById('to-icon'),
    swapBtn: document.getElementById('swap-btn'),
    resultFinal: document.getElementById('result-final'),
    copyBtn: document.getElementById('copy-btn'),
    resultRate: document.getElementById('result-rate'),
    resultRateReverse: document.getElementById('result-rate-reverse'),
    themeSwitcher: document.getElementById('theme-switcher'),
    chartTitle: document.getElementById('chart-title'),
    chartLoader: document.getElementById('chart-loader'),
    chartControls: document.getElementById('chart-controls'),
    ctx: document.getElementById('history-chart').getContext('2d'),
    lastUpdated: document.getElementById('last-updated'),
    watchlistContent: document.getElementById('watchlist-content'),
    watchlistTitle: document.getElementById('watchlist-title'),
    toastContainer: document.getElementById('toast-container'),
    announcement: {
        overlay: document.getElementById('announcement-overlay'),
        modal: document.getElementById('announcement-modal'),
        icon: document.getElementById('announcement-icon'),
        title: document.getElementById('announcement-title'),
        text: document.getElementById('announcement-text'),
        image: document.getElementById('announcement-image'),
        confirmBtn: document.getElementById('announcement-confirm-btn'),
        closeBtn: document.getElementById('announcement-close-btn'),
    }
};

// --- ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡ (State) ---
const state = {
    from: 'BTC',
    to: 'IRT',
    allCurrencies: [],
    favorites: ['USDT', 'ETH', 'DOGE', 'SHIB', 'XRP'],
    latestRates: null, // Ø­Ø§ÙˆÛŒ Ø¢Ø¨Ø¬Ú©Øª Ú©Ø§Ù…Ù„ Ø§Ø² Ù†ÙˆØ¨ÛŒØªÚ©Ø³
    previousRates: null, // Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø±ÙˆÙ†Ø¯
    chartTimeRange: 7,
};
let historyChart;

// --- ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ---
async function init() {
    loadPreferences();
    handleAnnouncement();
    addEventListeners();
    updateCurrencyUI('from', state.from);
    updateCurrencyUI('to', 'IRT');
    await fetchNobitexData();
}

async function fetchNobitexData() {
    renderWatchlistSkeleton();
    dom.chartLoader.classList.add('show');
    dom.lastUpdated.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...';

    try {
        // Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ø²Ù…Ø§Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ø§Ø± Ùˆ Ø¢Ù…Ø§Ø± Û²Û´ Ø³Ø§Ø¹Øª Ú¯Ø°Ø´ØªÙ‡
        const [statsResponse, marketResponse] = await Promise.all([
            fetch(`${nobitexApiUrl}/v2/stats`),
            fetch(`${nobitexApiUrl}/v2/market/stats`)
        ]);

        if (!statsResponse.ok || !marketResponse.ok) {
            throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù†ÙˆØ¨ÛŒØªÚ©Ø³`);
        }
        
        const statsData = await statsResponse.json();
        const marketData = await marketResponse.json();

        if (statsData.status !== 'ok' || marketData.status !== 'ok') {
            throw new Error('Ù¾Ø§Ø³Ø® Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø² Ù†ÙˆØ¨ÛŒØªÚ©Ø³ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
        }

        // Ø°Ø®ÛŒØ±Ù‡ Ù†Ø±Ø®â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø±ÙˆÙ†Ø¯
        if(state.latestRates) {
            state.previousRates = { ...state.latestRates };
        }
        state.latestRates = { ...statsData.stats, ...marketData.stats };
        
        processAvailableCurrencies();
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙ…Ø§Ù… Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡
        updateConverterResult();
        renderWatchlist();
        renderHistoryChart();
        updateLastUpdated();
        savePreferences();

    } catch (error) {
        console.error('Error fetching Nobitex data:', error);
        showToast(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ù†ÙˆØ¨ÛŒØªÚ©Ø³', 'error');
        dom.resultFinal.textContent = '-';
        dom.resultRate.textContent = '';
        dom.resultRateReverse.textContent = '';
        dom.watchlistContent.innerHTML = `<div id="watchlist-empty-msg">${error.message}</div>`;
    } finally {
        dom.chartLoader.classList.remove('show');
    }
}

function processAvailableCurrencies() {
    if (!state.latestRates) return;
    const currencyCodes = new Set(['IRT']);
    Object.keys(state.latestRates).forEach(marketPair => {
        const [src, dst] = marketPair.split('-');
        if(dst === 'IRT') currencyCodes.add(src);
    });

    state.allCurrencies = Array.from(currencyCodes).map(code => {
        return [code, currencyNames[code] || code];
    });
    // Ø¢Ù¾Ø¯ÛŒØª UI Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ØµØ­Øª Ù†Ø§Ù…â€ŒÙ‡Ø§
    updateCurrencyUI('from', state.from);
    updateCurrencyUI('to', state.to);
}

// --- ØªÙˆØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± Ùˆ UI ---
function updateConverterResult() {
    const amount = parseFloat(dom.amountInput.value.replace(/,/g, '')) || 0;
    if (!state.latestRates || amount === 0) {
        dom.resultFinal.textContent = '0';
        dom.resultRate.textContent = '';
        dom.resultRateReverse.textContent = '';
        return;
    }

    const fromRate = getRateInIRT(state.from);
    const toRate = getRateInIRT(state.to);

    if (fromRate === null || toRate === null) {
        dom.resultFinal.textContent = '-';
        showToast(`Ø¨Ø§Ø²Ø§Ø± ØªØ¨Ø¯ÛŒÙ„ ${state.from} Ø¨Ù‡ ${state.to} ÛŒØ§ÙØª Ù†Ø´Ø¯.`, 'error');
        return;
    }

    const finalRate = fromRate / toRate;
    const finalAmount = amount * finalRate;

    dom.resultFinal.textContent = `${finalAmount.toLocaleString('fa-IR', {maximumFractionDigits: state.to === 'IRT' ? 0 : 8})}`;
    dom.resultRate.textContent = `1 ${state.from} = ${finalRate.toLocaleString('fa-IR', {maximumFractionDigits: 8})} ${state.to}`;
    dom.resultRateReverse.textContent = `1 ${state.to} = ${(1/finalRate).toLocaleString('fa-IR', {maximumFractionDigits: 8})} ${state.from}`;
}

function getRateInIRT(currencyCode) {
    if (currencyCode === 'IRT') return 1;
    const market = state.latestRates[`${currencyCode}-IRT`];
    return market ? parseFloat(market.latest) : null;
}

function renderWatchlist() {
    const baseCurrency = 'IRT'; // Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÙˆÙ…Ø§Ù†
    dom.watchlistTitle.textContent = `Ù†Ø±Ø®â€ŒÙ‡Ø§ Ù†Ø³Ø¨Øª Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† (IRT)`;
    dom.watchlistContent.innerHTML = '';

    if (!state.favorites.length) {
        dom.watchlistContent.innerHTML = `<div id="watchlist-empty-msg">Ø§Ø±Ø²ÛŒ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø± Ú©Ù†ÛŒØ¯.</div>`;
        return;
    }

    if (!state.latestRates) return;

    let content = '';
    state.favorites.forEach(code => {
        if(code === baseCurrency) return;
        const market = state.latestRates[`${code}-${baseCurrency}`];
        
        if (market) {
            const rate = parseFloat(market.latest);
            const currencyName = currencyNames[code] || code;
            
            let trendIcon = '';
            const previousMarket = state.previousRates ? state.previousRates[`${code}-${baseCurrency}`] : null;
            if (previousMarket) {
                const prevRate = parseFloat(previousMarket.latest);
                if (rate > prevRate) {
                    trendIcon = `<i class="fas fa-arrow-up trend-arrow up"></i>`;
                } else if (rate < prevRate) {
                    trendIcon = `<i class="fas fa-arrow-down trend-arrow down"></i>`;
                }
            }

            content += `
                <div class="watchlist-item">
                    <div class="currency-info">
                        ${trendIcon}
                        <span><b>${code}</b> - ${currencyName}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                      <span class="rate">${rate.toLocaleString('fa-IR', { maximumFractionDigits: 0 })}</span>
                      <button class="remove-fav-btn" data-code="${code}" title="Ø­Ø°Ù Ø§Ø² Ù„ÛŒØ³Øª Ù¾ÛŒÚ¯ÛŒØ±ÛŒ">&times;</button>
                    </div>
                </div>
            `;
        }
    });
    dom.watchlistContent.innerHTML = content;
}

function renderWatchlistSkeleton() {
    let skeletonHTML = '';
    for (let i = 0; i < 5; i++) {
        skeletonHTML += `
            <div class="watchlist-skeleton-item">
                <div class="skeleton left"></div>
                <div class="skeleton right"></div>
            </div>
        `;
    }
    dom.watchlistContent.innerHTML = skeletonHTML;
}

async function renderHistoryChart() {
    dom.chartLoader.classList.add('show');
    dom.chartTitle.textContent = `ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø±Ø® ${state.from} Ø¨Ù‡ ${state.to}`;

    if (historyChart) historyChart.destroy();
    
    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ø§Ø²Ø§Ø± Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
    let symbol, invert = false;
    if (state.latestRates[`${state.from}-${state.to}`]) {
        symbol = `${state.from}-${state.to}`;
    } else if (state.latestRates[`${state.to}-${state.from}`]) {
        symbol = `${state.to}-${state.from}`;
        invert = true;
    } else {
        dom.chartLoader.classList.remove('show');
        showToast(`Ù†Ù…ÙˆØ¯Ø§Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø± ${state.from}-${state.to} Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.`, 'error');
        return;
    }

    try {
        const to = Math.floor(Date.now() / 1000);
        const from = to - (state.chartTimeRange * 24 * 3600);
        
        const response = await fetch(`${nobitexApiUrl}/v2/ohlc?symbol=${symbol}&resolution=D&from=${from}&to=${to}`);
        const data = await response.json();

        if (data.s !== 'ok') {
            throw new Error(data.errmsg || 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‚ÛŒÙ…Øª');
        }

        const dates = data.t.map(ts => new Date(ts * 1000).toLocaleDateString('fa-IR', { month: 'short', day: 'numeric' }));
        let prices = data.c; // Closing prices
        if(invert) {
            prices = prices.map(p => 1 / p);
        }

        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();

        historyChart = new Chart(dom.ctx, {
            type: 'line',
            data: { 
                labels: dates, 
                datasets: [{
                    label: `Ù†Ø±Ø® ${state.to}`, 
                    data: prices,
                    borderColor: primaryColor,
                    backgroundColor: primaryColor + '33', // Ø´ÙØ§ÙÛŒØª
                    borderWidth: 2.5,
                    pointBackgroundColor: primaryColor,
                    tension: 0.3,
                    fill: true,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    y: { ticks: { color: textColor, padding: 10, callback: value => value.toLocaleString('fa-IR', {maximumFractionDigits: invert ? 8: 2}) }, grid: { color: borderColor } }, 
                    x: { ticks: { color: textColor }, grid: { display: false } } 
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        rtl: true,
                        titleFont: { family: 'Vazirmatn' }, bodyFont: { family: 'Vazirmatn' },
                        backgroundColor: 'var(--card-bg)', titleColor: 'var(--primary-color)',
                        bodyColor: 'var(--text-color)', borderColor: 'var(--border-color)', borderWidth: 1, padding: 10,
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${context.parsed.y.toLocaleString('fa-IR', {maximumFractionDigits: 8})}`
                        }
                    }
                },
                interaction: { mode: 'index', intersect: false },
            }
        });
    } catch (error) {
        console.error('Chart rendering error:', error);
        showToast(error.message, 'error');
    } finally {
        dom.chartLoader.classList.remove('show');
    }
}

function populateDropdown(dropdown, filter = '') {
    dropdown.innerHTML = '';
    const sortedCurrencies = [...state.allCurrencies].sort((a, b) => {
        const aIsFav = state.favorites.includes(a[0]);
        const bIsFav = state.favorites.includes(b[0]);
        if (a[0] === 'IRT') return 1; // IRT always at the bottom
        if (b[0] === 'IRT') return -1;
        if (aIsFav === bIsFav) return a[0].localeCompare(b[0]);
        return aIsFav ? -1 : 1;
    });

    const filterLower = filter.toLowerCase();
    const filtered = sortedCurrencies.filter(([code, name]) => 
        code.toLowerCase().includes(filterLower) || name.toLowerCase().includes(filterLower)
    );

    filtered.forEach(([code, name]) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'currency-dropdown-item';
        itemDiv.innerHTML = `<span><b>${code}</b> - ${name}</span><i class="fav-star ${state.favorites.includes(code) ? 'fas favorited' : 'far'} fa-star"></i>`;
        
        itemDiv.addEventListener('click', () => {
            const type = dropdown.id.includes('from') ? 'from' : 'to';
            updateCurrencyUI(type, code);
            dropdown.classList.remove('show');
            updateConverterResult();
            renderHistoryChart();
        });
        
        const star = itemDiv.querySelector('.fav-star');
        if (code === 'IRT') star.style.display = 'none'; // Don't allow starring IRT
        star.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleFavorite(code, e.target);
        });
        
        dropdown.appendChild(itemDiv);
    });
}

// --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
function toggleFavorite(code, starElement) {
    if (code === 'IRT') return;
    const index = state.favorites.indexOf(code);
    if (index > -1) {
        state.favorites.splice(index, 1);
    } else {
        state.favorites.push(code);
    }
    if (starElement) {
        starElement.classList.toggle('fas', index === -1);
        starElement.classList.toggle('far', index > -1);
        starElement.classList.toggle('favorited', index === -1);
    }
    savePreferences();
    renderWatchlist();
}

function updateCurrencyUI(type, code) {
    state[type] = code;
    const input = (type === 'from') ? dom.fromCurrencyInput : dom.toCurrencyInput;
    const icon = (type === 'from') ? dom.fromIcon : dom.toIcon;
    const currencyName = currencyNames[code] || code;
    input.value = `${code} - ${currencyName}`;
    
    try { 
        icon.textContent = String.fromCodePoint(...[...code.slice(0, 2)].map(c => c.charCodeAt(0) + 127397));
    } catch(e) { 
        icon.textContent = 'ğŸª™'; // Coin icon for crypto
    }
}

function handleSwap() {
    [state.from, state.to] = [state.to, state.from];
    updateCurrencyUI('from', state.from);
    updateCurrencyUI('to', state.to);
    updateConverterResult();
    renderHistoryChart();
}

function formatAmount(e) {
    let value = e.target.value.replace(/,/g, '');
    if (value === '' || isNaN(parseFloat(value))) {
        e.target.value = '';
        return;
    }
    e.target.value = parseFloat(value).toLocaleString('en-US', {maximumFractionDigits: 10});
}

function copyResult() {
    if(!dom.resultFinal.textContent || dom.resultFinal.textContent === '-') return;
    const textToCopy = dom.resultFinal.textContent.replace(/,/g, '');
    navigator.clipboard.writeText(textToCopy)
        .then(() => showToast('Ù…Ø¨Ù„Øº Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯', 'success'))
        .catch(() => showToast('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†', 'error'));
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let iconClass = 'fa-info-circle';
    if (type === 'success') iconClass = 'fa-check-circle';
    if (type === 'error') iconClass = 'fa-exclamation-circle';
    
    toast.innerHTML = `<i class="fas ${iconClass}"></i><span>${message}</span>`;
    dom.toastContainer.appendChild(toast);
    
    setTimeout(() => toast.remove(), 4500);
}

function updateLastUpdated() {
    const date = new Date();
    dom.lastUpdated.textContent = `Ù†Ø±Ø®â€ŒÙ‡Ø§ Ø§Ø² Ù†ÙˆØ¨ÛŒØªÚ©Ø³ - Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${date.toLocaleString('fa-IR', {
        hour: '2-digit', minute: '2-digit', second: '2-digit'
    })}`;
}

// --- Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ… Ùˆ LocalStorage ---
function toggleTheme() {
    const newTheme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
    document.documentElement.dataset.theme = newTheme;
    dom.themeSwitcher.querySelectorAll('i').forEach(i => i.classList.toggle('active'));
    localStorage.setItem('currency_theme', newTheme);
    setTimeout(renderHistoryChart, 50); 
}

function savePreferences() {
    const prefs = {
        from: state.from, to: state.to,
        favorites: state.favorites,
        chartTimeRange: state.chartTimeRange,
    };
    localStorage.setItem('currency_prefs', JSON.stringify(prefs));
}

function loadPreferences() {
    const theme = localStorage.getItem('currency_theme') || 'light';
    if (theme === 'dark') {
        document.documentElement.dataset.theme = 'dark';
        dom.themeSwitcher.querySelectorAll('i').forEach(i => i.classList.toggle('active'));
    }

    const prefs = JSON.parse(localStorage.getItem('currency_prefs'));
    if (prefs) { 
        state.from = prefs.from || 'BTC'; 
        state.to = prefs.to || 'IRT'; 
        state.favorites = prefs.favorites || ['USDT', 'ETH', 'DOGE', 'SHIB', 'XRP'];
        state.chartTimeRange = prefs.chartTimeRange || 7;

        dom.chartControls.querySelector('.active')?.classList.remove('active');
        dom.chartControls.querySelector(`[data-range="${state.chartTimeRange}"]`)?.classList.add('active');
    }
}

// --- ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¹Ù„Ø§Ù…ÛŒÙ‡ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
function showAnnouncement() {
    const { id, title, text, buttonText, imageUrl } = ANNOUNCEMENT_CONFIG;
    if (!text || !id) return;
    dom.announcement.title.textContent = title;
    dom.announcement.text.textContent = text;
    dom.announcement.confirmBtn.textContent = buttonText;
    if (imageUrl) {
        dom.announcement.image.src = imageUrl;
        dom.announcement.image.style.display = 'block';
    } else {
        dom.announcement.image.style.display = 'none';
    }
    dom.announcement.overlay.style.display = 'flex';
    setTimeout(() => dom.announcement.overlay.classList.add('show'), 10);
}
function hideAnnouncement() {
    dom.announcement.overlay.classList.remove('show');
    setTimeout(() => dom.announcement.overlay.style.display = 'none', 400);
}
function handleAnnouncement() {
    const { id, text } = ANNOUNCEMENT_CONFIG;
    if (!text.trim() || !id) {
        dom.announcement.icon.style.display = 'none';
        return;
    }
    dom.announcement.icon.style.display = 'block';
    const seenId = localStorage.getItem('seen_announcement_id');
    if (seenId !== id) showAnnouncement();
}
function markAnnouncementAsSeen() {
    localStorage.setItem('seen_announcement_id', ANNOUNCEMENT_CONFIG.id);
    hideAnnouncement();
}

// --- Ø«Ø¨Øª Event Listeners ---
function addEventListeners() {
    dom.swapBtn.addEventListener('click', handleSwap);
    dom.themeSwitcher.addEventListener('click', toggleTheme);
    dom.copyBtn.addEventListener('click', copyResult);
    
    dom.amountInput.addEventListener('input', (e) => {
        formatAmount(e);
        updateConverterResult();
    });

    ['from', 'to'].forEach(type => {
        const input = dom[`${type}CurrencyInput`];
        const dropdown = dom[`${type}Dropdown`];
        input.addEventListener('focus', () => { 
            input.select();
            populateDropdown(dropdown, ''); 
            dropdown.classList.add('show'); 
        });
        input.addEventListener('keyup', () => populateDropdown(dropdown, input.value));
        document.addEventListener('click', (e) => {
            if (!input.parentElement.contains(e.target)) {
                dropdown.classList.remove('show');
                updateCurrencyUI(type, state[type]);
            }
        });
    });

    dom.chartControls.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            dom.chartControls.querySelector('.active').classList.remove('active');
            e.target.classList.add('active');
            state.chartTimeRange = parseInt(e.target.dataset.range);
            savePreferences();
            renderHistoryChart();
        }
    });

    dom.watchlistContent.addEventListener('click', (e) => {
        if (e.target.matches('.remove-fav-btn')) {
            const codeToRemove = e.target.dataset.code;
            toggleFavorite(codeToRemove, null);
        }
    });

    dom.announcement.icon.addEventListener('click', showAnnouncement);
    dom.announcement.closeBtn.addEventListener('click', markAnnouncementAsSeen);
    dom.announcement.confirmBtn.addEventListener('click', markAnnouncementAsSeen);
    dom.announcement.overlay.addEventListener('click', (e) => {
        if (e.target === dom.announcement.overlay) markAnnouncementAsSeen();
    });
}

// --- Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
