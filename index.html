<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø§Ø²ÛŒ Ù…Ø§ÙÛŒØ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS styles are unchanged, they can be copied from the previous response */
        body {
            font-family: 'Vazirmatn', sans-serif;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .mafia-animated-bg {
            background: linear-gradient(280deg, #0a0a0a, #181818, #101010, #202020, #0a0a0a);
            background-size: 400% 400%;
            animation: gradientAnimation 30s ease infinite;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .panel {
            background-color: rgba(30, 30, 30, 0.95);
            border: 1px solid #c49730;
            box-shadow: 0 0 20px rgba(200, 150, 50, 0.5);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        .panel-hidden {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
            pointer-events: none;
            visibility: hidden; /* Ensure it's not interactive when hidden */
        }

        .panel-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
        }

        .btn-mafia {
            background-color: #c49730;
            color: #1a1a1a;
            border: 2px solid #a57c1a;
            padding: 8px 16px; /* Base padding */
            font-size: 0.9rem; /* Base font size */
            border-radius: 8px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            white-space: nowrap; /* Prevent text wrapping inside buttons */
            display: inline-flex; /* For aligning icon and text if any */
            align-items: center;
            justify-content: center;
        }
        @media (min-width: 640px) {
            .btn-mafia {
                padding: 10px 20px;
                font-size: 1rem;
            }
        }

        .btn-mafia:hover {
            background-color: #d4a840;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }
         .btn-mafia:disabled {
            background-color: #7e6a3b;
            color: #524425;
            border-color: #6a531f;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }


        .btn-mafia-secondary {
            background-color: #4a4a4a;
            color: #e0e0e0;
            border: 2px solid #333333;
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 8px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
         @media (min-width: 640px) {
            .btn-mafia-secondary {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }
        .btn-mafia-secondary:hover {
            background-color: #5a5a5a;
            color: #c49730;
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .input-mafia {
            background-color: #333;
            border: 1px solid #c49730;
            color: #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            font-size: 1rem;
        }
        @media (max-width: 639px) {
            .input-mafia {
                font-size: 0.9rem;
                padding: 8px;
            }
        }

        .input-mafia:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(200, 150, 50, 0.7);
        }
        .input-mafia.invalid {
            border-color: #dc3545;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.7);
        }
        .input-mafia:read-only {
            background-color: #444;
            cursor: default;
        }


        .option-btn {
            background-color: rgba(50, 50, 50, 0.8);
            border: 1px solid #c49730;
            color: #e0e0e0;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 0.9rem;
            padding: 10px;
        }
        @media (min-width: 768px) {
            .option-btn {
                font-size: 1rem;
                padding: 12px;
            }
        }

        .option-btn:hover {
            background-color: rgba(70, 70, 70, 0.9);
            transform: scale(1.02);
        }
        .option-btn.correct { background-color: #28a745 !important; border-color: #1e7e34 !important; color: white !important; }
        .option-btn.incorrect { background-color: #dc3545 !important; border-color: #b02a37 !important; color: white !important; }
        .option-btn:disabled { opacity: 0.7; cursor: not-allowed; }

        .loader {
            border: 8px solid #444;
            border-top: 8px solid #c49730;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @media (min-width: 640px) {
            .loader {
                width: 60px;
                height: 60px;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #c49730; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a57c1a; }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            padding: 10px; /* Base padding */
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.7s ease-in-out, visibility 0.7s;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }
        @media (min-width: 640px) { /* sm */
            .screen {
                padding: 20px; /* Increased padding for larger screens */
            }
        }

        #main-screen {
            justify-content: flex-start;
        }
        #loading-screen {
             justify-content: center;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
            position: relative;
            z-index: 1;
            overflow-y: auto;
        }
        .screen-content-wrapper {
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding-bottom: 10px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        @media (min-width: 640px) {
            .screen-content-wrapper {
                 padding-bottom: 20px;
            }
        }
        #main-screen .screen-content-wrapper {
            justify-content: space-between;
            min-height: calc(100vh - 20px); /* Base min-height */
            padding-top: 60px; /* Initial padding for mobile to avoid user profile */
        }
        @media (min-width: 640px) { /* sm */
            #main-screen .screen-content-wrapper {
                min-height: calc(100vh - 40px); /* Adjusted min-height for sm screens */
                padding-top: 80px; /* Increased padding for sm screens */
            }
        }
         @media (min-width: 768px) { /* md, user profile moves to top-right */
            #main-screen .screen-content-wrapper {
                padding-top: 20px; /* Reset padding-top as user profile is no longer in the way */
            }
        }

        /* User Profile Area Styling */
        #user-profile-area {
            position: fixed;
            z-index: 100;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @media (max-width: 767px) { /* Mobile: Centered at top */
            #user-profile-area {
                top: 10px;
                left: 50%;
                transform: translateX(-50%) translateY(0);
            }
            #user-profile-area.profile-area-hidden {
                opacity: 0;
                transform: translateX(-50%) translateY(-150%);
            }
        }
        @media (min-width: 768px) { /* Desktop: Top right */
            #user-profile-area {
                top: 20px;
                right: 20px; /* Changed from left: auto to ensure it's on the right */
                left: auto;
                transform: translateY(0);
                align-items: center;
            }
            #user-profile-area.profile-area-hidden {
                opacity: 0;
                transform: translateY(-150%);
            }
        }

        #user-info-box {
            background-color: rgba(15, 15, 15, 0.85);
            border: 1px solid #c49730;
            border-radius: 10px;
            padding: 8px 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            width: max-content;
            min-width: 0;
        }
        @media (min-width: 768px) {
            #user-info-box {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                border-width: 2px;
                border-radius: 12px;
                padding: 12px 15px;
                min-width: 180px;
                max-width: 200px;
                width: auto;
            }
        }


        #user-info-box.hidden, #avatar-container.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }
        @media (max-width: 767px) {
            #user-info-box.hidden {
                transform: translateX(-50%) translateY(-20px);
            }
        }

        .user-info-item {
            background-color: rgba(40, 40, 40, 0.7);
            padding: 4px 7px;
            border-radius: 6px;
            border-left: 0px solid #c49730;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        @media (min-width: 768px) {
            .user-info-item {
                padding: 6px 10px;
                border-radius: 8px;
                border-left-width: 3px;
                display: block;
            }
        }

        .user-info-item .label {
            font-size: 0.7em;
            color: #a0a0a0;
            margin-bottom: 0;
        }
        @media (min-width: 768px) {
            .user-info-item .label {
                font-size: 0.85em;
                margin-bottom: 1px;
            }
        }

        .user-info-item .value {
            font-size: 0.85em;
            font-weight: bold;
        }
        @media (min-width: 768px) {
            .user-info-item .value {
                font-size: 1em;
            }
        }

        #display-name-output-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        @media (max-width: 767px) {
             #display-name-output-container {
                flex-direction: row-reverse;
            }
        }

        #edit-name-btn {
            cursor: pointer;
            font-size: 0.85em;
            color: #c49730;
            transition: color 0.3s ease;
        }
        #edit-name-btn:hover {
            color: #d4a840;
        }
        @media (min-width: 768px) {
            #edit-name-btn {
                font-size: 0.95em;
            }
        }

        #display-name-output-box .value {
            color: #e0e0e0;
            text-shadow: 0 0 5px rgba(200, 150, 50, 0.5);
        }
        @media (min-width: 768px) {
            #display-name-output-box .value {
                text-shadow: 0 0 7px rgba(200, 150, 50, 0.6);
            }
        }
        #public-user-id-output-box .value {
            color: #a0a0a0;
            font-family: monospace;
            font-size: 0.95em;
        }
        @media (min-width: 768px) {
            #public-user-id-output-box .value {
                font-size: 1em;
            }
        }
        #clan-output-box .value {
            color: #c49730;
            font-weight: bold;
        }


        #avatar-container {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #c49730;
            background-color: #333;
            cursor: pointer;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        @media (min-width: 768px) {
            #avatar-container {
                width: 70px;
                height: 70px;
                margin-right: 10px;
            }
        }

        #avatar-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #avatar-placeholder-icon {
            font-size: 1.8rem;
            color: #777;
        }
        @media (min-width: 768px) {
            #avatar-placeholder-icon {
                font-size: 2.2rem;
            }
        }

        #avatar-suggestions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .avatar-suggestion-item {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            overflow: hidden;
            transition: border-color 0.3s ease, transform 0.2s ease;
        }
        .avatar-suggestion-item:hover {
            border-color: #c49730;
            transform: scale(1.05);
        }
        .avatar-suggestion-item.selected {
            border-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.7);
        }

        /* Main Screen Header Styling */
        #main-screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding-top: 0.5rem; /* Reduced top padding for header itself */
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
         @media (min-width: 768px) { /* md */
             #main-screen-header {
                padding-top: 1rem; /* Adjust for desktop if needed */
             }
        }


        #main-title {
            text-align: center;
            flex-grow: 1;
            font-size: 2.25rem; /* text-4xl */
            font-weight: bold;
            color: #c49730;
            text-shadow: 0 2px 2px rgba(0,0,0,0.8);
            margin-right: auto; /* Pushes title towards center if icon is on left */
            margin-left: auto; /* Pushes title towards center if icon is on right */
        }
        @media (min-width: 640px) { /* sm */
            #main-title {
                font-size: 3rem; /* text-5xl */
            }
        }
        @media (min-width: 768px) { /* md */
            #main-title {
                font-size: 3.75rem; /* text-6xl */
            }
        }

        /* Developer Intro Icon Button - Header Position */
        #dev-intro-icon-btn-header {
            background-color: transparent;
            color: #c49730;
            border: 2px solid #c49730;
            padding: 0.5rem;
            border-radius: 50%;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            flex-shrink: 0; /* Prevent shrinking */
        }
        #dev-intro-icon-btn-header:hover {
            background-color: rgba(196, 151, 48, 0.2);
            color: #d4a840;
            border-color: #d4a840;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
        }
        #dev-intro-icon-btn-header svg {
            width: 20px;
            height: 20px;
        }
         @media (min-width: 640px) {
            #dev-intro-icon-btn-header {
                width: 44px;
                height: 44px;
                padding: 0.6rem;
            }
            #dev-intro-icon-btn-header svg {
                width: 22px;
                height: 22px;
            }
        }

        /* Bottom Action Buttons Layout */
        #main-screen-buttons-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: auto;
            padding-top: 1rem;
        }

        #top-action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding-bottom: 5px;
        }
        @media (min-width: 640px) {
            #top-action-buttons {
                gap: 0.75rem;
                flex-wrap: nowrap;
                overflow-x: auto;
            }
        }
        @media (min-width: 768px) {
            #top-action-buttons {
                gap: 1rem;
            }
        }

        #top-action-buttons .btn-mafia:not(#start-game-btn) {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        @media (min-width: 640px) {
            #top-action-buttons .btn-mafia:not(#start-game-btn) {
                font-size: 0.85rem;
                padding: 0.5rem 1rem;
            }
        }
        @media (min-width: 768px) {
            #top-action-buttons .btn-mafia:not(#start-game-btn) {
                font-size: 0.9rem;
                padding: 0.6rem 1.2rem;
            }
        }

        #start-game-btn {
             padding: 0.6rem 1.2rem !important;
             font-size: 0.95rem !important;
             order: 0;
        }
        @media (min-width: 640px) {
            #start-game-btn {
                padding: 0.7rem 1.5rem !important;
                font-size: 1.05rem !important;
            }
        }
        @media (min-width: 768px) {
            #start-game-btn {
                padding: 0.8rem 1.8rem !important;
                font-size: 1.15rem !important;
            }
        }


        #input-error-message, #user-id-error-message, #change-name-error-message, #create-clan-error-message, #chat-message-error {
            color: #dc3545;
            font-size: 0.8rem;
            text-align: right;
            min-height: 1.2rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
        }
        @media (min-width: 640px) {
            #input-error-message, #user-id-error-message, #change-name-error-message, #create-clan-error-message, #chat-message-error {
                font-size: 0.875rem;
            }
        }
        .hidden {
            display: none !important;
        }

        /* Styles for Generic Panels */
        .generic-panel-container {
            background-color: rgba(10, 10, 10, 0.92);
        }
        .generic-panel {
            background: radial-gradient(circle at top center, rgba(45, 45, 55, 0.98), rgba(15, 15, 20, 0.99));
            border: 2px solid #c49730;
            box-shadow: 0 0 35px rgba(200, 150, 50, 0.65), 0 0 10px rgba(200, 150, 50, 0.4) inset;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 15px;
        }
        .close-generic-panel-btn {
            position: absolute;
            top: 18px;
            right: 18px;
            width: 34px;
            height: 34px;
            background-color: rgba(196, 151, 48, 0.85);
            color: #101010;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 3px 7px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .close-generic-panel-btn:hover {
            background-color: #d4a840;
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }
        .panel-content-list {
             space-y-4 text-right max-h-[calc(85vh-120px)] sm:max-h-[calc(85vh-150px)] overflow-y-auto pr-2 sm:pr-3 pl-1
        }

        .list-item {
            background-color: rgba(28, 28, 35, 0.92);
            padding: 1.2rem 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(196, 151, 48, 0.25);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.55);
            transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-align: right;
            margin-bottom: 1rem;
        }
        .list-item:last-child {
            margin-bottom: 0;
        }
        .list-item:hover {
            transform: translateY(-5px) scale(1.015);
            box-shadow: 0 10px 28px rgba(196, 151, 48, 0.45);
            border-color: rgba(196, 151, 48, 0.6);
        }
        .list-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.6rem;
            border-bottom: 1px solid rgba(196, 151, 48, 0.2);
            padding-bottom: 0.6rem;
        }
        .list-item-icon {
            font-size: 1.7em;
            color: #c49730;
            margin-left: 10px;
            width: 28px;
            text-align: center;
            line-height: 1;
        }
        .list-item-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: #e8e8e8;
        }
        .list-item-main-text {
            color: #efbe5a;
            font-family: 'Vazirmatn', 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1.25rem;
            display: block;
            margin-bottom: 0.5rem;
            margin-top: 0.2rem;
        }
        .list-item-description {
            font-size: 0.9rem;
            color: #b8b8b8;
            line-height: 1.65;
        }

        /* Leaderboard Specific Styles */
        #leaderboard-list .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.2rem;
        }
        .leaderboard-rank {
            font-size: 1.5rem;
            font-weight: bold;
            color: #c49730;
            width: 40px;
            text-align: center;
            flex-shrink: 0;
        }
        .leaderboard-player-info {
            flex-grow: 1;
            text-align: right;
            margin-right: 1rem;
        }
        .leaderboard-player-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e0e0e0;
        }
        .leaderboard-player-id {
            font-size: 0.8rem;
            color: #a0a0a0;
            font-family: monospace;
        }
        .leaderboard-stage {
            font-size: 1.2rem;
            font-weight: bold;
            color: #efbe5a;
            background-color: rgba(0,0,0,0.2);
            padding: 5px 10px;
            border-radius: 6px;
        }

        /* Clan Specific Styles */
        #clans-panel .list-item {
             display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .clan-info {
            flex-grow: 1;
        }
        .clan-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #efbe5a;
        }
        .clan-members {
            font-size: 0.9rem;
            color: #b8b8b8;
        }
        #create-clan-section {
            border: 1px dashed #c49730;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- HTML Body is unchanged, it can be copied from the previous response -->
    <div class="mafia-animated-bg"></div>

    <div id="user-profile-area" class="hidden">
        <div id="avatar-container" title="ØªØºÛŒÛŒØ± Ø¢ÙˆØ§ØªØ§Ø±">
            <img id="avatar-image" src="https://placehold.co/80x80/333333/777777?text=?" alt="Ø¢ÙˆØ§ØªØ§Ø± Ú©Ø§Ø±Ø¨Ø±" onerror="this.src='https://placehold.co/80x80/333333/777777?text=?'">
        </div>
        <div id="user-info-box" class="hidden">
            <div id="display-name-output-box" class="user-info-item">
                <div class="label">Ø¨Ø§Ø²ÛŒÚ©Ù†:</div>
                <div id="display-name-output-container">
                    <span id="edit-name-btn" title="ØªØºÛŒÛŒØ± Ù†Ø§Ù…">âœï¸</span>
                    <div id="display-name-output" class="value"></div>
                </div>
            </div>
            <div id="public-user-id-output-box" class="user-info-item">
                <div class="label">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ:</div>
                <div id="public-user-id-output" class="value"></div>
            </div>
            <div id="clan-output-box" class="user-info-item hidden">
                <div class="label">Ù‚Ø¨ÛŒÙ„Ù‡:</div>
                <div id="clan-output" class="value"></div>
            </div>
        </div>
    </div>

    <div id="loading-screen" class="screen active flex flex-col items-center justify-center text-center">
        <div class="screen-content-wrapper justify-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-6 text-[#c49730]">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø§Ø²ÛŒ Ù…Ø§ÙÛŒØ§...</h1>
            <div class="loader mb-4"></div>
            <p id="loading-message" class="text-lg sm:text-xl">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„...</p>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <div class="screen-content-wrapper"> <!-- Increased padding-top here -->
            <div>
                <div id="main-screen-header">
                    <!-- Developer Intro Icon Button - Moved to the left (visual right in RTL) -->
                    <button id="dev-intro-icon-btn-header" title="Ù…Ø¹Ø±ÙÛŒ ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ú¯Ø§Ù†">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M17 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </button>
                    <h1 id="main-title">Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h1>
                     <!-- Spacer on the right (visual left in RTL) to balance the icon button -->
                    <div style="width: 40px; flex-shrink: 0;"></div>
                </div>

                <div id="registration-form" class="mb-4 panel panel-visible p-4 sm:p-6 rounded-lg max-w-md mx-auto">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-3 sm:mb-4 text-center text-[#c49730]">Ø«Ø¨Øª Ù†Ø§Ù… / ÙˆØ±ÙˆØ¯</h2>
                    <input type="text" id="display-name-input" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" class="input-mafia w-full mb-1 p-2 sm:p-3 text-base sm:text-lg" maxlength="20">
                    <p id="input-error-message" class=""></p>

                    <div class="mt-3 mb-2">
                        <label for="user-id-display" class="block text-sm font-medium text-gray-300 mb-1">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (5 Ø±Ù‚Ù…ÛŒ):</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="user-id-display" class="input-mafia w-full p-2 sm:p-3 text-base sm:text-lg text-center" readonly placeholder="Ø§Ø¨ØªØ¯Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯">
                            <button id="generate-user-id-btn" class="btn-mafia-secondary whitespace-nowrap px-3 py-2 sm:px-4 sm:py-3 text-xs sm:text-sm">Ø³Ø§Ø®Øª Ø´Ù†Ø§Ø³Ù‡</button>
                        </div>
                        <p id="user-id-error-message" class=""></p>
                    </div>

                    <button id="register-btn" class="btn-mafia w-full p-2 sm:p-3 text-base sm:text-lg mt-3">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø´Ù‡Ø±</button>
                </div>
            </div>

            <div id="main-screen-buttons-layout" class="pb-2 sm:pb-4 hidden">
                <div id="top-action-buttons" class="">
                    <button id="start-game-btn" class="btn-mafia">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
                    <button id="leaderboard-btn" class="btn-mafia" style="order: 2;">Ø¬Ø¯ÙˆÙ„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª ğŸ†</button>
                    <button id="clans-btn" class="btn-mafia" style="order: 3;">Ù‚Ø¨ÛŒÙ„Ù‡ ğŸ›¡ï¸</button>
                    <button id="mafia-fact-btn" class="btn-mafia" style="order: 1;">Ø¯Ø§Ù†Ø³ØªÙ†ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø§ÙÛŒØ§ âœ¨</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content-wrapper justify-start"> <!-- Default padding-top for game screen -->
            <div class="flex justify-between items-center mb-4 sm:mb-6 p-2 sm:p-3 bg-[rgba(0,0,0,0.3)] rounded-lg text-sm sm:text-base md:text-xl">
                <button id="back-to-main-btn" class="btn-mafia-secondary">Ø¨Ø§Ø²Ú¯Ø´Øª âŸµ</button>
                <div>Ù…Ø±Ø­Ù„Ù‡: <span id="stage-display" class="font-bold text-[#c49730]">1</span></div>
            </div>

            <div id="question-container" class="panel panel-visible p-4 sm:p-6 rounded-lg mb-4 sm:mb-6 min-h-[150px] sm:min-h-[200px] flex flex-col justify-center">
                <p id="question-text" class="text-xl md:text-2xl mb-6 text-center leading-relaxed">Ø³ÙˆØ§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4"></div>
                <p id="question-explanation" class="text-xs sm:text-sm mt-3 sm:mt-4 text-gray-400 text-center hidden"></p>
            </div>

            <div id="game-feedback" class="text-center text-base sm:text-lg font-semibold my-3 sm:my-4 h-8"></div>
            
            <div id="ai-thinking-indicator" class="text-center mt-3 sm:mt-4 hidden">
                <div class="loader inline-block"></div>
                <p class="text-sm sm:text-base">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù† Ø§Ø³Øª...</p>
            </div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-3 sm:p-4 panel-hidden z-50">
        <div class="panel panel-visible p-6 sm:p-8 rounded-lg max-w-md md:max-w-lg w-full text-center">
            <h3 id="modal-title" class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-[#c49730]">ØªÙˆØ¬Ù‡</h3>
            <div id="modal-content-dynamic">
                <p id="modal-message" class="mb-2 sm:mb-3 text-sm sm:text-base"></p>
                <div id="change-name-input-container" class="hidden mb-2">
                    <input type="text" id="new-display-name-input" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¬Ø¯ÛŒØ¯ (ÙÙ‚Ø· Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" class="input-mafia w-full mb-1 p-2 sm:p-3 text-base sm:text-lg" maxlength="20">
                    <p id="change-name-error-message" class=""></p>
                </div>
                <div id="avatar-generation-container" class="hidden">
                    <button id="generate-avatar-btn" class="btn-mafia my-4">Ø³Ø§Ø®Øª Ø¢ÙˆØ§ØªØ§Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ AI</button>
                    <div id="avatar-ai-loading" class="my-4 hidden">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-sm text-gray-400">Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ø¢ÙˆØ§ØªØ§Ø±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ... (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ù…ÛŒ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯)</p>
                    </div>
                    <div id="avatar-suggestions-container">
                        </div>
                    <p id="avatar-error-message" class="text-red-400 text-sm mt-2"></p>
                </div>
            </div>
            <div id="modal-actions" class="flex justify-center gap-3 sm:gap-4 mt-4">
                <button id="modal-confirm-btn" class="btn-mafia">ØªØ§ÛŒÛŒØ¯</button>
                <button id="modal-cancel-btn" class="btn-mafia-secondary">Ù„ØºÙˆ</button>
            </div>
        </div>
    </div>

    <!-- Developers Panel -->
    <div id="developers-panel-container" class="fixed inset-0 flex items-center justify-center p-3 sm:p-4 panel-hidden z-[51] generic-panel-container">
        <div id="developers-panel" class="generic-panel p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative transform transition-all duration-500 ease-out">
            <button id="close-developers-panel-btn" class="close-generic-panel-btn">Ã—</button>
            <h3 class="text-2xl sm:text-3xl font-bold mb-6 sm:mb-8 text-center text-[#c49730] drop-shadow-[0_1px_1px_rgba(0,0,0,0.7)]">Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù† Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§</h3>
            <div id="developers-list" class="space-y-4 text-right max-h-[calc(85vh-120px)] sm:max-h-[calc(85vh-150px)] overflow-y-auto pr-2 sm:pr-3 pl-1">
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-icon">ğŸ’»</span>
                        <h4 class="list-item-title">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³ Ø§Ø±Ø´Ø¯</h4>
                    </div>
                    <p class="list-item-main-text">abolfazl1401</p>
                    <p class="list-item-description">Ù…Ø¹Ù…Ø§Ø± Ùˆ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø§ØµÙ„ÛŒ Ú¯ÛŒÙ…â€ŒÙ¾Ù„ÛŒØŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ Ø´Ù‡Ø± Ù…Ø§ÙÛŒØ§.</p>
                </div>
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-icon">ğŸ¨</span>
                        <h4 class="list-item-title">Ø·Ø±Ø§Ø­ Ú¯Ø±Ø§ÙÛŒÚ©</h4>
                    </div>
                    <p class="list-item-main-text">Vahid</p>
                    <p class="list-item-description">Ø·Ø±Ø§Ø­ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ (UI) Ùˆ ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ (UX). Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ø®Ù„Ù‚ Ù‡ÙˆÛŒØª Ø¨ØµØ±ÛŒ Ø¬Ø°Ø§Ø¨ Ùˆ ØªÙ… Ù…Ø§ÙÛŒØ§ÛŒÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø± Ø¹Ù‡Ø¯Ù‡ Ø§Ùˆ Ø¨ÙˆØ¯Ù‡ Ø§Ø³Øª.</p>
                </div>
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-icon">ğŸ’¡</span>
                        <h4 class="list-item-title">Ø§ÛŒØ¯Ù‡ Ù¾Ø±Ø¯Ø§Ø²</h4>
                    </div>
                    <p class="list-item-main-text">Ali.k</p>
                    <p class="list-item-description">Ø®Ø§Ù„Ù‚ Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ¢ÙˆØ±Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ØŒ Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ Ùˆ Ø¯Ø§Ø³ØªØ§Ù†â€ŒØ³Ø±Ø§ÛŒÛŒ Ø¯Ø± Ø¯Ù†ÛŒØ§ÛŒ Ù…Ø§ÙÛŒØ§.</p>
                </div>
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-icon">â˜ï¸</span>
                        <h4 class="list-item-title">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ±</h4>
                    </div>
                    <p class="list-item-main-text">Neda_Tech</p>
                    <p class="list-item-description">Ù…ØªØ®ØµØµ Ø¯Ø± Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø²ÛŒØ±Ø³Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ±ØŒ ØªØ¶Ù…ÛŒÙ† Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ùˆ Ø§Ù…Ù†ÛŒØª Ø¨Ø§Ø²ÛŒ.</p>
                </div>
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-icon">âš™ï¸</span>
                        <h4 class="list-item-title">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ±</h4>
                    </div>
                    <p class="list-item-main-text">SinaCloud</p>
                    <p class="list-item-description">Ù…Ø³Ø¦ÙˆÙ„ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ø´Ø¨Ú©Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ§Ù†.</p>
                </div>
                <div class="list-item">
                    <div class="list-item-header">
                        <span class="list-item-icon">ğŸš€</span>
                        <h4 class="list-item-title">ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ Ø³Ø±ÙˆØ± (DevOps)</h4>
                    </div>
                    <p class="list-item-main-text">ParsaDevOps</p>
                    <p class="list-item-description">Ù…ØªÙ…Ø±Ú©Ø² Ø¨Ø± ÙØ±Ø¢ÛŒÙ†Ø¯Ù‡Ø§ÛŒ DevOpsØŒ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Panel -->
    <div id="leaderboard-panel-container" class="fixed inset-0 flex items-center justify-center p-3 sm:p-4 panel-hidden z-[51] generic-panel-container">
        <div id="leaderboard-panel" class="generic-panel p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative transform transition-all duration-500 ease-out">
            <button id="close-leaderboard-panel-btn" class="close-generic-panel-btn">Ã—</button>
            <h3 class="text-2xl sm:text-3xl font-bold mb-6 sm:mb-8 text-center text-[#c49730] drop-shadow-[0_1px_1px_rgba(0,0,0,0.7)]">ğŸ† Ø¬Ø¯ÙˆÙ„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª ğŸ†</h3>
            <div id="leaderboard-list" class="space-y-3 text-right max-h-[calc(85vh-120px)] sm:max-h-[calc(85vh-150px)] overflow-y-auto pr-2 sm:pr-3 pl-1">
                <!-- Leaderboard items will be injected here -->
            </div>
        </div>
    </div>

    <!-- Clans Panel -->
    <div id="clans-panel-container" class="fixed inset-0 flex items-center justify-center p-3 sm:p-4 panel-hidden z-[51] generic-panel-container">
        <div id="clans-panel" class="generic-panel p-5 sm:p-7 rounded-xl max-w-lg md:max-w-xl w-full relative transform transition-all duration-500 ease-out">
            <button id="close-clans-panel-btn" class="close-generic-panel-btn">Ã—</button>
            <h3 class="text-2xl sm:text-3xl font-bold mb-6 sm:mb-8 text-center text-[#c49730] drop-shadow-[0_1px_1px_rgba(0,0,0,0.7)]">ğŸ›¡ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ù‚Ø¨ÛŒÙ„Ù‡ ğŸ›¡ï¸</h3>

            <div id="clan-management-content" class="max-h-[calc(85vh-120px)] sm:max-h-[calc(85vh-150px)] overflow-y-auto pr-2 sm:pr-3 pl-1">
                <div id="user-clan-view" class="hidden">
                    <h4 class="text-xl font-bold text-center mb-4">Ù‚Ø¨ÛŒÙ„Ù‡ Ø´Ù…Ø§: <span id="user-clan-name" class="text-[#efbe5a]"></span></h4>
                    <p class="text-center text-gray-400 mb-4">Ø§Ø¹Ø¶Ø§ÛŒ Ù‚Ø¨ÛŒÙ„Ù‡:</p>
                    <div id="user-clan-members-list" class="space-y-2 mb-6"></div>
                    <button id="leave-clan-btn" class="btn-mafia w-full bg-red-700 border-red-900 hover:bg-red-600">Ø®Ø±ÙˆØ¬ Ø§Ø² Ù‚Ø¨ÛŒÙ„Ù‡</button>
                </div>

                <div id="no-clan-view">
                    <div id="create-clan-section">
                        <h4 class="text-lg font-semibold mb-3 text-center">Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø¨ÛŒÙ„Ù‡ Ø¬Ø¯ÛŒØ¯</h4>
                        <input type="text" id="create-clan-name-input" placeholder="Ù†Ø§Ù… Ù‚Ø¨ÛŒÙ„Ù‡ (3 ØªØ§ 20 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" class="input-mafia w-full mb-1" maxlength="20">
                        <p id="create-clan-error-message"></p>
                        <button id="create-clan-btn" class="btn-mafia w-full mt-2">Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø¨ÛŒÙ„Ù‡</button>
                    </div>

                    <h4 class="text-lg font-semibold my-4 text-center border-t border-b border-gray-700 py-2">ÛŒØ§ Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ù‚Ø¨ÛŒÙ„Ù‡ Ù…ÙˆØ¬ÙˆØ¯</h4>
                    <input type="text" id="search-clan-input" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù… Ù‚Ø¨ÛŒÙ„Ù‡..." class="input-mafia w-full mb-4">
                    <div id="clans-list" class="space-y-3">
                        <!-- Clan list to join will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, orderBy, getDocs, writeBatch, limit, where, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: The firebaseConfig object remains the same.
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyBkUfmc3_TvcR8AkepIr1eB7YEvCD-7P3s",
                authDomain: "city-mafia.firebaseapp.com",
                projectId: "city-mafia",
                storageBucket: "city-mafia.appspot.com", 
                messagingSenderId: "66458127103",
                appId: "1:66458127103:web:8bcc2ad470f51b5db45aca",
                measurementId: "G-8M0M6BJ0GG"
              };

        let app;
        let auth;
        let db;
        let currentUserId = null;
        let isAuthReady = false;

        const gameState = {
            displayName: '',
            publicUserId: '',
            currentStage: 1,
            avatarUrl: '',
            clanId: null,
            clanName: null,
            currentQuestionData: null,
            isQuestionActive: false,
            isLoadingNextQuestion: false,
        };

        // All UI Element References are defined here as before...
        let loadingScreen, loadingMessage, mainScreen, gameScreen,
            registrationForm, displayNameInput, registerBtn, inputErrorMessage,
            userIdDisplayInput, generateUserIdBtn, userIdErrorMessage,
            userProfileArea, avatarContainer, avatarImage, userInfoBox, displayNameOutput,
            publicUserIdOutput, clanOutputBox, clanOutput,
            editNameBtn,
            mainScreenButtonsLayout,
            startGameBtn, mafiaFactBtn, devIntroBtnHeader, clansBtn, leaderboardBtn,
            stageDisplay, questionText,
            optionsContainer, questionExplanation, backToMainBtn,
            gameFeedback, aiThinkingIndicator,
            modalContainer, modalTitle, modalContentDynamic, modalMessage,
            changeNameInputContainer, newDisplayNameInput, changeNameErrorMessage,
            avatarGenerationContainer, generateAvatarBtn, avatarAiLoading,
            avatarSuggestionsContainer, avatarErrorMessage, modalConfirmBtn, modalCancelBtn,
            developersPanelContainer, closeDevelopersPanelBtn,
            leaderboardPanelContainer, closeLeaderboardPanelBtn, leaderboardList,
            clansPanelContainer, closeClansPanelBtn, clanManagementContent,
            userClanView, userClanName, userClanMembersList, leaveClanBtn,
            noClanView, createClanSection, createClanNameInput, createClanErrorMessage, createClanBtn,
            searchClanInput, clansList;

        let modalConfirmCallback = null;
        let modalCancelCallback = null;
        let selectedAvatarForConfirmation = null;
        
        // --- UI & Screen Management (Unchanged from previous version) ---
        function showScreen(screenElement) {
            if (!screenElement) return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenElement.classList.add('active');
            const isControllingOverflow = screenElement.id === 'main-screen' || screenElement.id === 'loading-screen';
            document.body.style.overflow = isControllingOverflow ? 'hidden' : 'auto';
            document.documentElement.style.overflow = isControllingOverflow ? 'hidden' : 'auto';
            screenElement.scrollTop = 0;
            updateUI();
        }

        function showPanel(panelContainer) {
            if (!panelContainer) return;
            panelContainer.classList.remove('panel-hidden');
            const panel = panelContainer.querySelector('.generic-panel');
            if (panel) {
                panel.style.opacity = '1';
                panel.style.transform = 'scale(1)';
            }
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }
        }

        function hidePanel(panelContainer) {
            if (!panelContainer) return;
            panelContainer.classList.add('panel-hidden');
            const panel = panelContainer.querySelector('.generic-panel');
            if (panel) {
                panel.style.opacity = '0';
                panel.style.transform = 'scale(0.95)';
            }
            const isAnyPanelVisible = !!document.querySelector('.generic-panel-container:not(.panel-hidden)') ||
                                    (modalContainer && !modalContainer.classList.contains('panel-hidden'));

            if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && !isAnyPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function showModal(title, message, confirmText = "ØªØ§ÛŒÛŒØ¯", cancelText = null, onConfirm = null, onCancel = null, modalType = "generic") {
            if (!modalTitle || !modalMessage || !changeNameInputContainer || !avatarGenerationContainer || !modalConfirmBtn || !modalCancelBtn || !modalContainer) {
                console.error("[showModal] Modal elements not found, cannot show modal.");
                return;
            }
            modalTitle.textContent = title;
            modalMessage.classList.add('hidden');
            changeNameInputContainer.classList.add('hidden');
            avatarGenerationContainer.classList.add('hidden');
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active')) {
                userProfileArea.classList.add('profile-area-hidden');
            }
            if (modalType === "changeName") {
                changeNameInputContainer.classList.remove('hidden');
                if(newDisplayNameInput) newDisplayNameInput.value = gameState.displayName;
                if(changeNameErrorMessage) changeNameErrorMessage.textContent = '';
                if(newDisplayNameInput) newDisplayNameInput.classList.remove('invalid');
                if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else if (modalType === "avatar") {
                avatarGenerationContainer.classList.remove('hidden');
                if(avatarSuggestionsContainer) avatarSuggestionsContainer.innerHTML = '';
                if(avatarErrorMessage) avatarErrorMessage.textContent = '';
                if(avatarAiLoading) avatarAiLoading.classList.add('hidden');
                 if (message && message.trim() !== "") {
                    modalMessage.innerHTML = message;
                    modalMessage.classList.remove('hidden');
                }
            } else {
                modalMessage.innerHTML = message;
                modalMessage.classList.remove('hidden');
            }
            modalConfirmBtn.textContent = confirmText;
            modalConfirmCallback = onConfirm;
            modalCancelCallback = onCancel;
            if (cancelText || modalType === "changeName" || modalType === "avatar") {
                modalCancelBtn.textContent = cancelText || "Ù„ØºÙˆ";
                modalCancelBtn.classList.remove('hidden');
            } else {
                modalCancelBtn.classList.add('hidden');
            }
            modalContainer.classList.remove('panel-hidden');
        }

        function hideModal() {
            if (!modalContainer) return;
            modalContainer.classList.add('panel-hidden');
            modalConfirmCallback = null;
            modalCancelCallback = null;
            if (changeNameInputContainer) changeNameInputContainer.classList.add('hidden');
            if (avatarGenerationContainer) avatarGenerationContainer.classList.add('hidden');
            if (modalMessage) modalMessage.classList.add('hidden');
            const isAnyPanelVisible = !!document.querySelector('.generic-panel-container:not(.panel-hidden)');
            if(userProfileArea && mainScreen && mainScreen.classList.contains('active') && !isAnyPanelVisible) {
                userProfileArea.classList.remove('profile-area-hidden');
            }
        }

        function handleModalConfirm() {
            if (modalConfirmCallback) {
                try {
                    modalConfirmCallback();
                } catch (e) {
                    console.error("[handleModalConfirm] Error in modal confirm callback:", e);
                    hideModal();
                }
            } else {
                hideModal();
            }
        }

        function handleModalCancel() {
            if (modalCancelCallback) {
                try {
                    modalCancelCallback();
                } catch (e) {
                    console.error("[handleModalCancel] Error in modal cancel callback:", e);
                }
            }
            hideModal();
        }

        function updateUI() {
            if(displayNameOutput) displayNameOutput.textContent = gameState.displayName || "Ù…Ù‡Ù…Ø§Ù†";
            if(publicUserIdOutput) publicUserIdOutput.textContent = gameState.publicUserId || "---";
            if(stageDisplay) stageDisplay.textContent = gameState.currentStage;
            if(clanOutputBox && clanOutput) {
                if (gameState.clanName) {
                    clanOutput.textContent = gameState.clanName;
                    clanOutputBox.classList.remove('hidden');
                } else {
                    clanOutputBox.classList.add('hidden');
                }
            }
            if(avatarImage && gameState.avatarUrl) {
                avatarImage.src = gameState.avatarUrl;
            } else if (avatarImage) {
                avatarImage.src = `https://placehold.co/80x80/333333/777777?text=?`;
            }
            let showRegistration = true;
            let showActionButtons = false;
            let showUserInfoAndAvatar = false;
            if (isAuthReady && gameState.displayName && gameState.publicUserId) {
                showRegistration = false;
                showActionButtons = true;
                if (mainScreen && mainScreen.classList.contains('active')) {
                    showUserInfoAndAvatar = true;
                }
            } else if (isAuthReady && (!gameState.displayName || !gameState.publicUserId)) {
                showRegistration = true;
                showActionButtons = false;
                showUserInfoAndAvatar = false;
            } else {
                showRegistration = true;
                showActionButtons = false;
                showUserInfoAndAvatar = false;
            }
            if(registrationForm){
                registrationForm.style.display = showRegistration ? 'block' : 'none';
            }
            if(mainScreenButtonsLayout){
                mainScreenButtonsLayout.classList.toggle('hidden', !showActionButtons);
            }
            if(userProfileArea){
                 const isAnyPanelVisible = !!document.querySelector('.generic-panel-container:not(.panel-hidden)') ||
                                        (modalContainer && !modalContainer.classList.contains('panel-hidden'));
                if (showUserInfoAndAvatar) {
                    userProfileArea.classList.remove('hidden');
                    if (avatarContainer) avatarContainer.classList.remove('hidden');
                    if (userInfoBox) userInfoBox.classList.remove('hidden');
                    if(isAnyPanelVisible) {
                         userProfileArea.classList.add('profile-area-hidden');
                    } else {
                        userProfileArea.classList.remove('profile-area-hidden');
                    }
                } else {
                    userProfileArea.classList.add('hidden');
                }
            }
        }
        
        // --- Firebase & Data Management (UPDATED PATHS) ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        currentUserId = user.uid;
                        await loadUserData();
                    } else {
                        console.log("User is signed out. Attempting to sign in.");
                        await signInAnonymously(auth).catch(err => {
                             console.error("Anonymous sign-in failed:", err);
                             if(loadingMessage) loadingMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…. Ù„Ø·ÙØ§ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.";
                        });
                        Object.assign(gameState, { displayName: '', publicUserId: '', avatarUrl: '', clanId: null, clanName: null });
                    }
                    isAuthReady = true;
                    updateUI();

                    if (loadingScreen && loadingScreen.classList.contains('active')) {
                        if(loadingMessage) loadingMessage.textContent = "Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!";
                        setTimeout(() => {
                            if(mainScreen) showScreen(mainScreen);
                        }, 500);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                if(loadingMessage) loadingMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø§Ø²ÛŒ.";
                if(mainScreenButtonsLayout) mainScreenButtonsLayout.classList.add('hidden');
            }
        }

        async function loadUserData() {
            if (!currentUserId || !db) return;
            // UPDATED PATH: Directly in the 'users' collection
            const userDocRef = doc(db, 'users', currentUserId);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    gameState.displayName = data.displayName || "";
                    gameState.publicUserId = data.publicUserId || "";
                    gameState.currentStage = data.currentStage || 1;
                    gameState.avatarUrl = data.avatarUrl || '';
                    gameState.clanId = data.clanId || null;
                    if (gameState.clanId) {
                        await loadClanData(gameState.clanId);
                    } else {
                        gameState.clanName = null;
                    }
                } else {
                    console.log("No user profile found, user needs to register.");
                    Object.assign(gameState, { displayName: '', publicUserId: '', currentStage: 1, avatarUrl: '', clanId: null, clanName: null });
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showModal("Ø®Ø·Ø§", "Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.", "Ø¨Ø§Ø´Ù‡");
                Object.assign(gameState, { displayName: '', publicUserId: '', avatarUrl: '', clanId: null, clanName: null });
            } finally {
                updateUI();
            }
        }

        async function saveUserData(isNewUser = false) {
            if (!currentUserId || !db) return;
            // UPDATED PATH: Directly in the 'users' collection
            const userDocRef = doc(db, 'users', currentUserId);
            try {
                const dataToSave = {
                    displayName: gameState.displayName,
                    publicUserId: gameState.publicUserId,
                    currentStage: gameState.currentStage,
                    avatarUrl: gameState.avatarUrl,
                    clanId: gameState.clanId, // can be null
                    lastUpdated: serverTimestamp()
                };
                 if (isNewUser) {
                    // This handles both creation and overwriting, which is fine for new user registration
                    await setDoc(userDocRef, dataToSave);
                 } else {
                    // For updates, 'merge: true' prevents overwriting fields that aren't in dataToSave
                    await setDoc(userDocRef, dataToSave, { merge: true });
                 }
                 console.log("User data saved successfully.");
            } catch (error) {
                console.error("Error saving user data:", error);
                showModal("Ø®Ø·Ø§", `Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. ${error.message}`, "Ø¨Ø§Ø´Ù‡");
            }
        }

        // --- Gemini & Imagen API Functions (Unchanged) ---
        const GEMINI_API_KEY = "AIzaSyCNrIBm-Qfteoz9twSWCqsCpuvusaCqEfw";
        const GEMINI_TEXT_MODEL = "gemini-1.5-flash";
        const IMAGEN_MODEL = "imagen-3.0-generate-002";
        async function callGeminiAPI(prompt, isJsonOutput = false) {
            if(aiThinkingIndicator) aiThinkingIndicator.classList.remove('hidden');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: isJsonOutput ? { responseMimeType: "application/json" } : {} };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆÛŒØ³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.");
                return isJsonOutput ? JSON.parse(text) : text;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showModal("Ø®Ø·Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ", `Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.<br><small>Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§: ${error.message}</small>`, "Ø¨Ø§Ø´Ù‡");
                return null;
            } finally {
                if(aiThinkingIndicator) aiThinkingIndicator.classList.add('hidden');
            }
        }
        async function callImagenAPI(prompt, sampleCount = 1) {
            if(avatarAiLoading) avatarAiLoading.classList.remove('hidden');
            if(avatarErrorMessage) avatarErrorMessage.textContent = '';
            const payload = { instances: [{ prompt }], parameters: { sampleCount } };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGEN_MODEL}:predict?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                const result = await response.json();
                if (result.predictions?.length > 0) return result.predictions.map(p => `data:image/png;base64,${p.bytesBase64Encoded}`);
                throw new Error("Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆÛŒØ³ Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.");
            } catch (error) {
                console.error("Error calling Imagen API:", error);
                if(avatarErrorMessage) avatarErrorMessage.textContent = `Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ø¢ÙˆØ§ØªØ§Ø±: ${error.message}`;
                return null;
            } finally {
                if(avatarAiLoading) avatarAiLoading.classList.add('hidden');
            }
        }
        
        // --- Game Logic, Helper Functions, User Profile/Avatar (Unchanged) ---
        // These functions do not depend on Firestore paths, so they remain the same.
        // generateQuestion, displayQuestion, handleAnswerSelection
        // validateAndSanitizeName, generateAlphanumericPublicUserId, generateMafiaFact
        // handleChangeDisplayName, generateAndDisplayAvatars, confirmAvatarSelection
        // All these functions can be copied from the previous response.
        async function generateQuestion(){if(gameState.isLoadingNextQuestion)return;gameState.isLoadingNextQuestion=!0,questionText&&(questionText.textContent="Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„ Ø¬Ø¯ÛŒØ¯..."),optionsContainer&&(optionsContainer.innerHTML=""),questionExplanation&&questionExplanation.classList.add("hidden"),gameFeedback&&(gameFeedback.textContent="");const e=`ÛŒÚ© Ø³ÙˆØ§Ù„ Ú†Ù†Ø¯ Ú¯Ø²ÛŒÙ†Ù‡ Ø§ÛŒ Ø¨Ø§ Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø§ÙÛŒØ§ (ØªØ§Ø±ÛŒØ®Ú†Ù‡ØŒ ÙÛŒÙ„Ù… Ù‡Ø§ØŒ Ø§ØµØ·Ù„Ø§Ø­Ø§ØªØŒ ÛŒØ§ Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ù…Ø§ÙÛŒØ§) Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†.
Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· Ùˆ ÙÙ‚Ø· ÛŒÚ© Ø¢Ø¨Ø¬Ú©Øª JSON Ø®Ø§Ù… Ø¨Ø§Ø´Ø¯ Ùˆ Ù‡ÛŒÚ† Ú†ÛŒØ² Ø¯ÛŒÚ¯Ø±ÛŒ Ø¯Ø± Ù¾Ø§Ø³Ø® Ù†Ø¨Ø§Ø´Ø¯.
Ø§Ø² Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø¨Ú©â€ŒØªÛŒÚ© (\`\`\`) ÛŒØ§ Ú©Ù„Ù…Ù‡ "json" Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ Ùˆ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†.
Ø³Ø§Ø®ØªØ§Ø± JSON Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§ Ø¨Ù‡ Ø§ÛŒÙ† ØµÙˆØ±Øª Ø¨Ø§Ø´Ø¯:
{
  "question": "Ù…ØªÙ† Ø³ÙˆØ§Ù„ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ",
  "options": ["Ú¯Ø²ÛŒÙ†Ù‡ Û±", "Ú¯Ø²ÛŒÙ†Ù‡ Û²", "Ú¯Ø²ÛŒÙ†Ù‡ Û³", "Ú¯Ø²ÛŒÙ†Ù‡ Û´"],
  "correctAnswerIndex": 0,
  "explanation": "ØªÙˆØ¶ÛŒØ­ Ù…Ø®ØªØµØ± Ø¯Ø± Ù…ÙˆØ±Ø¯ Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ"
}`;try{const t=await callGeminiAPI(e,!0);if(t&&t.question&&4===t.options?.length&&void 0!==t.correctAnswerIndex)gameState.currentQuestionData=t,displayQuestion();else throw new Error("Ø³Ø§Ø®ØªØ§Ø± Ø³ÙˆØ§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡ Ø§Ø² AI Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.")}catch(t){console.error("Error generating question:",t),questionText&&(questionText.textContent="Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙˆØ§Ù„."),showModal("Ø®Ø·Ø§ Ø¯Ø± Ø³ÙˆØ§Ù„",`Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„ Ø¬Ø¯ÛŒØ¯ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. (${t.message}) Ø¢ÛŒØ§ Ù…ÛŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ØŸ`,"ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯","ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ",(()=>{hideModal(),generateQuestion()}),(()=>{hideModal(),mainScreen&&showScreen(mainScreen)}))}finally{gameState.isLoadingNextQuestion=!1,gameState.isQuestionActive=!0}}function displayQuestion(){if(!gameState.currentQuestionData||!questionText||!optionsContainer)return;const{question:e,options:t}=gameState.currentQuestionData;questionText.textContent=e,optionsContainer.innerHTML="",t.forEach(((e,t)=>{const a=document.createElement("button");a.className="option-btn w-full p-3 rounded-md text-lg text-right",a.textContent=`${t+1}. ${e}`,a.dataset.index=t,a.addEventListener("click",handleAnswerSelection),optionsContainer.appendChild(a)})),questionExplanation&&questionExplanation.classList.add("hidden"),gameFeedback&&(gameFeedback.textContent=""),gameState.isQuestionActive=!0}async function handleAnswerSelection(e){if(!gameState.isQuestionActive)return;gameState.isQuestionActive=!1;const t=e.target.closest(".option-btn");if(!t)return;const a=parseInt(t.dataset.index),{correctAnswerIndex:s,explanation:n}=gameState.currentQuestionData;if(document.querySelectorAll("#options-container .option-btn").forEach((e=>{e.disabled=!0})),a===s)t.classList.add("correct"),gameFeedback.textContent="Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­!",gameFeedback.className="text-center text-lg font-semibold my-4 h-8 text-green-400",gameState.currentStage++,await saveUserData(),setTimeout((()=>{generateQuestion(),updateUI()}),2e3);else{t.classList.add("incorrect");const e=optionsContainer.querySelector(`.option-btn[data-index="${s}"]`);e&&e.classList.add("correct"),gameFeedback.textContent="Ù¾Ø§Ø³Ø® Ø§Ø´ØªØ¨Ø§Ù‡!",gameFeedback.className="text-center text-lg font-semibold my-4 h-8 text-red-400",setTimeout((()=>{generateQuestion(),updateUI()}),4e3)}n&&questionExplanation&&(questionExplanation.textContent=`ØªÙˆØ¶ÛŒØ­: ${n}`,questionExplanation.classList.remove("hidden"))}function validateAndSanitizeName(e,t,a){if(!a||!t)return null;let s=e.replace(/[^a-zA-Z0-9_.-]/g,"");e!==s&&(a.value=s);const n=s.trim();return n.length<3||n.length>20?(t.textContent="Ù†Ø§Ù… Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 3 ØªØ§ 20 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø§Ø´Ø¯.",a.classList.add("invalid"),null):(t.textContent="",a.classList.remove("invalid"),n)}function generateAlphanumericPublicUserId(e=5){return Array.from({length:e},(()=>"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".charAt(Math.floor(36*Math.random())))).join("")}async function generateMafiaFact(){const e="ÛŒÚ© Ø­Ù‚ÛŒÙ‚Øª Ø¬Ø§Ù„Ø¨ØŒ Ù†Ú©ØªÙ‡ ØªØ§Ø±ÛŒØ®ÛŒ Ú©Ù…ØªØ± Ø´Ù†ÛŒØ¯Ù‡ Ø´Ø¯Ù‡ØŒ ÛŒØ§ ÛŒÚ© Ø¯Ø§Ø³ØªØ§Ù†Ú© Ú©ÙˆØªØ§Ù‡ Ùˆ ØºØ§ÙÙ„Ú¯ÛŒØ±Ú©Ù†Ù†Ø¯Ù‡ (Ø­Ø¯ÙˆØ¯ Û²-Û´ Ø¬Ù…Ù„Ù‡) Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø¯Ù†ÛŒØ§ÛŒ Ù…Ø§ÙÛŒØ§ (ØªØ§Ø±ÛŒØ®Ú†Ù‡ØŒ ÙÛŒÙ„Ù…â€ŒÙ‡Ø§ØŒ Ø´Ø®ØµÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ø±ÙˆÙØŒ ÛŒØ§ Ø§ØµØ·Ù„Ø§Ø­Ø§Øª Ø±Ø§ÛŒØ¬) Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ù† ØªØ¹Ø±ÛŒÙ Ú©Ù†. Ø³Ø¹ÛŒ Ú©Ù† Ù‡Ø± Ø¨Ø§Ø± ÛŒÚ© Ù…Ø·Ù„Ø¨ Ø¬Ø¯ÛŒØ¯ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒ.";showModal("Ø¯Ø§Ù†Ø³ØªÙ†ÛŒ Ù…Ø§ÙÛŒØ§ âœ¨","<div class='loader mx-auto my-3'></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¢Ø±Ø´ÛŒÙˆÙ‡Ø§ÛŒ Ù…Ø®ÙÛŒ...</p>","Ø¨Ø§Ø´Ù‡");const t=await callGeminiAPI(e);t?showModal("Ø¯Ø§Ù†Ø³ØªÙ†ÛŒ Ù…Ø§ÙÛŒØ§ âœ¨",t.replace(/\n/g,"<br>"),"Ø¬Ø§Ù„Ø¨ Ø¨ÙˆØ¯!"):showModal("Ø®Ø·Ø§","Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù†Ú©ØªÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ú¯ÙØªÙ† Ù†ÛŒØ³Øª.","Ø¨Ø§Ø´Ù‡")}async function handleChangeDisplayName(){if(!newDisplayNameInput||!changeNameErrorMessage)return;const e=validateAndSanitizeName(newDisplayNameInput.value,changeNameErrorMessage,newDisplayNameInput);if(!e||e===gameState.displayName)return void(e===gameState.displayName&&(changeNameErrorMessage.textContent="Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ù…ØªÙØ§ÙˆØª Ø§Ø² Ù†Ø§Ù… ÙØ¹Ù„ÛŒ Ø¨Ø§Ø´Ø¯."));gameState.displayName=e,await saveUserData(),updateUI(),hideModal(),showModal("Ù…ÙˆÙÙ‚ÛŒØª","Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!","Ø¹Ø§Ù„ÛŒ!")}async function generateAndDisplayAvatars(){if(!avatarAiLoading||!avatarSuggestionsContainer||!modalConfirmBtn)return;const e="Cool mafia character avatar, portrait, dark theme, high detail, cinematic lighting, no text, no weapons",t=await callImagenAPI(e,4);avatarSuggestionsContainer.innerHTML="",selectedAvatarForConfirmation=null,t?.length>0?(t.forEach((e=>{const t=document.createElement("div");t.className="avatar-suggestion-item";const a=document.createElement("img");a.src=e,a.alt="Avatar suggestion",t.appendChild(a),t.addEventListener("click",(()=>{avatarSuggestionsContainer.querySelector(".selected")?.classList.remove("selected"),t.classList.add("selected"),selectedAvatarForConfirmation=e,modalConfirmBtn.disabled=!1})),avatarSuggestionsContainer.appendChild(t)})),modalConfirmBtn.textContent="Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÛŒÙ† Ø¢ÙˆØ§ØªØ§Ø±",modalConfirmBtn.disabled=!0):avatarErrorMessage&&(avatarErrorMessage.textContent="Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ù†ØªÙˆØ§Ù†Ø³ØªÛŒÙ… Ø¢ÙˆØ§ØªØ§Ø±ÛŒ Ø¨Ø³Ø§Ø²ÛŒÙ….",modalConfirmBtn.disabled=!0)}async function confirmAvatarSelection(){selectedAvatarForConfirmation?(gameState.avatarUrl=selectedAvatarForConfirmation,await saveUserData(),updateUI(),hideModal(),showModal("Ù…ÙˆÙÙ‚ÛŒØª","Ø¢ÙˆØ§ØªØ§Ø± Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!","Ø¹Ø§Ù„ÛŒ!")):avatarErrorMessage&&(avatarErrorMessage.textContent="Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¢ÙˆØ§ØªØ§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.")}

        // --- Leaderboard & Clans Functions (UPDATED PATHS) ---

        async function showLeaderboard() {
            showPanel(leaderboardPanelContainer);
            leaderboardList.innerHTML = "<div class='loader mx-auto my-4'></div>";
            try {
                // This query requires a composite index in Firestore on the 'users' collection.
                // Fields: currentStage (Descending), displayName (Ascending)
                // UPDATED PATH: Directly query the 'users' collection
                const usersRef = collection(db, "users");
                const q = query(usersRef,
                    orderBy("currentStage", "desc"),
                    orderBy("displayName"),
                    limit(50)
                );
                
                const querySnapshot = await getDocs(q);
                let rank = 1;
                leaderboardList.innerHTML = '';
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = "<p class='text-center text-gray-400'>Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø¯Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>";
                    return;
                }
                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data(); // Data is directly on the document now
                    if (!data || !data.displayName) return;
                    
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div class="leaderboard-rank">${rank++}</div>
                        <div class="leaderboard-player-info">
                            <div class="leaderboard-player-name">${data.displayName}</div>
                            <div class="leaderboard-player-id">${data.publicUserId}</div>
                        </div>
                        <div class="leaderboard-stage">Ù…Ø±Ø­Ù„Ù‡ ${data.currentStage || 1}</div>
                    `;
                    leaderboardList.appendChild(item);
                });
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                leaderboardList.innerHTML = `<p class='text-center text-red-400'>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø¯ÙˆÙ„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª. <br><small>Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø³Ø§Ø®Øª Index Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Firebase Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯. (Ø®Ø·Ø§ Ø±Ø§ Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯)</small></p>`;
            }
        }

        async function showClansPanel() {
            showPanel(clansPanelContainer);
            updateClanPanelUI();
            if (!gameState.clanId) {
                await loadAllClans();
            }
        }

        function updateClanPanelUI() {
            const hasClan = !!gameState.clanId;
            userClanView.classList.toggle('hidden', !hasClan);
            noClanView.classList.toggle('hidden', hasClan);
            if (hasClan) {
                userClanName.textContent = gameState.clanName;
                loadClanMembers();
            }
        }

        async function loadAllClans(searchTerm = '') {
            clansList.innerHTML = "<div class='loader mx-auto my-4'></div>";
            try {
                // UPDATED PATH: Directly query the 'clans' collection
                const clansRef = collection(db, 'clans');
                let q;
                if (searchTerm) {
                    // Requires an index on 'clans' collection for 'nameLower' (Ascending)
                    q = query(clansRef, where('nameLower', '>=', searchTerm.toLowerCase()), where('nameLower', '<=', searchTerm.toLowerCase() + '\uf8ff'), limit(20));
                } else {
                    // Requires an index on 'clans' collection for 'memberCount' (Descending)
                    q = query(clansRef, orderBy('memberCount', 'desc'), limit(30));
                }
                
                const querySnapshot = await getDocs(q);
                clansList.innerHTML = '';
                if (querySnapshot.empty) {
                    clansList.innerHTML = "<p class='text-center text-gray-400'>Ù‡ÛŒÚ† Ù‚Ø¨ÛŒÙ„Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>";
                    return;
                }
                querySnapshot.forEach(docSnap => {
                    const clan = docSnap.data();
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div class="clan-info">
                            <div class="clan-name">${clan.name}</div>
                            <div class="clan-members">${clan.memberCount || 0} Ø¹Ø¶Ùˆ</div>
                        </div>
                        <button class="btn-mafia-secondary join-clan-btn" data-clan-id="${docSnap.id}" data-clan-name="${clan.name}">Ù¾ÛŒÙˆØ³ØªÙ†</button>
                    `;
                    clansList.appendChild(item);
                });
            } catch (error) {
                console.error("Error loading all clans:", error);
                clansList.innerHTML = `<p class='text-center text-red-400'>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ù‚Ø¨Ø§ÛŒÙ„. <br><small>Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø³Ø§Ø®Øª Index Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Firebase Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.</small></p>`;
            }
        }

        async function loadClanData(clanId) {
            // UPDATED PATH: Directly in the 'clans' collection
            const clanDocRef = doc(db, 'clans', clanId);
            try {
                const docSnap = await getDoc(clanDocRef);
                if (docSnap.exists()) {
                    gameState.clanName = docSnap.data().name;
                } else {
                    console.warn("User's clan not found, resetting.");
                    gameState.clanId = null;
                    gameState.clanName = null;
                    await saveUserData();
                }
            } catch (error) {
                 console.error("Error loading clan data:", error);
            }
        }

        async function loadClanMembers() {
            if (!gameState.clanId) return;
            userClanMembersList.innerHTML = "<div class='loader mx-auto my-4'></div>";
            try {
                // Requires an index on 'users' collection for 'clanId' and 'displayName'
                // UPDATED PATH: Directly query the 'users' collection
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where("clanId", "==", gameState.clanId), orderBy("displayName"));
                const querySnapshot = await getDocs(q);
                userClanMembersList.innerHTML = '';
                if(querySnapshot.empty) {
                    userClanMembersList.innerHTML = "<p class='text-center text-gray-400'>Ø´Ù…Ø§ ØªÙ†Ù‡Ø§ Ø¹Ø¶Ùˆ Ø§ÛŒÙ† Ù‚Ø¨ÛŒÙ„Ù‡ Ù‡Ø³ØªÛŒØ¯.</p>";
                }
                querySnapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    const item = document.createElement('div');
                    item.className = 'bg-gray-800 p-2 rounded text-center';
                    item.textContent = user.displayName;
                    userClanMembersList.appendChild(item);
                });
            } catch (error) {
                console.error("Error loading clan members:", error);
                userClanMembersList.innerHTML = `<p class='text-center text-red-400'>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø¹Ø¶Ø§. <br><small>Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø³Ø§Ø®Øª Index Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Firebase Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.</small></p>`;
            }
        }

        async function handleCreateClan() {
            const clanName = validateAndSanitizeName(createClanNameInput.value, createClanErrorMessage, createClanNameInput);
            if (!clanName) return;
            createClanBtn.disabled = true;
            try {
                // UPDATED PATHS
                const clansRef = collection(db, 'clans');
                const q = query(clansRef, where("nameLower", "==", clanName.toLowerCase()));
                const existing = await getDocs(q);
                if (!existing.empty) throw new Error("Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨ÛŒÙ„Ù‡ Ù‚Ø¨Ù„Ø§ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.");

                const batch = writeBatch(db);
                const newClanRef = doc(collection(db, 'clans'));
                batch.set(newClanRef, {
                    name: clanName,
                    nameLower: clanName.toLowerCase(),
                    leaderId: currentUserId,
                    memberCount: 1,
                    createdAt: serverTimestamp()
                });
                const userProfileRef = doc(db, 'users', currentUserId);
                batch.update(userProfileRef, { clanId: newClanRef.id });
                await batch.commit();

                gameState.clanId = newClanRef.id;
                gameState.clanName = clanName;
                updateUI();
                updateClanPanelUI();
                showModal("Ù…ÙˆÙÙ‚ÛŒØª", `Ù‚Ø¨ÛŒÙ„Ù‡ "${clanName}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!`, "Ø¹Ø§Ù„ÛŒ!");
            } catch (error) {
                console.error("Error creating clan:", error);
                createClanErrorMessage.textContent = error.message;
            } finally {
                createClanBtn.disabled = false;
            }
        }

        async function handleJoinClan(clanId, clanName) {
            if (gameState.clanId) {
                showModal("Ø®Ø·Ø§", "Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¹Ø¶Ùˆ ÛŒÚ© Ù‚Ø¨ÛŒÙ„Ù‡ Ù‡Ø³ØªÛŒØ¯.", "Ø¨Ø§Ø´Ù‡");
                return;
            }
            showModal("Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ù‚Ø¨ÛŒÙ„Ù‡", `Ø¢ÛŒØ§ Ù…ÛŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ù‡ Ù‚Ø¨ÛŒÙ„Ù‡ "${clanName}" Ø¨Ù¾ÛŒÙˆÙ†Ø¯ÛŒØ¯ØŸ`, "Ø¨Ù„Ù‡ØŒ Ø¨Ù¾ÛŒÙˆÙ†Ø¯", "Ù„ØºÙˆ", async () => {
                hideModal();
                try {
                    // UPDATED PATHS
                    const batch = writeBatch(db);
                    const clanRef = doc(db, 'clans', clanId);
                    batch.update(clanRef, { memberCount: increment(1) });
                    const userProfileRef = doc(db, 'users', currentUserId);
                    batch.update(userProfileRef, { clanId: clanId });
                    await batch.commit();

                    gameState.clanId = clanId;
                    gameState.clanName = clanName;
                    updateUI();
                    updateClanPanelUI();
                    showModal("Ù…ÙˆÙÙ‚ÛŒØª", `Ø´Ù…Ø§ Ø¨Ù‡ Ù‚Ø¨ÛŒÙ„Ù‡ "${clanName}" Ù¾ÛŒÙˆØ³ØªÛŒØ¯!`, "Ø¹Ø§Ù„ÛŒ!");
                } catch (error) {
                    console.error("Error joining clan:", error);
                    showModal("Ø®Ø·Ø§", `Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ù‚Ø¨ÛŒÙ„Ù‡ Ù¾ÛŒØ´ Ø¢Ù…Ø¯: ${error.message}`, "Ø¨Ø§Ø´Ù‡");
                }
            });
        }

        async function handleLeaveClan() {
             showModal("Ø®Ø±ÙˆØ¬ Ø§Ø² Ù‚Ø¨ÛŒÙ„Ù‡", `Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‚Ø¨ÛŒÙ„Ù‡ "${gameState.clanName}" Ø±Ø§ ØªØ±Ú© Ú©Ù†ÛŒØ¯ØŸ`, "Ø¨Ù„Ù‡ØŒ Ø®Ø§Ø±Ø¬ Ø´Ùˆ", "Ù„ØºÙˆ", async () => {
                hideModal();
                if (!gameState.clanId) return;
                try {
                    // UPDATED PATHS
                    const batch = writeBatch(db);
                    const clanRef = doc(db, 'clans', gameState.clanId);
                    const clanDoc = await getDoc(clanRef);
                    if (clanDoc.exists()) {
                        if ((clanDoc.data().memberCount || 1) <= 1) {
                            batch.delete(clanRef);
                        } else {
                            batch.update(clanRef, { memberCount: increment(-1) });
                        }
                    }
                    const userProfileRef = doc(db, 'users', currentUserId);
                    batch.update(userProfileRef, { clanId: null });
                    await batch.commit();

                    showModal("Ù…ÙˆÙÙ‚ÛŒØª", `Ø´Ù…Ø§ Ù‚Ø¨ÛŒÙ„Ù‡ "${gameState.clanName}" Ø±Ø§ ØªØ±Ú© Ú©Ø±Ø¯ÛŒØ¯.`, "Ø¨Ø§Ø´Ù‡");
                    gameState.clanId = null;
                    gameState.clanName = null;
                    updateUI();
                    updateClanPanelUI();
                    await loadAllClans();
                } catch (error) {
                    console.error("Error leaving clan:", error);
                    showModal("Ø®Ø·Ø§", `Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø®Ø±ÙˆØ¬ Ø§Ø² Ù‚Ø¨ÛŒÙ„Ù‡ Ù¾ÛŒØ´ Ø¢Ù…Ø¯: ${error.message}`, "Ø¨Ø§Ø´Ù‡");
                }
            });
        }

        // --- Event Listeners & Initialization (Unchanged) ---
        function setupEventListeners(){if(modalConfirmBtn&&modalConfirmBtn.addEventListener("click",handleModalConfirm),modalCancelBtn&&modalCancelBtn.addEventListener("click",handleModalCancel),closeDevelopersPanelBtn&&closeDevelopersPanelBtn.addEventListener("click",(()=>hidePanel(developersPanelContainer))),closeLeaderboardPanelBtn&&closeLeaderboardPanelBtn.addEventListener("click",(()=>hidePanel(leaderboardPanelContainer))),closeClansPanelBtn&&closeClansPanelBtn.addEventListener("click",(()=>hidePanel(clansPanelContainer))),displayNameInput&&displayNameInput.addEventListener("input",(()=>validateAndSanitizeName(displayNameInput.value,inputErrorMessage,displayNameInput))),generateUserIdBtn&&generateUserIdBtn.addEventListener("click",(()=>{userIdDisplayInput&&(userIdDisplayInput.value=generateAlphanumericPublicUserId()),userIdErrorMessage&&(userIdErrorMessage.textContent="")})),registerBtn&Â®isterBtn.addEventListener("click",(async()=>{const e=validateAndSanitizeName(displayNameInput.value,inputErrorMessage,displayNameInput),t=userIdDisplayInput.value;if(!t)return void(userIdErrorMessage&& (userIdErrorMessage.textContent="Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø³Ø§Ø²ÛŒØ¯."));if(!e)return;gameState.displayName=e,gameState.publicUserId=t,gameState.currentStage=1,gameState.clanId=null,await saveUserData(!0),updateUI()})),editNameBtn&&editNameBtn.addEventListener("click",(()=>showModal("ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ","ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø§Ø³Øª.","ØªØºÛŒÛŒØ± Ù†Ø§Ù…","Ù„ØºÙˆ",handleChangeDisplayName,null,"changeName"))),avatarContainer&&avatarContainer.addEventListener("click",(()=>{selectedAvatarForConfirmation=null,showModal("ØªØºÛŒÛŒØ± Ø¢ÙˆØ§ØªØ§Ø±","","Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÛŒÙ† Ø¢ÙˆØ§ØªØ§Ø±","Ù„ØºÙˆ",confirmAvatarSelection,null,"avatar"),modalConfirmBtn&&(modalConfirmBtn.disabled=!0)})),generateAvatarBtn&&generateAvatarBtn.addEventListener("click",generateAndDisplayAvatars),newDisplayNameInput&&newDisplayNameInput.addEventListener("keydown",(e=>{e.key==="Enter"&&modalConfirmBtn.click()})),[startGameBtn,mafiaFactBtn,devIntroBtnHeader,leaderboardBtn,clansBtn].forEach((e=>{e&&e.addEventListener("click",(e=>{isAuthReady&&gameState.displayName&&gameState.publicUserId||(e.stopImmediatePropagation(),showModal("Ø«Ø¨Øª Ù†Ø§Ù… Ù„Ø§Ø²Ù… Ø§Ø³Øª","Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ØŒ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øª Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯.","Ø¨Ø§Ø´Ù‡"))}),!0)})),startGameBtn&&startGameBtn.addEventListener("click",(()=>showModal("Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ","Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ØªØ± Ø¨Ø§Ø²ÛŒ Ù„Ø·ÙØ§ Ø§Ø² ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø¯Ø± Ú©Ø´ÙˆØ± Ø§ÛŒØ§Ù„Ø§Øªâ€ŒÙ…ØªØ­Ø¯Ù‡ (Ø¢Ù…Ø±ÛŒÚ©Ø§) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.","Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡",null,(()=>{hideModal(),showScreen(gameScreen),generateQuestion()})))),mafiaFactBtn&&mafiaFactBtn.addEventListener("click",generateMafiaFact),devIntroBtnHeader&&devIntroBtnHeader.addEventListener("click",(()=>showPanel(developersPanelContainer))),leaderboardBtn&&leaderboardBtn.addEventListener("click",showLeaderboard),clansBtn&&clansBtn.addEventListener("click",showClansPanel),backToMainBtn&&backToMainBtn.addEventListener("click",(async()=>{await saveUserData(),gameState.currentQuestionData=null,showScreen(mainScreen)})),createClanBtn&&createClanBtn.addEventListener("click",handleCreateClan),leaveClanBtn&&leaveClanBtn.addEventListener("click",handleLeaveClan),clansList&&clansList.addEventListener("click",(e=>{const t=e.target.closest(".join-clan-btn");if(t){const{clanId:e,clanName:a}=t.dataset;handleJoinClan(e,a)}})),searchClanInput){let e;searchClanInput.addEventListener("input",(t=>{clearTimeout(e),e=setTimeout((()=>{loadAllClans(t.target.value.trim())}),300)}))}}
        function cacheDOMElements(){const get=e=>document.getElementById(e);loadingScreen=get("loading-screen"),mainScreen=get("main-screen"),gameScreen=get("game-screen"),loadingMessage=get("loading-message"),registrationForm=get("registration-form"),displayNameInput=get("display-name-input"),registerBtn=get("register-btn"),inputErrorMessage=get("input-error-message"),userIdDisplayInput=get("user-id-display"),generateUserIdBtn=get("generate-user-id-btn"),userIdErrorMessage=get("user-id-error-message"),userProfileArea=get("user-profile-area"),avatarContainer=get("avatar-container"),avatarImage=get("avatar-image"),userInfoBox=get("user-info-box"),displayNameOutput=get("display-name-output"),publicUserIdOutput=get("public-user-id-output"),clanOutputBox=get("clan-output-box"),clanOutput=get("clan-output"),editNameBtn=get("edit-name-btn"),mainScreenButtonsLayout=get("main-screen-buttons-layout"),startGameBtn=get("start-game-btn"),mafiaFactBtn=get("mafia-fact-btn"),devIntroBtnHeader=get("dev-intro-icon-btn-header"),leaderboardBtn=get("leaderboard-btn"),clansBtn=get("clans-btn"),stageDisplay=get("stage-display"),questionText=get("question-text"),optionsContainer=get("options-container"),questionExplanation=get("question-explanation"),backToMainBtn=get("back-to-main-btn"),gameFeedback=get("game-feedback"),aiThinkingIndicator=get("ai-thinking-indicator"),modalContainer=get("modal-container"),modalTitle=get("modal-title"),modalContentDynamic=get("modal-content-dynamic"),modalMessage=get("modal-message"),changeNameInputContainer=get("change-name-input-container"),newDisplayNameInput=get("new-display-name-input"),changeNameErrorMessage=get("change-name-error-message"),avatarGenerationContainer=get("avatar-generation-container"),generateAvatarBtn=get("generate-avatar-btn"),avatarAiLoading=get("avatar-ai-loading"),avatarSuggestionsContainer=get("avatar-suggestions-container"),avatarErrorMessage=get("avatar-error-message"),modalConfirmBtn=get("modal-confirm-btn"),modalCancelBtn=get("modal-cancel-btn"),developersPanelContainer=get("developers-panel-container"),closeDevelopersPanelBtn=get("close-developers-panel-btn"),leaderboardPanelContainer=get("leaderboard-panel-container"),closeLeaderboardPanelBtn=get("close-leaderboard-panel-btn"),leaderboardList=get("leaderboard-list"),clansPanelContainer=get("clans-panel-container"),closeClansPanelBtn=get("close-clans-panel-btn"),clanManagementContent=get("clan-management-content"),userClanView=get("user-clan-view"),userClanName=get("user-clan-name"),userClanMembersList=get("user-clan-members-list"),leaveClanBtn=get("leave-clan-btn"),noClanView=get("no-clan-view"),createClanSection=get("create-clan-section"),createClanNameInput=get("create-clan-name-input"),createClanErrorMessage=get("create-clan-error-message"),createClanBtn=get("create-clan-btn"),searchClanInput=get("search-clan-input"),clansList=get("clans-list")}

        async function initializeGame() {
            cacheDOMElements();
            if(userProfileArea) userProfileArea.classList.add('hidden');
            if(loadingMessage) loadingMessage.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ...";
            try {
                setupEventListeners();
                await initFirebase();
            } catch (error) {
                console.error("Error during initializeGame:", error);
                if(loadingMessage) loadingMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§Ø²ÛŒ.";
            }
        }

        document.addEventListener('DOMContentLoaded', initializeGame);

    </script>
</body>
</html>