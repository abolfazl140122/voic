<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی متنی</title>
    <!-- Tailwind CSS (still from CDN; for full unification, you'd process and inline its output) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (still from CDN; for full unification, you'd self-host or inline base64) -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        :root {
            --primary-bg: #1a202c;
            --secondary-bg: #2d3748;
            --text-color: #e2e8f0;
            --border-color: #4a5568;
            --button-blue: #4299e1;
            --button-green: #48bb78;
            --button-red: #e53e3e;
            --button-purple: #9f7aea;
            --button-brown: #dd6b20;
            --button-gray: #a0aec0;
            --input-bg: #2d3748;
            --input-border: #4a5568;
            --input-placeholder: #a0aec0;
            --modal-bg: #2d3748;
        }

        /* Classic Theme */
        body.theme-classic {
            font-family: 'Vazirmatn', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            direction: rtl;
        }

        .classic-btn {
            background-color: var(--button-blue);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }

        .classic-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .classic-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .classic-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: none;
            transform: none;
            box-shadow: none;
        }

        .btn-blue-classic { background-color: #3b82f6; }
        .btn-blue-classic:hover { background-color: #2563eb; }

        .btn-green-classic { background-color: #22c55e; }
        .btn-green-classic:hover { background-color: #16a34a; }

        .btn-red-classic { background-color: #ef4444; }
        .btn-red-classic:hover { background-color: #dc2626; }

        .btn-purple-classic { background-color: #8b5cf6; }
        .btn-purple-classic:hover { background-color: #7c3aed; }

        .btn-brown-classic { background-color: #f97316; }
        .btn-brown-classic:hover { background-color: #ea580c; }

        .btn-gray-classic { background-color: #64748b; }
        .btn-gray-classic:hover { background-color: #4b5563; }

        .classic-card {
            background: linear-gradient(145deg, #1f2937, #111827);
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(75, 85, 99, 0.5);
            color: #e2e8f0;
        }

        input, select {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: #e2e8f0;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        input::placeholder { color: #9ca3af; }
        input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }

        .profile-modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .profile-modal-content {
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.3s ease-out;
        }

        .profile-modal-enter-active {
            opacity: 1;
            transform: scale(1);
        }

        .profile-modal-leave-active {
            opacity: 0;
            transform: scale(0.9);
        }

        /* Page transition effects */
        .page-transition-active {
            transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
        }
        
        .page-transition-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .page-transition-hidden {
            opacity: 0;
            transform: translateY(-20px);
        }

        /* App Header/Footer */
        .app-header, .lobby-header {
            position: fixed;
            top: 0;
            width: 100%;
            height: 70px; /* Increased height */
            background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
            border-bottom: 1px solid #374151;
            display: flex;
            align-items: center;
            padding: 0 1rem;
            justify-content: space-between; /* Space out elements */
            z-index: 20; /* Above main content, below modals */
            color: #e2e8f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            box-sizing: border-box; /* Include padding in height */
        }

        .app-footer, .lobby-footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 90px; /* Increased height */
            background: linear-gradient(0deg, #1f2937 0%, #111827 100%);
            border-top: 1px solid #374151;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 1rem;
            z-index: 20;
            color: #e2e8f0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            box-sizing: border-box; /* Include padding in height */
        }

        .main-content-area {
            flex-grow: 1;
            padding-top: 70px; /* Match header height */
            padding-bottom: 90px; /* Match footer height */
            overflow-y: auto; /* Allow scrolling for content */
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Center content vertically */
        }
        
        /* Lobby List Item Styles */
        .lobby-item {
            background: linear-gradient(135deg, #1f2937, #121d2b);
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        .lobby-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .lobby-item-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            color: #d1d5db;
        }
        .lobby-item-details .detail-label {
            font-weight: bold;
            color: #e2e8f0;
        }
        .lobby-item-details .detail-value {
            color: #9ca3af;
        }
        .lobby-item-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap; /* Allow buttons to wrap */
            margin-top: 0.5rem;
            justify-content: flex-end; /* Align buttons to the right (RTL) */
        }
        .lobby-item .join-lobby-btn,
        .lobby-item .close-lobby-btn {
            padding: 0.7rem 1.4rem;
            font-size: 0.9rem;
            border-radius: 8px;
            font-weight: bold;
            white-space: nowrap; /* Prevent text wrapping inside buttons */
        }
        
        /* Icon Buttons in Footer */
        .icon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: #e2e8f0;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            cursor: pointer;
            width: 70px; /* Fixed width for better layout */
            height: 70px; /* Fixed height */
        }
        .icon-btn svg {
            width: 28px;
            height: 28px;
            margin-bottom: 4px;
        }
        .icon-btn:hover {
            color: #3b82f6;
            transform: translateY(-3px);
        }

        /* Loading Screen (NEW GRAPHICAL VERSION) */
        #loading-screen {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .loading-screen-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        #binary-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-family: monospace;
            font-size: 14px;
            color: rgba(34, 197, 94, 0.1); /* Greenish tint for binary */
            overflow: hidden;
            white-space: pre-wrap;
            animation: binary-scroll 60s linear infinite;
        }

        @keyframes binary-scroll {
            0% { transform: translateY(0%); }
            100% { transform: translateY(-100%); }
        }

        .magnifying-glass {
            position: relative;
            width: 200px;
            height: 200px;
            margin-bottom: 40px;
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        .glass-lens {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05); /* Frosted glass effect */
            border: 15px solid rgba(255, 255, 255, 0.1);
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .glass-handle {
            width: 30px;
            height: 100px;
            background: #4a5568;
            position: absolute;
            bottom: -60px;
            right: -60px;
            transform: rotate(45deg);
            border-bottom-right-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
        }

        .icon-human, .icon-ai {
            position: absolute;
            width: 100px;
            height: 100px;
            color: #fff;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .icon-human {
            animation: human-fade-in-out 6s infinite;
            animation-delay: 0s;
        }

        .icon-ai {
            animation: ai-fade-in-out 6s infinite;
            animation-delay: 3s;
        }

        @keyframes human-fade-in-out {
            0%, 100% { opacity: 0; }
            10%, 40% { opacity: 1; }
            50%, 90% { opacity: 0; }
        }

        @keyframes ai-fade-in-out {
            0%, 100% { opacity: 0; }
            10%, 40% { opacity: 1; }
            50%, 90% { opacity: 0; }
        }

        .loading-text-container {
            text-align: center;
            margin-top: 20px;
        }

        #loading-main-text {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 10px;
        }

        #loading-sub-text {
            font-size: 1.2rem;
            color: #a0aec0;
        }

        /* Lobby search bar */
        .search-container {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 500px;
            background-color: #1f2937;
            border: 1px solid #4a5568;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            margin: 0 auto; /* Center the search bar */
        }
        .search-container input {
            flex-grow: 1;
            background: none;
            border: none;
            padding: 0;
            margin: 0 0.5rem;
            font-size: 1rem;
        }
        .search-container button {
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            padding: 0.2rem;
        }
        .search-container button svg {
            width: 20px;
            height: 20px;
        }

        /* Lobby Detail Screen (Game View) */
        .lobby-detail-screen-full {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative; /* Crucial for absolute positioning of children */
        }

        #game-table-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #game-lobby-info-header {
            position: absolute;
            top: 20px;
            right: 20px; /* Positioned right for RTL */
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            color: #cbd5e1;
            text-align: right;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            max-width: 250px;
            direction: rtl; /* Ensure text is RTL */
        }
        #game-lobby-info-header h2 { font-size: 1.5rem; font-weight: bold; color: #f8fafc; margin-bottom: 0.5rem; }
        #game-lobby-info-header p { font-size: 1rem; margin-bottom: 0.2rem; }

        #game-lobby-exit-btn {
            position: absolute;
            top: 20px;
            left: 20px; /* Positioned left for RTL */
            background: #ef4444;
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: none;
        }
        #game-lobby-exit-btn:hover { background-color: #dc2626; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.4); }

        #game-table-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to pass through to elements beneath */
        }

        .game-player-pod-on-rug {
            position: absolute;
            width: 90px;
            height: 90px;
            background: linear-gradient(145deg, #2d3748, #1a202c);
            border: 3px solid #6366f1; /* Purple border */
            border-radius: 50%; /* Circle shape */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #e2e8f0;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            cursor: pointer;
            pointer-events: auto; /* Re-enable clicks for the pod itself */
        }
        .game-player-pod-on-rug:hover {
            transform: scale(1.08) translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
        }
        .game-player-pod-on-rug .player-avatar-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 5px;
            background-color: #374151; /* Placeholder for avatar background */
            display: block; /* Make SVG behave as a block element */
        }
        .game-player-pod-on-rug .player-number-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #6366f1;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .game-player-pod-on-rug .player-name-on-rug {
            position: absolute;
            bottom: -25px; /* Position below the circle */
            white-space: nowrap; /* Prevent name from wrapping */
            font-size: 0.9rem;
        }

        #game-lobby-controls-footer {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .control-cluster {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .emote-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #475569;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #cbd5e1;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            cursor: pointer;
            backdrop-filter: blur(5px);
            border: none;
        }
        .emote-btn:hover {
            background-color: #3b82f6; /* Blue hover for emotes */
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.5);
        }
        .emote-btn svg {
            width: 28px;
            height: 28px;
        }

        #mic-and-ready-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #mic-btn {
            background: #22c55e; /* Green for mic button */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        #mic-btn:hover {
            background-color: #16a34a;
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }

        #ready-toggle-btn {
            padding: 8px 30px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        #ready-toggle-btn.not-ready {
            background-color: #ef4444; /* Red */
            color: white;
        }
        #ready-toggle-btn.not-ready:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        #ready-toggle-btn.is-ready {
            background-color: #22c55e; /* Green */
            color: white;
        }
        #ready-toggle-btn.is-ready:hover {
            background-color: #16a34a;
            transform: translateY(-2px);
        }

        /* Lobby Type Toggle Styles */
        .lobby-type-btn {
            padding: 0.5rem 1.5rem;
            border: 2px solid;
            border-radius: 10px;
            transition: all 0.2s ease-in-out;
            background-color: transparent;
            font-weight: bold;
            cursor: pointer;
        }
        .lobby-type-btn.active {
            background-color: #3b82f6; /* Blue for active */
            color: white;
            border-color: #3b82f6;
        }
        .lobby-type-btn:not(.active) {
            color: #9ca3af;
            border-color: #64748b;
        }
        .lobby-type-btn:hover:not(.active) {
            background-color: rgba(100, 116, 139, 0.2);
            color: #e2e8f0;
        }

        /* Lock Icon for Lobbies */
        .lobby-lock-icon {
            width: 1.2rem;
            height: 1.2rem;
            margin-left: 0.5rem; /* For RTL */
            display: inline-block;
            vertical-align: middle;
            color: #fcd34d; /* Yellow for lock */
        }

        /* NEW: Countdown Animation */
        @keyframes countdown-pulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        .countdown-effect {
            animation: countdown-pulse 1s ease-out forwards;
        }

        /* NEW: Game Player Status Pods (Example of a dynamic player pod if needed elsewhere) */
        .game-player-pod {
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            min-width: 120px;
            transition: all 0.3s ease-in-out;
            position: relative;
        }
        .game-player-pod.current-active-player {
            transform: scale(1.05);
        }
        .game-player-pod .player-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }
        .game-player-pod .player-role {
            font-size: 0.9rem;
        }
        .game-player-pod .player-status {
            font-size: 0.8rem;
            margin-top: 0.2rem;
        }

        /* Voting Buttons */
        .voting-btn {
            padding: 1rem 2rem;
            font-size: 1.5rem;
            border-radius: 15px;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .voting-btn:hover:not(:disabled) {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
        }
        .voting-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Coin Icon for Buttons */
        .coin-icon {
            width: 1.25rem;
            height: 1.25rem;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.25rem;
        }

        /* Custom Scrollbar for overflow elements */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568; /* Scrollbar thumb color */
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* Darker thumb on hover */
        }
        /* General Responsive */
        @media (max-width: 640px) {
            .max-w-md { max-width: 95%; }
            .p-6, .p-8 { padding: 1.5rem; }
            .text-3xl { font-size: 2rem; }
            .classic-btn { padding: 0.75rem 1.25rem; font-size: 1rem; }
            .app-header, .lobby-header { padding: 0.5rem; height: 60px; }
            .app-footer, .lobby-footer { height: 80px; }
            .main-content-area { padding-top: 60px; padding-bottom: 80px; }

            /* Responsive for NEW Game View */
            .game-player-pod-on-rug { width: 75px; height: 75px; border-width: 2px; }
            .game-player-pod-on-rug .player-name-on-rug { font-size: 0.8rem; bottom: -20px;}
            .game-player-pod-on-rug .player-number-badge { width: 24px; height: 24px; font-size: 0.8rem; }
            #game-lobby-info-header h2 { font-size: 1.2rem; }
            #game-lobby-info-header p { font-size: 0.8rem; }
            #game-lobby-exit-btn { top: 15px; left: 15px; padding: 6px 18px; font-size: 0.9rem; }
            #mic-and-ready-container { bottom: 10px; }
            #mic-btn { width: 50px; height: 50px; }
            #mic-btn svg { width: 28px; height: 28px; }
            #ready-toggle-btn { font-size: 1rem; padding: 6px 25px;}
            .emote-btn { width: 40px; height: 40px; }
            .emote-btn svg { width: 20px; height: 20px; }
            .control-cluster { gap: 10px; }

            /* New Coin Display responsive */
            #header-user-coins-container {
                font-size: 1.2rem;
                padding: 0.4rem 0.8rem;
            }
            #header-user-coins-container .coin-icon {
                width: 1.2rem;
                height: 1.2rem;
                margin-left: 0.2rem;
            }
            /* Responsive loading screen */
            #loading-main-text { font-size: 1.8rem; }
            #loading-sub-text { font-size: 1rem; }
            .glass-lens { width: 140px; height: 140px; border-width: 10px; }
            .glass-handle { width: 25px; height: 80px; bottom: -50px; right: -50px; }
            .glass-lens .icon-human, .glass-lens .icon-ai { width: 80px; height: 80px; }
            /* Lobby item responsive */
            .lobby-item-details {
                flex-direction: column; /* Stack details vertically */
                align-items: flex-start; /* Align details to the right */
            }
            .lobby-item-details > div {
                margin-bottom: 0.25rem; /* Small space between stacked details */
            }
            .lobby-item-actions {
                flex-direction: row; /* Keep buttons in a row for small screens */
                justify-content: flex-end; /* Align to end */
                gap: 0.4rem; /* Smaller gap */
            }
            .lobby-item .join-lobby-btn,
            .lobby-item .close-lobby-btn {
                padding: 0.5rem 0.8rem; /* Smaller padding */
                font-size: 0.8rem; /* Smaller font */
            }
        }
    </style>
</head>
<body class="theme-classic">

    <!-- Main container for all screens -->
    <div id="app" class="relative w-full h-full flex justify-center items-center">

        <!-- 1. Loading Screen (NEW GRAPHICAL VERSION) -->
        <div id="loading-screen" class="absolute inset-0 flex flex-col justify-center items-center z-50 page-transition-active page-transition-visible">
            <div class="loading-screen-container">
                <div id="binary-background"></div>
                
                <div class="magnifying-glass">
                    <div class="glass-lens">
                        <!-- Human Icon -->
                        <svg class="icon-human" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                        </svg>
                        <!-- AI Icon -->
                        <svg class="icon-ai" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="16" height="16" x="4" y="4" rx="2" /><rect width="6" height="6" x="9" y="9" rx="1" /><path d="M9 2v2" /><path d="M15 2v2" /><path d="M9 20v2" /><path d="M15 20v2" /><path d="M20 9h2" /><path d="M20 14h2" /><path d="M2 9h2" /><path d="M2 14h2" />
                        </svg>
                    </div>
                    <div class="glass-handle"></div>
                </div>

                <div class="loading-text-container">
                    <h1 id="loading-main-text">جستجوی بازیکنان</h1>
                    <p id="loading-sub-text">در حال اتصال به سرور...</p>
                </div>
            </div>
        </div>


        <!-- 2. Authentication Screen (Login/Register) -->
        <div id="auth-screen" class="hidden absolute inset-0 flex justify-center items-center bg-gray-900 bg-opacity-90 z-40 page-transition-active page-transition-hidden">
            <div class="classic-card p-6 sm:p-8 w-11/12 max-w-md text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">ورود / ثبت نام</h2>
                <form id="auth-form" class="space-y-5">
                    <div>
                        <input type="email" id="email" placeholder="ایمیل شما"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <div id="display-name-field" class="hidden">
                         <input type="text" id="display-name" placeholder="نام نمایشی (در بازی)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <input type="password" id="password" placeholder="رمز عبور (حداقل ۶ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                    </div>
                    <!-- Toggle buttons for Auth mode -->
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse mt-6">
                        <button type="button" id="login-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn-blue-classic text-xl sm:text-2xl">
                            ورود
                        </button>
                        <button type="button" id="register-toggle-btn"
                                class="w-full sm:w-1/2 classic-btn btn-green-classic text-xl sm:text-2xl">
                            ثبت نام
                        </button>
                    </div>
                    <!-- Main submit button, text changes based on authMode -->
                    <button type="submit" id="submit-auth-btn"
                            class="w-full mt-4 classic-btn btn-purple-classic text-xl sm:text-2xl">
                        ادامه
                    </button>
                </form>
                <!-- Message box for user feedback -->
                <div id="message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 3. Main Screen -->
        <div id="main-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden">
            <!-- Header for Main Screen - Fixed at top -->
            <header class="app-header">
                <!-- User Info and ID - Aligned Right (for RTL) -->
                <div id="profile-summary" class="flex items-center space-x-2 space-x-reverse cursor-pointer p-2 rounded-lg hover:bg-gray-700 transition-colors duration-200" title="مشاهده پروفایل">
                     <!-- User icon SVG -->
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-circle">
                        <circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/>
                    </svg>
                    <div class="flex flex-col text-right">
                        <span id="header-display-name" class="font-bold text-lg">نام کاربری</span>
                        <span id="header-user-id" class="text-xs break-all">ID: ---</span>
                    </div>
                </div>

                <!-- Spacer to push elements to ends -->
                <div class="flex-grow"></div> 

                <!-- NEW LOCATION FOR COINS - Near the menu button (left for RTL) -->
                <div id="header-user-coins-container" class="flex items-center text-xl sm:text-2xl font-extrabold">
                    <svg class="coin-icon w-6 h-6 sm:w-8 sm:h-8 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-2-10h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2zm0 4h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2z"/></svg>
                    <span id="header-user-coins">---</span>
                </div>

                <!-- Hamburger Menu Icon - Aligned Left (for RTL) -->
                <button id="menu-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                    <!-- Hamburger icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu">
                        <line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>
                    </svg>
                </button>
            </header>

            <!-- Main Content Area - Scrollable between fixed header and footer -->
            <div class="main-content-area flex flex-col justify-center items-center">
                <!-- This area is now empty, ready for future game visuals/elements -->
                <h1 class="text-4xl font-bold mb-8">به بازی متنی خوش آمدید!</h1>
                <p class="text-lg">لطفاً یکی از گزینه‌های زیر را انتخاب کنید.</p>
            </div>

            <!-- Footer Navigation - Fixed at bottom -->
            <footer class="app-footer flex justify-center items-center gap-4">
                <button id="friendly-game-btn"
                        class="classic-btn btn-purple-classic text-base sm:text-lg flex-grow flex items-center justify-center whitespace-nowrap">
                        <svg class="coin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-2-10h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2zm0 4h4a1 1 0 0 0 0-2h-4a1 1 0 0 0 0 2z"/></svg>
                    <span>بازی دوستانه (<span id="friendly-game-cost">100</span>)</span>
                </button>
                <!-- Placeholder for other main buttons like 'Rated Game' -->
                <button id="rated-game-btn"
                        class="classic-btn btn-brown-classic text-base sm:text-lg flex-grow flex items-center justify-center whitespace-nowrap">
                    بازی امتیازی
                </button>
            </footer>
        </div>

        <!-- 4. Lobby Screen (صفحه جدید برای لابی‌ها) -->
        <div id="lobby-screen" class="hidden absolute inset-0 flex flex-col z-30 page-transition-active page-transition-hidden">
            <!-- Header for Lobby Screen -->
            <header class="lobby-header">
                <div class="search-container">
                    <button id="back-to-main-btn" class="p-1">
                        <!-- Right arrow icon for back (in RTL, it points left visually) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right">
                            <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                        </svg>
                    </button>
                    <input type="text" id="lobby-search-input" placeholder="جستجو بر اساس نام لابی، سازنده یا سناریو" class="flex-grow text-sm">
                    <button id="search-lobbies-btn" class="p-1">
                        <!-- Search icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search">
                            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main Content Area for Lobby Screen -->
            <div class="main-content-area p-4 sm:p-6 text-center">
                <div class="max-w-xl mx-auto space-y-6 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4">لیست لابی‌های فعال</h2>
                    <div id="lobbies-list" class="space-y-3 w-full">
                        <!-- Lobby items will be dynamically loaded here by JavaScript -->
                        <p>در حال بارگذاری لابی‌ها...</p>
                    </div>
                </div>
            </div>

            <!-- Footer for Lobby Screen -->
            <footer class="lobby-footer">
                <button id="add-icon-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-square">
                        <rect width="18" height="18" x="3" y="3" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/>
                    </svg>
                    <span>ایجاد</span>
                </button>
                <button id="refresh-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw">
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/>
                    </svg>
                    <span>بروزرسانی</span>
                </button>
                <button id="my-lobbies-btn" class="icon-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>لابی‌های من</span>
                </button>
                <div class="games-running-text">
                    <span id="active-games-count">0</span>
                    <span>بازی در حال اجرا</span>
                </div>
            </footer>
        </div>

        <!-- 5. Main Menu Modal (Replaces Profile Modal) -->
        <div id="main-menu-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <button id="close-main-menu-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>

                <!-- Main Menu Navigation -->
                <div id="main-menu-nav" class="space-y-4">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">منوی اصلی</h2>
                    <button id="show-profile-btn" class="w-full classic-btn btn-blue-classic text-lg sm:text-xl">
                        پروفایل کاربری
                    </button>
                    <button id="show-themes-btn" class="w-full classic-btn btn-green-classic text-lg sm:text-xl">
                        انتخاب تم
                    </button>
                    <button id="main-menu-logout-btn" class="w-full classic-btn btn-red-classic text-lg sm:text-xl">
                        خروج از حساب
                    </button>
                </div>

                <!-- Profile View (initially hidden, shown when "Profile" is clicked) -->
                <div id="profile-view" class="hidden text-lg space-y-4 mb-8 text-right">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">پروفایل کاربری</h2>
                    <p><strong>نام نمایشی:</strong> <span id="profile-display-name">---</span></p>
                    <p><strong>ایمیل:</strong> <span id="profile-email">---</span></p>
                    <p><strong>شناسه کاربر (UID):</strong> <span id="profile-uid" class="break-all text-sm">---</span></p>
                    <p><strong>سکه‌ها:</strong> <span id="profile-coins" class="font-bold">---</span></p>
                    <button id="back-to-main-menu-from-profile" class="w-full classic-btn btn-gray-classic text-lg sm:text-xl">
                        بازگشت
                    </button>
                </div>

                <!-- Themes View (initially hidden, shown when "Themes" is clicked) -->
                <div id="themes-view" class="hidden text-lg space-y-4 mb-8">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">انتخاب تم</h2>
                    <div id="theme-buttons-container" class="grid grid-cols-2 gap-4">
                        <!-- Theme buttons will be dynamically generated by JS -->
                    </div>
                    <button id="back-to-main-menu-from-themes" class="w-full classic-btn btn-gray-classic text-lg sm:text-xl">
                        بازگشت
                    </button>
                </div>
            </div>
        </div>

        <!-- 6. Create Lobby Input Modal (NEW) -->
        <div id="create-lobby-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative overflow-y-auto custom-scrollbar">
                <h2 id="create-lobby-modal-title" class="text-2xl sm:text-3xl font-bold mb-6">ساخت لابی جدید</h2>
                <button id="close-create-lobby-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <form id="create-lobby-form" class="space-y-5">

                    <!-- NEW: Lobby Name Selection/Proposal Area -->
                    <div id="lobby-name-selection-area" class="hidden">
                        <label for="approved-lobby-names-select" class="block text-right text-sm mb-1">نام لابی تأیید شده خود را انتخاب کنید:</label>
                        <select id="approved-lobby-names-select" class="w-full focus:outline-none focus:ring-2 focus:ring-green-500">
                            <!-- Options will be dynamically loaded here -->
                            <option value="">نام لابی را انتخاب کنید</option>
                        </select>
                    </div>

                    <div id="lobby-name-proposal-area" class="hidden">
                        <label for="proposed-lobby-name-input" class="block text-right text-sm mb-1">نام لابی جدید را برای تأیید ارسال کنید (می‌توانید از کد رنگی [#RRGGBB] در ابتدای نام استفاده کنید):</label>
                        <input type="text" id="proposed-lobby-name-input" placeholder="مثال: [#FFD700]لابی طلایی من"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="button" id="submit-lobby-name-for-approval-btn"
                                class="w-full mt-4 classic-btn btn-blue-classic text-lg sm:text-xl">
                            ارسال برای تأیید
                        </button>
                        <p class="text-sm mt-2" id="lobby-proposal-message">بعد از ارسال، ادمین نام لابی شما را بررسی و تأیید می‌کند. سپس می‌توانید از آن نام استفاده کنید.</p>
                    </div>
                    
                    <!-- NEW: Pending Lobby Names Area -->
                    <div id="pending-lobby-names-area" class="hidden mt-4">
                        <h3 class="text-xl font-bold mb-2">نام‌های لابی در انتظار تأیید شما:</h3>
                        <div id="pending-lobby-names-list" class="space-y-2 text-right max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- Pending names will be injected here -->
                            <p class="text-sm text-center">هیچ نام لابی در انتظار تایید ندارید.</p>
                        </div>
                    </div>

                    <!-- NEW: Approved Lobby Names Management Area -->
                    <div id="approved-lobby-names-management-area" class="hidden mt-4">
                        <h3 class="text-xl font-bold mb-2">نام‌های لابی تأیید شده شما:</h3>
                        <div id="approved-lobby-names-management-list" class="space-y-2 text-right max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- Approved names with delete buttons will be injected here -->
                            <p class="text-sm text-center">هیچ نام لابی تأیید شده‌ای ندارید.</p>
                        </div>
                    </div>

                    <div class="w-full h-px bg-yellow-600 my-4"></div> <!-- Divider -->

                    <!-- NEW: Lobby Type Toggle (Public/Private) -->
                    <div class="flex justify-center space-x-2 space-x-reverse my-4" id="lobby-type-toggle">
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="public" class="sr-only" checked>
                            <span class="lobby-type-btn active">عمومی</span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="lobby-type" value="private" class="sr-only">
                            <span class="lobby-type-btn">خصوصی</span>
                        </label>
                    </div>
        
                    <!-- NEW: Password field for private lobbies (initially hidden) -->
                    <div id="new-lobby-password-field" class="hidden relative">
                        <input type="password" id="new-lobby-password-input" placeholder="رمز عبور لابی (حداقل ۴ کاراکتر)"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500 pr-10">
                        <button type="button" id="toggle-password-visibility" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <svg id="eye-icon-open" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg id="eye-icon-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 4 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                        </button>
                    </div>
                    
                    <!-- NEW: Game Duration Input -->
                    <div>
                        <label for="game-duration-input" class="block text-right text-sm mb-1">مدت زمان بازی (دقیقه):</label>
                        <input type="number" id="game-duration-input" value="5" min="1" max="60"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-green-500 text-center"
                               required>
                    </div>

                    <button type="submit" id="submit-create-lobby-btn"
                            class="w-full mt-4 classic-btn btn-green-classic text-xl sm:text-2xl">
                        ساخت لابی
                    </button>
                </form>
                <div id="create-lobby-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

        <!-- 7. Custom Confirmation Modal -->
        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 id="confirm-title" class="text-2xl sm:text-3xl font-bold mb-6">تایید عملیات</h2>
                <p id="confirm-message" class="text-lg mb-8">آیا از انجام این عمل مطمئن هستید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="confirm-yes-btn" class="w-1/2 classic-btn btn-red-classic">بله</button>
                    <button id="confirm-no-btn" class="w-1/2 classic-btn btn-gray-classic">خیر</button>
                </div>
            </div>
        </div>

        <!-- 8. Lobby Detail Screen (REDESIGNED for Text-Based Game) -->
        <div id="lobby-detail-screen" class="hidden absolute inset-0 z-30 page-transition-active page-transition-hidden lobby-detail-screen-full">
            
            <!-- This container holds all the new absolutely positioned elements -->
            <div id="game-table-container">

                <!-- Top Header for Lobby Info -->
                <div id="game-lobby-info-header">
                    <h2 id="detail-lobby-name">نام لابی</h2>
                    <p id="detail-host-name" class="mt-1">سازنده: ---</p>
                    <p id="detail-scenario-name" class="mt-1">سناریو: Rifleman</p>
                    <p id="detail-player-count" class="mt-1">بازیکنان: 0/10</p>
                </div>

                <!-- Exit Button -->
                <button id="game-lobby-exit-btn">خروج</button>

                <!-- Central Area for Player Pods -->
                <div id="game-table-area">
                    <!-- Player pods will be dynamically injected here by JavaScript -->
                </div>

                <!-- Footer for Game Controls -->
                <div id="game-lobby-controls-footer">
                    <!-- Left Cluster of Emotes -->
                    <div class="control-cluster">
                        <button class="emote-btn" title="خوشحال">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
                        </button>
                        <button class="emote-btn" title="پیام">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </button>
                    </div>

                    <!-- Center Cluster for Mic and Ready Button -->
                    <div id="mic-and-ready-container">
                         <button id="mic-btn" title="میکروفون">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="23"/><line x1="8" x2="16" y1="23" y2="23"/></svg>
                         </button>
                         <button id="ready-toggle-btn" class="not-ready">آماده نیستم</button>
                    </div>

                    <!-- Right Cluster of Emotes -->
                    <div class="control-cluster">
                        <button class="emote-btn" title="بزن قدش">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 18h-2.4c-1 0-1.8-.8-1.8-1.8V12c0-.8.7-1.4 1.4-1.4h2.6c.8 0 1.4.6 1.4 1.4v.4c0 1-.8 1.8-1.8 1.8h-1.2"/><path d="M12 10.4V5.8c0-1 .8-1.8 1.8-1.8h1.4c1 0 1.8.8 1.8 1.8v1.8"/><path d="M6 18H5c-1.1 0-2-.9-2-2V7c0-1.1.9-2 2-2h1"/><path d="M7 5v13"/><path d="M12 5.5c0-1.4-1.1-2.5-2.5-2.5S7 4.1 7 5.5V11"/></svg>
                        </button>
                        <button class="emote-btn" title="لایک">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a2 2 0 0 1 1.79 1.11L15 5.88z"/></svg>
                        </button>
                        <button class="emote-btn" title="دیسلایک">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a2 2 0 0 1-1.79-1.11L9 18.12z"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Countdown Overlay -->
                <div id="game-countdown-overlay" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-90 z-40 hidden">
                    <div class="text-7xl font-extrabold countdown-effect" style="opacity:0; transform: scale(0.5);"></div>
                    <p class="text-2xl mt-4">بازی در حال شروع است...</p>
                </div>
                <!-- Voting/Game End Overlay -->
                <div id="game-voting-overlay" class="absolute inset-0 flex flex-col justify-center items-center bg-black bg-opacity-90 z-40 hidden">
                    <h2 class="text-4xl font-bold mb-6" id="voting-title">رای‌گیری آغاز شد!</h2>
                    <p class="text-xl mb-8" id="voting-instructions">برای چه کسی رای می‌دهید؟</p>
                    <div id="voting-options" class="flex flex-wrap justify-center gap-4">
                        <!-- Voting buttons will be injected here -->
                    </div>
                    <div id="game-result-display" class="hidden text-center mt-10">
                        <h2 class="text-5xl font-extrabold mb-4" id="winnerText"></h2>
                        <p class="text-2xl" id="reasonText"></p>
                        <button id="return-to-lobbies-btn" class="classic-btn btn-blue-classic mt-8 py-3 px-6">بازگشت به لابی‌ها</button>
                    </div>
                </div>

            </div>
        </div>

        <!-- 10. Kick Player Confirmation Modal -->
        <div id="kick-player-confirm-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">اخراج بازیکن</h2>
                <button id="close-kick-player-confirm-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <p class="text-lg mb-8">آیا مطمئن هستید که می‌خواهید <span id="kick-player-confirm-name" class="font-bold"></span> را از لابی اخراج کنید؟</p>
                <div class="flex justify-around space-x-4 space-x-reverse">
                    <button id="kick-player-confirm-btn" class="w-1/2 classic-btn btn-red-classic">اخراج کردن</button>
                    <button id="cancel-kick-player-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                </div>
            </div>
        </div>

        <!-- 11. Kicked Message Modal -->
        <div id="kicked-message-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">شما اخراج شدید!</h2>
                <p id="kicked-message-text" class="text-lg mb-8">شما از لابی <span class="font-bold" id="kicked-lobby-name"></span> اخراج شده‌اید و نمی‌توانید به آن بازگردید.</p>
                <button id="kicked-message-ok-btn" class="w-full classic-btn btn-blue-classic">متوجه شدم</button>
            </div>
        </div>

        <!-- 12. Kicked Players List Modal -->
        <div id="kicked-players-list-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">لیست بازیکنان اخراج شده</h2>
                <button id="close-kicked-players-list-modal-btn" class="absolute top-4 left-4 hover:text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
                <div id="kicked-players-list-content" class="space-y-4 mb-8 text-left max-h-60 overflow-y-auto custom-scrollbar">
                    <!-- Kicked players will be dynamically loaded here -->
                    <p class="text-center">هیچ بازیکنی اخراج نشده است.</p>
                </div>
                <button id="kicked-list-ok-btn" class="w-full classic-btn btn-gray-classic">بستن</button>
            </div>
        </div>
        
        <!-- 13. Enter Password Modal (for private lobbies) -->
        <div id="enter-password-modal" class="hidden fixed inset-0 flex justify-center items-center z-50 profile-modal-overlay">
            <div class="classic-card profile-modal-content p-6 sm:p-8 w-11/12 max-w-md text-center relative">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">ورود به لابی خصوصی</h2>
                <p class="text-lg mb-6">لابی <span id="password-prompt-lobby-name" class="font-bold"></span> نیاز به رمز عبور دارد.</p>
                <form id="enter-password-form" class="space-y-5">
                    <div>
                        <input type="password" id="join-lobby-password-input" placeholder="رمز عبور را وارد کنید"
                               class="w-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-center"
                               required>
                    </div>
                    <div class="flex justify-around space-x-4 space-x-reverse">
                        <button type="submit" id="submit-join-password-btn" class="w-1/2 classic-btn btn-green-classic">ورود</button>
                        <button type="button" id="cancel-join-password-btn" class="w-1/2 classic-btn btn-gray-classic">انصراف</button>
                    </div>
                </form>
                <div id="password-prompt-message-box" class="mt-5 p-3.5 rounded-xl text-base text-center hidden" role="alert"></div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs (Loaded as global scripts for WebView compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBpVHnjF5gdTm3vJiHEoAZCowsRkTapj_4", // **مهم: کلید API خود را اینجا قرار دهید**
            authDomain: "hokm-d6911.firebaseapp.com",
            projectId: "hokm-d6911",
            storageBucket: "hokm-d6911.appspot.com",
            messagingSenderId: "128133280011",
            appId: "1:128133280011:web:c9fe28f5201eef7a3a320e",
            measurementId: "G-LN0S9W86MK"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); // Access auth service
        const db = firebase.firestore(); // Access firestore service

        // Global variables for Firebase context (as per environment instructions)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Global AI API Key for Content Moderation (FOR DEMONSTRATION ONLY - INSECURE FOR PRODUCTION)
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE"; // **مهم: کلید API Gemini خود را اینجا قرار دهید**

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const authScreen = document.getElementById('auth-screen');
        const mainScreen = document.getElementById('main-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const displayNameInput = document.getElementById('display-name');
        const displayNameField = document.getElementById('display-name-field');
        const passwordInput = document.getElementById('password');
        const loginToggleBtn = document.getElementById('login-toggle-btn');
        const registerToggleBtn = document.getElementById('register-toggle-btn');
        const submitAuthBtn = document.getElementById('submit-auth-btn');
        const messageBox = document.getElementById('message-box'); 
        
        // NEW: Loading Screen specific elements
        const binaryBackground = document.getElementById('binary-background');
        const loadingSubText = document.getElementById('loading-sub-text');

        // Main Screen UI Elements
        const menuBtn = document.getElementById('menu-btn');
        const profileSummary = document.getElementById('profile-summary');
        const headerDisplayName = document.getElementById('header-display-name');
        const headerUserId = document.getElementById('header-user-id');
        const headerUserCoins = document.getElementById('header-user-coins'); // NEW (Updated for new location)
        const friendlyGameBtn = document.getElementById('friendly-game-btn');
        const friendlyGameCostSpan = document.getElementById('friendly-game-cost'); // NEW
        const ratedGameBtn = document.getElementById('rated-game-btn');

        // Lobby Screen UI Elements
        const lobbyScreen = document.getElementById('lobby-screen');
        const backToMainBtn = document.getElementById('back-to-main-btn'); // Inside Lobby Header Search Bar
        const lobbySearchInput = document.getElementById('lobby-search-input');
        const searchLobbiesBtn = document.getElementById('search-lobbies-btn');
        const lobbiesList = document.getElementById('lobbies-list');
        const addIconBtn = document.getElementById('add-icon-btn'); // Footer icon
        const refreshLobbiesBtn = document.getElementById('refresh-lobbies-btn'); // Footer icon
        const myLobbiesBtn = document.getElementById('my-lobbies-btn'); // Footer icon
        const activeGamesCount = document.getElementById('active-games-count');

        // Main Menu Modal Elements (Replaced Profile Modal)
        const mainMenuModal = document.getElementById('main-menu-modal');
        const closeMainMenuModalBtn = document.getElementById('close-main-menu-modal-btn');
        const mainMenuNav = document.getElementById('main-menu-nav');
        const showProfileBtn = document.getElementById('show-profile-btn');
        const showThemesBtn = document.getElementById('show-themes-btn');
        const mainMenuLogoutBtn = document.getElementById('main-menu-logout-btn'); // Logout button now in main menu modal

        // Profile View (inside Main Menu Modal)
        const profileView = document.getElementById('profile-view');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');
        const profileUid = document.getElementById('profile-uid');
        const profileCoins = document.getElementById('profile-coins');
        const backToMainMenuFromProfile = document.getElementById('back-to-main-menu-from-profile');

        // Themes View (inside Main Menu Modal)
        const themesView = document.getElementById('themes-view');
        const themeButtonsContainer = document.getElementById('theme-buttons-container');
        const backToMainMenuFromThemes = document.getElementById('back-to-main-menu-from-themes');


        // Create Lobby Modal Elements
        const createLobbyModal = document.getElementById('create-lobby-modal');
        const closeCreateLobbyModalBtn = document.getElementById('close-create-lobby-modal-btn'); 
        const createLobbyForm = document.getElementById('create-lobby-form');
        const submitCreateLobbyBtn = document.getElementById('submit-create-lobby-btn');
        const createLobbyMessageBox = document.getElementById('create-lobby-message-box');
        const lobbyTypeToggle = document.getElementById('lobby-type-toggle');
        const newLobbyPasswordField = document.getElementById('new-lobby-password-field'); // Corrected ID
        const newLobbyPasswordInput = document.getElementById('new-lobby-password-input');
        const togglePasswordVisibilityBtn = document.getElementById('toggle-password-visibility');
        const eyeIconOpen = document.getElementById('eye-icon-open');
        const eyeIconClosed = document.getElementById('eye-icon-closed');
        const gameDurationInput = document.getElementById('game-duration-input'); // NEW
        const createLobbyModalTitle = document.getElementById('create-lobby-modal-title'); // NEW: Added ID to H2

        // NEW: Lobby Name Selection/Proposal specific elements
        const lobbyNameSelectionArea = document.getElementById('lobby-name-selection-area');
        const approvedLobbyNamesSelect = document.getElementById('approved-lobby-names-select');
        const lobbyNameProposalArea = document.getElementById('lobby-name-proposal-area');
        const proposedLobbyNameInput = document.getElementById('proposed-lobby-name-input');
        const submitLobbyNameForApprovalBtn = document.getElementById('submit-lobby-name-for-approval-btn');
        const lobbyProposalMessage = document.getElementById('lobby-proposal-message'); // NEW for message about pending requests

        // NEW: Pending Lobby Names Area (for display of names waiting for admin approval)
        const pendingLobbyNamesArea = document.getElementById('pending-lobby-names-area');
        const pendingLobbyNamesList = document.getElementById('pending-lobby-names-list');

        // NEW: Approved Lobby Names Management Area (for deletion)
        const approvedLobbyNamesManagementArea = document.getElementById('approved-lobby-names-management-area');
        const approvedLobbyNamesManagementList = document.getElementById('approved-lobby-names-management-list');


        // Custom Confirmation Modal Elements
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        // --- NEW: LOBBY DETAIL SCREEN (GAME VIEW) ELEMENTS ---
        const lobbyDetailScreen = document.getElementById('lobby-detail-screen');
        const detailLobbyName = document.getElementById('detail-lobby-name');
        const detailHostName = document.getElementById('detail-host-name');
        const detailScenarioName = document.getElementById('detail-scenario-name');
        const detailPlayerCount = document.getElementById('detail-player-count');
        const gameLobbyExitBtn = document.getElementById('game-lobby-exit-btn');
        const gameTableArea = document.getElementById('game-table-area');
        const readyToggleBtn = document.getElementById('ready-toggle-btn');


        // Game specific UI elements for overlays (re-used)
        const gameCountdownOverlay = document.getElementById('game-countdown-overlay');
        const countdownNumber = gameCountdownOverlay.querySelector('.countdown-effect');
        const gameVotingOverlay = document.getElementById('game-voting-overlay');
        const votingTitle = document.getElementById('voting-title');
        const votingInstructions = document.getElementById('voting-instructions');
        const votingOptions = document.getElementById('voting-options');
        const gameResultDisplay = document.getElementById('game-result-display');
        const winnerText = document.getElementById('winnerText'); 
        const reasonText = document.getElementById('reasonText');
        const returnToLobbiesBtn = document.getElementById('return-to-lobbies-btn');


        // Kick Player Confirmation Modal Elements
        const kickPlayerConfirmModal = document.getElementById('kick-player-confirm-modal');
        const closeKickPlayerConfirmModalBtn = document.getElementById('close-kick-player-confirm-modal-btn');
        const kickPlayerConfirmName = document.getElementById('kick-player-confirm-name');
        const kickPlayerConfirmBtn = document.getElementById('kick-player-confirm-btn');
        const cancelKickPlayerBtn = document.getElementById('cancel-kick-player-btn');

        // Kicked Message Modal Elements
        const kickedMessageModal = document.getElementById('kicked-message-modal');
        const kickedMessageText = document.getElementById('kicked-message-text');
        const kickedLobbyName = document.getElementById('kicked-lobby-name');
        const kickedMessageOkBtn = document.getElementById('kicked-message-ok-btn');

        // Kicked Players List Modal Elements
        const kickedPlayersListModal = document.getElementById('kicked-players-list-modal');
        const closeKickedPlayersListModalBtn = document.getElementById('close-kicked-players-list-modal-btn');
        const kickedPlayersListContent = document.getElementById('kicked-players-list-content');
        const kickedListOkBtn = document.getElementById('kicked-list-ok-btn');
        
        // New Enter Password Modal Elements
        const enterPasswordModal = document.getElementById('enter-password-modal');
        const passwordPromptLobbyName = document.getElementById('password-prompt-lobby-name');
        const enterPasswordForm = document.getElementById('enter-password-form');
        const joinLobbyPasswordInput = document.getElementById('join-lobby-password-input');
        const submitJoinPasswordBtn = document.getElementById('submit-join-password-btn');
        const cancelJoinPasswordBtn = document.getElementById('cancel-join-password-btn');
        const passwordPromptMessageBox = document.getElementById('password-prompt-message-box');

        // State variables
        let authMode = 'login'; // Default mode is login
        let currentActiveScreen = loadingScreen;
        let currentUserData = null; // To store user's profile data
        let unsubscribeLobbies = null; // Global variable to store the unsubscribe function for lobby list listener
        let unsubscribeLobbyDetail = null; // Global variable for single lobby detail listener
        let unsubscribeKickedPlayers = null; // Listener for kicked players list
        let unsubscribeUserProfile = null; // NEW: Listener for real-time user profile updates
        let unsubscribePendingLobbyNames = null; // NEW: Listener for pending lobby names
        let unsubscribeGameSettings = null; // NEW: Listener for real-time game settings
        let isInitialAuthCheckComplete = false; // Flag to ensure initial loading screen transition happens only once
        let userHasActiveLobby = false; // Track if the current user has an active lobby (created or joined)
        let currentLobbyId = null; // Stores the ID of the lobby the current user is in
        let kickedPlayerToProcess = null; // Stores UID/name of player selected for kicking
        let lobbyToJoin = null; // To store data of private lobby user wants to join
        let isRefreshing = false; // NEW: State for refresh button
        let gameEntryCost = 100; // NEW: Default game entry cost, will be fetched from Firebase
        let currentTheme = 'classic'; // NEW: To store the currently active theme

        // Promise resolver for custom confirmation modal
        let resolveCustomConfirm;

        // Global timer variables for game
        let gameCountdownInterval = null;
        let gameTimerInterval = null;
        
        // NEW: Max pending proposals limit
        const MAX_PENDING_PROPOSALS = 5;

        // NEW: Player positions for the new layout
        const playerPositions = [
            { top: '45%', left: '18%' },
            { top: '35%', right: '18%' },
            { top: '65%', left: '25%' },
            { top: '65%', right: '25%' },
            { top: '25%', left: '40%' },
            { top: '25%', right: '40%' },
            { top: '80%', left: '40%' },
            { top: '80%', right: '40%' },
            { top: '50%', left: '50%' }, // Center-ish
            { top: '90%', left: '50%' }  // Bottom center
        ];

        // ===============================================
        // === START: NEW JS FOR ANIMATED LOADING SCREEN ===
        // ===============================================

        function createBinaryBackground() {
            if (!binaryBackground) return;
            const screenArea = window.innerWidth * window.innerHeight;
            const chars = Math.floor(screenArea / 150); // Adjust density
            let binaryString = '';
            for (let i = 0; i < chars; i++) {
                binaryString += Math.random() > 0.5 ? '1 ' : '0 ';
            }
            binaryBackground.textContent = binaryString;
        }

        function setRandomLoadingSubtext() {
            if (!loadingSubText) return;
            const subtexts = [
                "آیا می‌توانی هوش مصنوعی را در میان انسان‌ها بیابی؟",
                "هر پیامی می‌تواند یک سرنخ باشد...",
                "سکوت، گاهی بلندتر از فریاد است.",
                "در دنیای دیجیتال، به چه کسی می‌توان اعتماد کرد؟",
                "در حال تحلیل بازیکنان...",
                "برقراری ارتباط امن..."
            ];
            const randomIndex = Math.floor(Math.random() * subtexts.length);
            loadingSubText.textContent = subtexts[randomIndex];
        }

        // Initialize the new loading screen graphics immediately.
        createBinaryBackground();
        setRandomLoadingSubtext();

        // =============================================
        // === END: NEW JS FOR ANIMATED LOADING SCREEN ===
        // =============================================

        // Function to clear all game-related intervals
        function clearGameIntervals() {
            if (gameCountdownInterval) {
                clearInterval(gameCountdownInterval);
                gameCountdownInterval = null;
            }
            if (gameTimerInterval) {
                clearInterval(gameTimerInterval);
                gameTimerInterval = null;
            }
        }

        // Function to reset game UI elements
        function resetGameUI() {
            // Hide overlays from the new game view
            gameCountdownOverlay.classList.add('hidden');
            gameVotingOverlay.classList.add('hidden');

            // Reset other game-related UI elements if they exist from the old design
            const gameInfoPanel = document.getElementById('game-info-panel');
            if(gameInfoPanel) gameInfoPanel.classList.add('hidden');
        }

        // NEW: Theme Configurations
        const themeConfigs = {
            'classic': {
                displayName: 'کلاسیک',
                bodyClass: 'theme-classic',
                buttonClass: 'btn-brown-classic'
            },
            'cyberpunk': {
                displayName: 'سایبرپانک',
                bodyClass: 'theme-purple-classic', // Use a unique button class for cyberpunk
                // You might need more CSS definitions for this theme
            }
        };

        async function applyTheme(themeName) {
            let config = themeConfigs[themeName];
            if (!config) {
                console.warn(`Theme "${themeName}" not found. Falling back to 'classic'.`);
                themeName = 'classic';
                config = themeConfigs['classic'];
            }
            Object.values(themeConfigs).forEach(conf => {
                document.body.classList.remove(conf.bodyClass);
            });
            document.body.classList.add(config.bodyClass);
            currentTheme = themeName;
            updateThemeButtonsActiveState();
            if (auth.currentUser && currentUserData && currentUserData.theme !== themeName) {
                try {
                    const userProfileRef = db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`); // Using dot notation for Firestore instance
                    await userProfileRef.update({ theme: themeName });
                } catch (error) {
                    console.error("Error saving theme to user profile:", error);
                }
            }
        }

        function populateThemeButtons() {
            themeButtonsContainer.innerHTML = ''; 
            for (const themeKey in themeConfigs) {
                const theme = themeConfigs[themeKey];
                const button = document.createElement('button');
                button.className = `classic-btn ${theme.buttonClass} text-base sm:text-lg theme-button`;
                button.dataset.theme = themeKey;
                button.textContent = theme.displayName;
                button.addEventListener('click', () => applyTheme(themeKey));
                themeButtonsContainer.appendChild(button);
            }
            updateThemeButtonsActiveState();
        }

        function updateThemeButtonsActiveState() {
            document.querySelectorAll('.theme-button').forEach(btn => {
                btn.classList.toggle('active-theme-btn', btn.dataset.theme === currentTheme);
            });
        }

        function openMainMenuModal() {
            mainMenuModal.classList.remove('hidden');
            void mainMenuModal.offsetWidth;
            mainMenuModal.classList.add('profile-modal-enter-active');
            mainMenuNav.classList.remove('hidden');
            profileView.classList.add('hidden');
            themesView.classList.add('hidden');
        }

        function closeMainMenuModal() {
            mainMenuModal.classList.remove('profile-modal-enter-active');
            mainMenuModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                mainMenuModal.classList.add('hidden');
                mainMenuModal.classList.remove('profile-modal-leave-active');
            }, 300);
        }

        function showCustomMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = 'mt-5 p-3.5 rounded-xl text-base text-center';
            if (type === 'error') {
                element.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                element.classList.add('bg-green-500', 'text-white');
            } else {
                element.classList.add('bg-blue-500', 'text-white');
            }
            element.classList.remove('hidden');
            console.log(`پیام نمایش داده شد (${type}): ${message}`);
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }
        const showMessageBox = (msg, type) => showCustomMessage(messageBox, msg, type);
        const showCreateLobbyMessageBox = (msg, type) => showCustomMessage(createLobbyMessageBox, msg, type);

        function showCustomConfirm(message, title = 'تایید عملیات') {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                customConfirmModal.classList.remove('hidden');
                void customConfirmModal.offsetWidth; 
                customConfirmModal.classList.add('profile-modal-enter-active');
                resolveCustomConfirm = resolve;
                confirmYesBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(true);
                };
                confirmNoBtn.onclick = () => {
                    closeCustomConfirm();
                    resolveCustomConfirm(false);
                };
            });
        }

        function closeCustomConfirm() {
            customConfirmModal.classList.remove('profile-modal-enter-active');
            customConfirmModal.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                customConfirmModal.classList.add('hidden');
                customConfirmModal.classList.remove('profile-modal-leave-active');
            }, 300); 
        }

        async function checkLobbyNameWithAI(lobbyName) {
            // Placeholder: Assume name is appropriate
            return { is_appropriate: true, reason: "" };
        }

        async function checkMessageForLiteraryAIStyle(message) {
            // Placeholder: Assume message is appropriate
            return { is_literary: true, reason: "" };
        }

        function formatLobbyNameWithColor(name) {
            const regex = /^\[#([0-9A-Fa-f]{6})\](.*)/;
            const match = name.match(regex);
            if (match) {
                const colorCode = match[1];
                const cleanName = match[2].trim();
                return `<span style="color:#${colorCode};">${cleanName}</span>`;
            }
            return name;
        }

        function setActiveScreen(newScreen) {
            if (currentActiveScreen === newScreen) return;
            
            // Unsubscribe all active listeners before changing screen
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            if (unsubscribeLobbyDetail) { unsubscribeLobbyDetail(); unsubscribeLobbyDetail = null; }
            if (unsubscribeKickedPlayers) { unsubscribeKickedPlayers(); unsubscribeKickedPlayers = null; }
            if (unsubscribePendingLobbyNames) { unsubscribePendingLobbyNames(); unsubscribePendingLobbyNames = null; }
            if (unsubscribeGameSettings) { unsubscribeGameSettings(); unsubscribeGameSettings = null; } // Ensure game settings listener is cleared if needed
            clearGameIntervals();
            resetGameUI();

            currentActiveScreen.classList.remove('page-transition-visible');
            currentActiveScreen.classList.add('page-transition-hidden');
            
            setTimeout(() => {
                currentActiveScreen.classList.add('hidden');
                currentActiveScreen.classList.remove('page-transition-hidden');

                newScreen.classList.remove('hidden');
                void newScreen.offsetWidth; // Trigger reflow for transition
                newScreen.classList.add('page-transition-visible');
                
                if (newScreen === authScreen) initializeAuthScreen();
                else if (newScreen === lobbyScreen) {
                    lobbySearchInput.focus();
                    unsubscribeLobbies = setupLobbyListener(''); // Restart lobby listener
                } else if (newScreen === mainScreen) {
                    // Ensure game settings listener is active on main screen
                    setupGameSettingsListener();
                }

                currentActiveScreen = newScreen;
            }, 600);
        }
        
        // Helper functions for showing/hiding modals
        function showModal(modalElement) {
            modalElement.classList.remove('hidden');
            void modalElement.offsetWidth; // Trigger reflow for transition
            modalElement.classList.add('profile-modal-enter-active');
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('profile-modal-enter-active');
            modalElement.classList.add('profile-modal-leave-active');
            setTimeout(() => {
                modalElement.classList.add('hidden');
                modalElement.classList.remove('profile-modal-leave-active');
            }, 300); // Match CSS transition duration
        }

        function updateUserCoinsDisplay() {
            if (currentUserData && currentUserData.coins !== undefined) {
                headerUserCoins.textContent = currentUserData.coins.toLocaleString('fa-IR');
            } else {
                headerUserCoins.textContent = `---`;
            }
        }
        
        function setupGameSettingsListener() {
            if (unsubscribeGameSettings) unsubscribeGameSettings(); 
            const configRef = db.doc(`artifacts/${appId}/config/game_settings`);
            unsubscribeGameSettings = configRef.onSnapshot((docSnap) => {
                if (docSnap.exists()) {
                    const newCost = docSnap.data().gameEntryCost;
                    if (typeof newCost === 'number') {
                        gameEntryCost = newCost;
                        friendlyGameCostSpan.textContent = gameEntryCost.toLocaleString('fa-IR');
                    }
                }
            }, (error) => {
                console.error("خطا در گوش دادن به تنظیمات بازی:", error);
            });
        }
        
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                if (unsubscribeUserProfile) unsubscribeUserProfile();
                const userDocRef = db.doc(`artifacts/${appId}/users/${user.uid}/profile/data`);
                unsubscribeUserProfile = userDocRef.onSnapshot((docSnap) => {
                    if (docSnap.exists()) {
                        currentUserData = { uid: user.uid, email: user.email, ...docSnap.data() };
                        headerDisplayName.textContent = currentUserData.displayName || 'کاربر ناشناس';
                        headerUserId.textContent = `شناسه: ${currentUserData.uid.substring(0, 8)}...`;
                        updateUserCoinsDisplay();
                        const savedTheme = currentUserData.theme || 'classic';
                        if (currentTheme !== savedTheme) {
                            applyTheme(savedTheme);
                        }
                    } else {
                        // Create default profile if it doesn't exist
                        db.setDoc(userDocRef, {
                            displayName: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            coins: 500,
                            approvedLobbyNames: [],
                            banStatus: { isBanned: false },
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            theme: 'classic'
                        });
                    }
                });
            } else {
                if (unsubscribeUserProfile) unsubscribeUserProfile();
                if (unsubscribeLobbies) unsubscribeLobbies();
                if (unsubscribeLobbyDetail) unsubscribeLobbyDetail();
                currentUserData = null;
                applyTheme('classic');
            }

            if (!isInitialAuthCheckComplete) {
                setActiveScreen(user ? mainScreen : authScreen);
                isInitialAuthCheckComplete = true;
            } else {
                if (user && currentActiveScreen === authScreen) setActiveScreen(mainScreen);
                else if (!user && currentActiveScreen !== authScreen) setActiveScreen(authScreen);
            }
        });

        async function performAsyncAppSetup() {
            try {
                const configRef = db.doc(`artifacts/${appId}/config/game_settings`);
                const configSnap = await configRef.get();
                if (!configSnap.exists()) {
                    await configRef.set({ gameEntryCost: 100 });
                }
            } catch (error) {
                console.error("CRITICAL: Error initializing game settings config:", error);
            }
            setupGameSettingsListener();
            if (initialAuthToken) {
                try {
                    await auth.signInWithCustomToken(initialAuthToken);
                } catch (error) {
                    console.error("Error signing in with initial custom token:", error);
                }
            }
        }
        performAsyncAppSetup();

        function getFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/invalid-email': "فرمت ایمیل نامعتبر است.",
                'auth/user-not-found': "کاربری با این ایمیل یافت نشد.",
                'auth/wrong-password': "ایمیل یا رمز عبور اشتباه است.",
                'auth/email-already-in-use': "این ایمیل قبلاً ثبت نام شده است.",
                'auth/weak-password': "رمز عبور باید حداقل ۶ کاراکتر باشد."
            };
            return messages[errorCode] || "خطایی ناشناخته رخ داده است.";
        }
        
        async function createLobby(lobbyName, userId, displayName, lobbyType, password, gameDurationMinutes) {
            const lobbiesRef = db.collection(`global_lobbies`);
            const newLobbyData = {
                name: lobbyName,
                hostId: userId,
                status: "waiting", // "waiting" is the pre-game state
                type: lobbyType,
                players: { [userId]: { displayName: displayName, isReady: false } },
                kickedPlayers: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                gameSettings: { 
                    maxPlayers: 10,
                    gameDurationMinutes: gameDurationMinutes,
                    scenario: "Rifleman"
                }
            };
            if (lobbyType === 'private') newLobbyData.password = password;
            const newLobbyRef = await lobbiesRef.add(newLobbyData);
            userHasActiveLobby = true;
            return newLobbyRef.id;
        }

        // Function to render lobby list
        function renderLobbyList(lobbies) {
            lobbiesList.innerHTML = ''; // Clear existing list
            if (lobbies.length === 0) {
                lobbiesList.innerHTML = '<p class="text-gray-400 text-center">هیچ لابی فعالی یافت نشد.</p>';
                return;
            }

            lobbies.forEach(lobby => {
                const isPrivate = lobby.type === 'private';
                const playerCounts = Object.keys(lobby.players || {}).length;
                const maxPlayers = lobby.gameSettings?.maxPlayers || 10;
                const hostName = lobby.players[lobby.hostId]?.displayName || 'ناشناس';

                const lobbyItem = document.createElement('div');
                lobbyItem.className = 'lobby-item';
                lobbyItem.innerHTML = `
                    <div class="lobby-item-details">
                        <div>
                            <span class="detail-label">نام لابی:</span> 
                            <span class="detail-value">${formatLobbyNameWithColor(lobby.name)} ${isPrivate ? '<svg class="lobby-lock-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/></svg>' : ''}</span>
                        </div>
                        <div>
                            <span class="detail-label">سازنده:</span> 
                            <span class="detail-value">${hostName}</span>
                        </div>
                        <div>
                            <span class="detail-label">بازیکنان:</span> 
                            <span class="detail-value">${playerCounts}/${maxPlayers}</span>
                        </div>
                        <div>
                            <span class="detail-label">مدت زمان:</span> 
                            <span class="detail-value">${lobby.gameSettings?.gameDurationMinutes || '---'} دقیقه</span>
                        </div>
                    </div>
                    <div class="lobby-item-actions">
                        ${lobby.hostId === auth.currentUser.uid ? 
                            `<button class="close-lobby-btn classic-btn btn-red-classic" data-id="${lobby.id}">بستن لابی</button>` :
                            `<button class="join-lobby-btn classic-btn btn-green-classic" data-id="${lobby.id}" data-private="${isPrivate}">ورود به لابی</button>`
                        }
                    </div>
                `;
                lobbiesList.appendChild(lobbyItem);
            });

            // Add event listeners for new lobby items
            document.querySelectorAll('.join-lobby-btn').forEach(button => {
                button.onclick = () => handleJoinLobby(button.dataset.id, button.dataset.private === 'true');
            });
            document.querySelectorAll('.close-lobby-btn').forEach(button => {
                button.onclick = () => handleCloseLobby(button.dataset.id);
            });
        }

        // Firestore listener for lobby list
        function setupLobbyListener(searchTerm = '') {
            if (unsubscribeLobbies) unsubscribeLobbies(); // Unsubscribe from previous listener if any

            let q = db.collection('global_lobbies').where('status', '==', 'waiting').orderBy('createdAt', 'desc');
            
            if (searchTerm) {
                // Simplified search for demonstration.
                // For robust full-text search, consider a dedicated search service like Algolia or Firebase Extensions.
                q = q.where('name', '>=', searchTerm)
                     .where('name', '<=', searchTerm + '\uf8ff');
            }

            const unsubscribe = q.onSnapshot(snapshot => {
                const lobbies = [];
                snapshot.forEach(doc => {
                    lobbies.push({ id: doc.id, ...doc.data() });
                });
                renderLobbyList(lobbies);
                activeGamesCount.textContent = snapshot.size; // Update active lobby count
            }, error => {
                console.error("Error fetching lobbies:", error);
                showMessageBox("خطا در بارگذاری لیست لابی‌ها. لطفاً دوباره تلاش کنید.", "error");
            });
            return unsubscribe; // Return the unsubscribe function
        }

        async function handleJoinLobby(lobbyId, isPrivate) {
            if (!currentUserData || !auth.currentUser) {
                showMessageBox("برای ورود به لابی ابتدا وارد شوید.", "error");
                setActiveScreen(authScreen);
                return;
            }

            if (userHasActiveLobby && currentLobbyId !== lobbyId) {
                const confirmed = await showCustomConfirm("شما هم‌اکنون در یک لابی دیگر هستید. آیا می‌خواهید از آن لابی خارج شده و به این لابی بپیوندید؟", "تغییر لابی");
                if (!confirmed) return;
                // Leave the current active lobby first
                await leaveCurrentLobby();
            }

            lobbyToJoin = { id: lobbyId, isPrivate: isPrivate };

            if (isPrivate) {
                passwordPromptLobbyName.textContent = lobbyId; // Display lobby ID or name
                showModal(enterPasswordModal);
            } else {
                await joinLobby(lobbyId);
            }
        }

        async function joinLobby(lobbyId, password = null) {
            if (!currentUserData || !auth.currentUser) {
                showMessageBox("خطا: اطلاعات کاربری در دسترس نیست.", "error");
                return;
            }

            const myUid = auth.currentUser.uid;
            const lobbyRef = db.doc(`global_lobbies/${lobbyId}`);
            
            try {
                const lobbySnap = await lobbyRef.get();

                if (!lobbySnap.exists()) {
                    showMessageBox("لابی مورد نظر یافت نشد یا بسته شده است.", "error");
                    hideModal(enterPasswordModal);
                    return;
                }

                const lobbyData = lobbySnap.data();

                // Check for ban status
                if (lobbyData.kickedPlayers && lobbyData.kickedPlayers.includes(myUid)) {
                    kickedLobbyName.textContent = lobbyData.name;
                    showModal(kickedMessageModal);
                    hideModal(enterPasswordModal);
                    return;
                }

                // Check password for private lobby
                if (lobbyData.type === 'private' && lobbyData.password !== password) {
                    showCustomMessage(passwordPromptMessageBox, "رمز عبور اشتباه است.", "error");
                    return;
                }

                // Check player count
                const currentPlayers = lobbyData.players ? Object.keys(lobbyData.players).length : 0;
                const maxPlayers = lobbyData.gameSettings?.maxPlayers || 10;
                if (currentPlayers >= maxPlayers) {
                    showMessageBox("لابی پر است.", "error");
                    hideModal(enterPasswordModal);
                    return;
                }

                // Add player to the lobby
                const newPlayerEntry = { displayName: currentUserData.displayName, isReady: false };
                await lobbyRef.update({
                    [`players.${myUid}`]: newPlayerEntry
                });

                currentLobbyId = lobbyId;
                userHasActiveLobby = true;
                hideModal(enterPasswordModal);
                setActiveScreen(lobbyDetailScreen);
                unsubscribeLobbyDetail = setupLobbyDetailListener(lobbyId);

            } catch (error) {
                console.error("Error joining lobby:", error);
                showMessageBox("خطا در ورود به لابی. لطفاً دوباره تلاش کنید.", "error");
            }
        }

        async function handleCloseLobby(lobbyId) {
            const confirmed = await showCustomConfirm("آیا مطمئن هستید که می‌خواهید این لابی را ببندید؟ این عمل غیرقابل بازگشت است.", "بستن لابی");
            if (!confirmed) return;

            try {
                await db.doc(`global_lobbies/${lobbyId}`).delete();
                showMessageBox("لابی با موفقیت بسته شد.", "success");
                currentLobbyId = null;
                userHasActiveLobby = false;
            } catch (error) {
                console.error("Error closing lobby:", error);
                showMessageBox("خطا در بستن لابی. لطفاً دوباره تلاش کنید.", "error");
            }
        }

        async function leaveCurrentLobby() {
            if (!currentLobbyId || !auth.currentUser) return;

            const lobbyRef = db.doc(`global_lobbies/${currentLobbyId}`);
            const myUid = auth.currentUser.uid;
            
            try {
                const lobbySnap = await lobbyRef.get();
                if (!lobbySnap.exists()) { 
                    currentLobbyId = null;
                    userHasActiveLobby = false;
                    return; 
                }
                const lobbyData = lobbySnap.data();

                if (lobbyData.hostId === myUid) {
                    // Host leaving, delete the lobby
                    await lobbyRef.delete();
                } else {
                    // Regular player leaving, remove from players map
                    await lobbyRef.update({
                        [`players.${myUid}`]: firebase.firestore.FieldValue.delete()
                    });
                }
                currentLobbyId = null;
                userHasActiveLobby = false;

            } catch (error) {
                console.error("Error leaving lobby:", error);
                showMessageBox("خطا در خروج از لابی.", "error");
            }
        }

        // =============================================================
        // === START: MODIFIED LOBBY DETAIL LISTENER FOR NEW LAYOUT  ===
        // =============================================================
        
        function setupLobbyDetailListener(lobbyId) {
            console.log(`Listening to lobby details for ID: ${lobbyId} with NEW layout.`);
            if (unsubscribeLobbies) { unsubscribeLobbies(); unsubscribeLobbies = null; }
            clearGameIntervals();
            resetGameUI();

            const lobbyRef = db.doc(`global_lobbies/${lobbyId}`);
            const unsubscribe = lobbyRef.onSnapshot(async (docSnap) => {
                if (!docSnap.exists()) {
                    showMessageBox("لابی که در آن بودید بسته شد.", "info");
                    currentLobbyId = null; userHasActiveLobby = false;
                    setActiveScreen(lobbyScreen);
                    return;
                }
                
                const lobbyData = docSnap.data();
                const myUid = auth.currentUser.uid;

                // Check if user is still in lobby
                if (!lobbyData.players || !lobbyData.players[myUid]) {
                    // Logic for when user is kicked or leaves
                     showMessageBox("شما از لابی خارج شدید.", "info");
                     setActiveScreen(lobbyScreen);
                    return;
                }

                // If game is playing, redirect to game logic (can be added later)
                if (lobbyData.status === 'playing') {
                    // setupGameUI(lobbyId, lobbyData); // Future function call
                    // For now, if it enters 'playing' state, just return to lobbies
                    showMessageBox("بازی آغاز شد. (قابلیت پیوستن به بازی در حال توسعه است.)", "info");
                    setActiveScreen(lobbyScreen);
                    return;
                }
                
                // --- RENDER NEW LAYOUT ---
                const playersMap = lobbyData.players || {};
                const playerCount = Object.keys(playersMap).length;
                const maxPlayers = lobbyData.gameSettings?.maxPlayers || 10;
                const hostDisplayName = playersMap[lobbyData.hostId]?.displayName || 'ناشناس';

                // Update top info header
                detailLobbyName.innerHTML = formatLobbyNameWithColor(lobbyData.name);
                detailHostName.textContent = `سازنده: ${hostDisplayName}`;
                detailScenarioName.textContent = `سناریو: ${lobbyData.gameSettings?.scenario || 'نامشخص'}`;
                detailPlayerCount.textContent = `بازیکنان: ${playerCount}/${maxPlayers}`;

                // Render players on the rug
                gameTableArea.innerHTML = ''; // Clear previous pods
                const playerArray = Object.entries(playersMap);

                playerArray.forEach(([uid, playerData], index) => {
                    if (index >= playerPositions.length) return; // Don't render more players than we have positions for

                    const pos = playerPositions[index];
                    const playerPod = document.createElement('div');
                    playerPod.className = 'game-player-pod-on-rug';
                    playerPod.style.top = pos.top;
                    playerPod.style.left = pos.left;
                    playerPod.style.right = pos.right || 'auto';
                    playerPod.style.bottom = pos.bottom || 'auto';
                    
                    // Default SVG Avatar (simple grey head for now)
                    const avatarHTML = `
                        <svg class="player-avatar-img" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                        </svg>`;

                    playerPod.innerHTML = `
                        <div class="player-number-badge">${index + 1}</div>
                        ${avatarHTML}
                        <div class="player-name-on-rug">${playerData.displayName}</div>
                    `;
                    gameTableArea.appendChild(playerPod);
                });
                
                // Update "Ready" button status
                const myReadyStatus = playersMap[myUid]?.isReady || false;
                if (myReadyStatus) {
                    readyToggleBtn.textContent = "آماده‌ام";
                    readyToggleBtn.classList.remove('not-ready');
                    readyToggleBtn.classList.add('is-ready');
                } else {
                    readyToggleBtn.textContent = "آماده نیستم";
                    readyToggleBtn.classList.remove('is-ready');
                    readyToggleBtn.classList.add('not-ready');
                }

                // Start game if all players are ready (and there are at least 2 players)
                const allPlayersReady = playerArray.length >= 2 && playerArray.every(([, pData]) => pData.isReady);
                if (allPlayersReady && lobbyData.hostId === myUid && lobbyData.status === 'waiting') {
                    // Host initiates the countdown/game start
                    startLobbyCountdown(lobbyId);
                }


            }, (error) => {
                console.error("Lobby detail listener error:", error);
                setActiveScreen(lobbyScreen);
            });
            return unsubscribe;
        }

        // Function to toggle the ready state of a player
        async function toggleReadyState() {
            if (!currentLobbyId || !auth.currentUser) return;
            const myUid = auth.currentUser.uid;
            const lobbyRef = db.doc(`global_lobbies/${currentLobbyId}`);

            try {
                const lobbySnap = await lobbyRef.get();
                if (lobbySnap.exists()) {
                    const currentPlayers = lobbySnap.data().players;
                    const myCurrentState = currentPlayers[myUid]?.isReady || false;
                    
                    // Update the state in Firestore using dot notation
                    await lobbyRef.update({
                        [`players.${myUid}.isReady`]: !myCurrentState
                    });
                }
            } catch (error) {
                console.error("Error toggling ready state:", error);
                showMessageBox("خطا در تغییر وضعیت آمادگی.", "error");
            }
        }

        // Function to start countdown and then the game
        async function startLobbyCountdown(lobbyId) {
            const lobbyRef = db.doc(`global_lobbies/${lobbyId}`);
            let count = 5; // Countdown from 5

            showModal(gameCountdownOverlay);
            countdownNumber.textContent = count;

            gameCountdownInterval = setInterval(async () => {
                count--;
                if (count > 0) {
                    countdownNumber.textContent = count;
                    // Restart animation
                    countdownNumber.classList.remove('countdown-effect');
                    void countdownNumber.offsetWidth; // Trigger reflow
                    countdownNumber.classList.add('countdown-effect');
                } else {
                    clearInterval(gameCountdownInterval);
                    gameCountdownInterval = null;
                    hideModal(gameCountdownOverlay);
                    // Update lobby status to 'playing'
                    try {
                        await lobbyRef.update({ status: 'playing' });
                        console.log("Lobby status updated to 'playing'.");
                    } catch (error) {
                        console.error("Error updating lobby status to playing:", error);
                    }
                }
            }, 1000);
        }

        // Function to set up the authentication screen
        function initializeAuthScreen() {
            // Reset form and message box
            authForm.reset();
            messageBox.classList.add('hidden');
            // Ensure correct initial state based on authMode
            updateAuthFormUI();
        }

        // Function to update UI based on auth mode (login/register)
        function updateAuthFormUI() {
            if (authMode === 'register') {
                displayNameField.classList.remove('hidden');
                submitAuthBtn.textContent = 'ثبت نام';
                loginToggleBtn.classList.remove('classic-btn-active');
                registerToggleBtn.classList.add('classic-btn-active');
            } else {
                displayNameField.classList.add('hidden');
                submitAuthBtn.textContent = 'ورود';
                registerToggleBtn.classList.remove('classic-btn-active');
                loginToggleBtn.classList.add('classic-btn-active');
            }
        }
        
        // Event Listeners
        // Authentication form submission
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            const displayName = displayNameInput.value;

            messageBox.classList.add('hidden'); // Hide any previous messages

            try {
                if (authMode === 'register') {
                    if (!displayName.trim()) {
                        showMessageBox('لطفاً نام نمایشی خود را وارد کنید.', 'error');
                        return;
                    }
                    const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    // Create user profile in Firestore
                    await db.doc(`artifacts/${appId}/users/${user.uid}/profile/data`).set({
                        displayName: displayName,
                        email: email,
                        coins: 500, // Initial coins
                        approvedLobbyNames: [], // Empty array for approved lobby names
                        banStatus: { isBanned: false },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        theme: 'classic' // Default theme
                    });
                    showMessageBox('ثبت نام موفقیت‌آمیز بود! به بازی خوش آمدید.', 'success');
                } else { // Login mode
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                    showMessageBox('ورود موفقیت‌آمیز بود! به بازی خوش آمدید.', 'success');
                }
            } catch (error) {
                console.error("Authentication error:", error);
                showMessageBox(getFirebaseErrorMessage(error.code), 'error');
            }
        });

        // Toggle auth mode buttons
        loginToggleBtn.addEventListener('click', () => { authMode = 'login'; updateAuthFormUI(); });
        registerToggleBtn.addEventListener('click', () => { authMode = 'register'; updateAuthFormUI(); });

        // Main menu button
        menuBtn.addEventListener('click', openMainMenuModal);
        profileSummary.addEventListener('click', openMainMenuModal);
        closeMainMenuModalBtn.addEventListener('click', closeMainMenuModal);

        // Main menu navigation
        showProfileBtn.addEventListener('click', () => {
            mainMenuNav.classList.add('hidden');
            profileView.classList.remove('hidden');
            profileDisplayName.textContent = currentUserData.displayName;
            profileEmail.textContent = currentUserData.email;
            profileUid.textContent = currentUserData.uid;
            profileCoins.textContent = currentUserData.coins.toLocaleString('fa-IR');
        });

        backToMainMenuFromProfile.addEventListener('click', () => {
            profileView.classList.add('hidden');
            mainMenuNav.classList.remove('hidden');
        });

        showThemesBtn.addEventListener('click', () => {
            mainMenuNav.classList.add('hidden');
            themesView.classList.remove('hidden');
            populateThemeButtons(); // Ensure buttons are rendered/updated
        });

        backToMainMenuFromThemes.addEventListener('click', () => {
            themesView.classList.add('hidden');
            mainMenuNav.classList.remove('hidden');
        });

        // Logout
        mainMenuLogoutBtn.addEventListener('click', async () => {
            const confirmed = await showCustomConfirm("آیا مطمئن هستید که می‌خواهید از حساب خود خارج شوید؟", "خروج از حساب");
            if (!confirmed) return;

            try {
                if (userHasActiveLobby) {
                    await leaveCurrentLobby();
                }
                await firebase.auth().signOut();
                showMessageBox("با موفقیت از حساب خارج شدید.", "info");
                closeMainMenuModal();
                setActiveScreen(authScreen);
            } catch (error) {
                console.error("Error signing out:", error);
                showMessageBox("خطا در خروج از حساب.", "error");
            }
        });

        // Friendly game button
        friendlyGameBtn.addEventListener('click', () => { 
            if (!auth.currentUser) {
                showMessageBox("برای شروع بازی ابتدا وارد شوید.", "error");
                setActiveScreen(authScreen);
                return;
            }
            if (currentUserData.coins < gameEntryCost) {
                showMessageBox(`شما سکه کافی برای ورود به بازی دوستانه ندارید. (${gameEntryCost} سکه لازم است)`, "error");
                return;
            }
            setActiveScreen(lobbyScreen);
        });

        // Rated game button (placeholder)
        ratedGameBtn.addEventListener('click', () => {
            showMessageBox("بازی امتیازی به زودی...", "info");
        });

        // Back to main button (from lobby screen)
        backToMainBtn.addEventListener('click', () => setActiveScreen(mainScreen));

        // Create lobby button
        addIconBtn.addEventListener('click', () => {
            if (!auth.currentUser) {
                showMessageBox("برای ایجاد لابی ابتدا وارد شوید.", "error");
                setActiveScreen(authScreen);
                return;
            }
            showModal(createLobbyModal);
        });

        // Close create lobby modal
        closeCreateLobbyModalBtn.addEventListener('click', () => hideModal(createLobbyModal));

        // Lobby Type Toggle
        lobbyTypeToggle.addEventListener('change', (e) => {
            if (e.target.name === 'lobby-type') {
                if (e.target.value === 'private') {
                    newLobbyPasswordField.classList.remove('hidden');
                } else {
                    newLobbyPasswordField.classList.add('hidden');
                }
                // Update active class for buttons
                document.querySelectorAll('.lobby-type-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.target.nextElementSibling.classList.add('active');
            }
        });

        // Toggle password visibility
        togglePasswordVisibilityBtn.addEventListener('click', () => {
            const type = newLobbyPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            newLobbyPasswordInput.setAttribute('type', type);
            eyeIconOpen.style.display = type === 'password' ? 'block' : 'none';
            eyeIconClosed.style.display = type === 'text' ? 'block' : 'none';
        });

        // Create lobby form submission
        createLobbyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            createLobbyMessageBox.classList.add('hidden');

            // Get selected lobby name or proposed name
            const selectedName = approvedLobbyNamesSelect.value;
            const proposedName = proposedLobbyNameInput.value.trim();

            let lobbyName = '';
            if (selectedName) {
                lobbyName = selectedName;
            } else if (proposedName) {
                lobbyName = proposedName;
            } else {
                showCreateLobbyMessageBox("لطفا یک نام لابی انتخاب یا پیشنهاد دهید.", "error");
                return;
            }

            if (!lobbyName) {
                showCreateLobbyMessageBox("لطفا نام لابی را وارد کنید.", "error");
                return;
            }
            const lobbyType = document.querySelector('input[name="lobby-type"]:checked').value;
            const password = newLobbyPasswordInput.value;
            const gameDuration = parseInt(gameDurationInput.value);

            if (lobbyType === 'private' && password.length < 4) {
                showCreateLobbyMessageBox("رمز عبور لابی خصوصی باید حداقل 4 کاراکتر باشد.", "error");
                return;
            }
            if (isNaN(gameDuration) || gameDuration < 1 || gameDuration > 60) {
                showCreateLobbyMessageBox("مدت زمان بازی باید بین 1 تا 60 دقیقه باشد.", "error");
                return;
            }
            if (!currentUserData) {
                showCreateLobbyMessageBox("خطا: اطلاعات کاربری در دسترس نیست.", "error");
                return;
            }

            try {
                if (userHasActiveLobby) {
                    const confirmed = await showCustomConfirm("شما هم‌اکنون در یک لابی دیگر هستید. ایجاد لابی جدید باعث خروج شما از لابی فعلی و بسته شدن آن (اگر میزبان هستید) می‌شود. آیا ادامه می‌دهید؟", "لابی فعال");
                    if (!confirmed) return;
                    await leaveCurrentLobby();
                }

                const newLobbyId = await createLobby(lobbyName, auth.currentUser.uid, currentUserData.displayName, lobbyType, password, gameDuration);
                showCreateLobbyMessageBox("لابی با موفقیت ایجاد شد!", "success");
                hideModal(createLobbyModal);
                currentLobbyId = newLobbyId;
                userHasActiveLobby = true;
                setActiveScreen(lobbyDetailScreen);
                unsubscribeLobbyDetail = setupLobbyDetailListener(newLobbyId);

            } catch (error) {
                console.error("Error creating lobby:", error);
                showCreateLobbyMessageBox("خطا در ایجاد لابی. لطفاً دوباره تلاش کنید.", "error");
            }
        });

        // Refresh lobbies button
        refreshLobbiesBtn.addEventListener('click', () => {
            if (isRefreshing) return;
            isRefreshing = true;
            lobbiesList.innerHTML = '<p class="text-gray-400 text-center">در حال بروزرسانی لابی‌ها...</p>';
            if (unsubscribeLobbies) unsubscribeLobbies();
            unsubscribeLobbies = setupLobbyListener(lobbySearchInput.value);
            setTimeout(() => { isRefreshing = false; }, 1500); // Prevent rapid refreshing
        });

        // My lobbies button (placeholder)
        myLobbiesBtn.addEventListener('click', () => {
            if (!auth.currentUser) {
                showMessageBox("برای مشاهده لابی‌های خود، ابتدا وارد شوید.", "error");
                setActiveScreen(authScreen);
                return;
            }
            if (userHasActiveLobby && currentLobbyId) {
                setActiveScreen(lobbyDetailScreen);
                unsubscribeLobbyDetail = setupLobbyDetailListener(currentLobbyId);
            } else {
                showMessageBox("شما در حال حاضر در هیچ لابی فعالی نیستید.", "info");
            }
        });
        
        // Kicked Message Modal handler
        kickedMessageOkBtn.addEventListener('click', () => {
            hideModal(kickedMessageModal);
        });

        // Close Kicked Players List Modal handler
        closeKickedPlayersListModalBtn.addEventListener('click', () => {
            hideModal(kickedPlayersListModal);
        });
        kickedListOkBtn.addEventListener('click', () => {
            hideModal(kickedPlayersListModal);
        });

        // Enter Password Modal handlers
        cancelJoinPasswordBtn.addEventListener('click', () => {
            hideModal(enterPasswordModal);
            passwordPromptMessageBox.classList.add('hidden');
            enterPasswordForm.reset();
        });

        enterPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            passwordPromptMessageBox.classList.add('hidden');
            const password = joinLobbyPasswordInput.value;
            if (lobbyToJoin && lobbyToJoin.id) {
                await joinLobby(lobbyToJoin.id, password);
            }
        });

        // Search lobbies
        searchLobbiesBtn.addEventListener('click', () => {
            if (unsubscribeLobbies) unsubscribeLobbies();
            unsubscribeLobbies = setupLobbyListener(lobbySearchInput.value);
        });

        lobbySearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (unsubscribeLobbies) unsubscribeLobbies();
                unsubscribeLobbies = setupLobbyListener(lobbySearchInput.value);
            }
        });

        // --- NEW: Lobby Name Proposal & Management ---
        // Function to fetch and display pending/approved lobby names
        async function fetchUserLobbyNames() {
            if (!auth.currentUser || !currentUserData) return;

            // Clear previous lists
            pendingLobbyNamesList.innerHTML = '<p class="text-sm text-center text-gray-400">هیچ نام لابی در انتظار تایید ندارید.</p>';
            approvedLobbyNamesManagementList.innerHTML = '<p class="text-sm text-center text-gray-400">هیچ نام لابی تأیید شده‌ای ندارید.</p>';
            approvedLobbyNamesSelect.innerHTML = '<option value="">نام لابی را انتخاب کنید</option>';

            // Populate approved names for selection and management
            if (currentUserData.approvedLobbyNames && currentUserData.approvedLobbyNames.length > 0) {
                let approvedListHtml = '';
                currentUserData.approvedLobbyNames.forEach(name => {
                    approvedLobbyNamesSelect.innerHTML += `<option value="${name}">${name}</option>`;
                    approvedListHtml += `
                        <div class="flex justify-between items-center bg-gray-700 p-2 rounded">
                            <span class="text-sm">${formatLobbyNameWithColor(name)}</span>
                            <button class="text-red-400 hover:text-red-600 delete-approved-name-btn" data-name="${name}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>
                    `;
                });
                approvedLobbyNamesManagementList.innerHTML = approvedListHtml;
                document.querySelectorAll('.delete-approved-name-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => deleteApprovedLobbyName(e.currentTarget.dataset.name));
                });
            }

            // Fetch pending names
            if (unsubscribePendingLobbyNames) unsubscribePendingLobbyNames();
            const pendingNamesRef = db.collection('name_proposals')
                .where('userId', '==', auth.currentUser.uid)
                .where('status', '==', 'pending');
            
            unsubscribePendingLobbyNames = pendingNamesRef.onSnapshot(snapshot => {
                if (snapshot.empty) {
                    pendingLobbyNamesList.innerHTML = '<p class="text-sm text-center text-gray-400">هیچ نام لابی در انتظار تایید ندارید.</p>';
                    return;
                }

                let pendingListHtml = '';
                snapshot.docs.forEach(doc => {
                    const proposal = doc.data();
                    pendingListHtml += `
                        <div class="flex justify-between items-center bg-yellow-700 p-2 rounded">
                            <span class="text-sm">${formatLobbyNameWithColor(proposal.name)}</span>
                            <span class="text-xs text-yellow-200">در انتظار تایید</span>
                        </div>
                    `;
                });
                pendingLobbyNamesList.innerHTML = pendingListHtml;
            }, error => {
                console.error("Error fetching pending lobby names:", error);
                pendingLobbyNamesList.innerHTML = '<p class="text-sm text-center text-red-400">خطا در بارگذاری نام‌های در انتظار.</p>';
            });
        }

        // Show/hide relevant sections in create lobby modal
        approvedLobbyNamesSelect.addEventListener('change', () => {
            if (approvedLobbyNamesSelect.value) {
                lobbyNameProposalArea.classList.add('hidden');
                submitCreateLobbyBtn.disabled = false;
                createLobbyModalTitle.textContent = "ساخت لابی جدید";
            } else {
                lobbyNameProposalArea.classList.remove('hidden');
                // Disable create button until a proposal is submitted or selected
                submitCreateLobbyBtn.disabled = true;
                createLobbyModalTitle.textContent = "پیشنهاد یا انتخاب نام لابی";
            }
        });

        // Handle lobby name proposal submission
        submitLobbyNameForApprovalBtn.addEventListener('click', async () => {
            const proposedName = proposedLobbyNameInput.value.trim();
            if (!proposedName) {
                showCreateLobbyMessageBox("لطفا نام لابی را برای پیشنهاد وارد کنید.", "error");
                return;
            }
            if (!auth.currentUser || !currentUserData) {
                showCreateLobbyMessageBox("خطا: اطلاعات کاربری در دسترس نیست.", "error");
                return;
            }

            try {
                // Check current pending proposals count
                const pendingSnapshot = await db.collection('name_proposals')
                    .where('userId', '==', auth.currentUser.uid)
                    .where('status', '==', 'pending')
                    .get();

                if (pendingSnapshot.size >= MAX_PENDING_PROPOSALS) {
                    showCreateLobbyMessageBox(`شما نمی‌توانید بیش از ${MAX_PENDING_PROPOSALS} نام لابی در انتظار تأیید داشته باشید.`, "error");
                    return;
                }

                // Check if name already exists (pending or approved by anyone)
                const existingNameCheck = await db.collection('name_proposals')
                    .where('name', '==', proposedName)
                    .get();
                if (!existingNameCheck.empty) {
                    showCreateLobbyMessageBox("این نام لابی قبلا پیشنهاد شده یا در حال حاضر موجود است.", "error");
                    return;
                }

                // AI Moderation (placeholder)
                const aiCheck = await checkLobbyNameWithAI(proposedName);
                if (!aiCheck.is_appropriate) {
                    showCreateLobbyMessageBox(`نام لابی نامناسب است: ${aiCheck.reason}`, "error");
                    return;
                }

                await db.collection('name_proposals').add({
                    name: proposedName,
                    userId: auth.currentUser.uid,
                    displayName: currentUserData.displayName,
                    status: 'pending', // 'pending', 'approved', 'rejected'
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showCreateLobbyMessageBox("نام لابی با موفقیت برای تأیید ارسال شد.", "success");
                proposedLobbyNameInput.value = ''; // Clear input
                submitCreateLobbyBtn.disabled = false; // Allow creation if user wants to use it once approved
            } catch (error) {
                console.error("Error submitting lobby name for approval:", error);
                showCreateLobbyMessageBox("خطا در ارسال نام لابی برای تأیید.", "error");
            }
        });

        async function deleteApprovedLobbyName(nameToDelete) {
            const confirmed = await showCustomConfirm(`آیا مطمئن هستید که می‌خواهید نام "${nameToDelete}" را حذف کنید؟`, "حذف نام لابی");
            if (!confirmed) return;

            try {
                // Remove from user's profile
                const userProfileRef = db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/profile/data`);
                await userProfileRef.update({
                    approvedLobbyNames: firebase.firestore.FieldValue.arrayRemove(nameToDelete)
                });

                // Delete the proposal document itself
                const proposalQuery = await db.collection('name_proposals')
                    .where('name', '==', nameToDelete)
                    .where('userId', '==', auth.currentUser.uid)
                    .where('status', '==', 'approved')
                    .limit(1)
                    .get();
                
                if (!proposalQuery.empty) {
                    await proposalQuery.docs[0].ref.delete();
                }

                showCreateLobbyMessageBox("نام لابی با موفقیت حذف شد.", "success");
                fetchUserLobbyNames(); // Re-fetch to update UI
            } catch (error) {
                console.error("Error deleting approved lobby name:", error);
                showCreateLobbyMessageBox("خطا در حذف نام لابی.", "error");
            }
        }
        
        // This makes sure fetchUserLobbyNames is called when the create lobby modal is opened
        createLobbyModal.addEventListener('transitionend', (event) => {
            if (!createLobbyModal.classList.contains('hidden')) {
                fetchUserLobbyNames();
                // Show default proposal area if no approved names are selected
                if (!approvedLobbyNamesSelect.value) {
                    lobbyNameProposalArea.classList.remove('hidden');
                    approvedLobbyNamesSelectionArea.classList.remove('hidden');
                    submitCreateLobbyBtn.disabled = true; // Initially disabled
                }
            }
        });

        // Initialize UI on load
        document.addEventListener('DOMContentLoaded', () => {
            initializeAuthScreen(); // Set up initial auth screen state
        });
    </script>
</body>
</html>