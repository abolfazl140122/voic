<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§ÙÛŒØ§ ÙÚ©Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Vazirmatn', sans-serif;
            user-select: none;
        }

        /* --- Themes --- */
        body.theme-dark { background: linear-gradient(135deg, #000000, #1a1a1a, #2c2c2c); }
        body.theme-godfather { background: linear-gradient(135deg, #260d0d, #4d1a1a, #732626); }
        body.theme-classic { background: linear-gradient(135deg, #1d2b3a, #3c566e, #5a81a2); }

        .fade-in { animation: fadeIn 0.8s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-up { animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .gold-glow { text-shadow: 0 0 15px #ffd700, 0 0 30px #ffd700; }
        
        .glass-effect { background: rgba(0, 0, 0, 0.35); backdrop-filter: blur(12px); border: 1px solid rgba(255, 215, 0, 0.2); }
        
        .button-hover:not(:disabled) { transition: all 0.2s ease; }
        .button-hover:not(:disabled):hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3); }
        .button-hover:active:not(:disabled) { transform: translateY(-1px) scale(1.01); }
        .button-hover:disabled { opacity: 0.5; cursor: not-allowed; }

        .word-slot { min-height: 55px; width: 45px; border: 2px dashed #ffd700; transition: all 0.2s ease; background: #0000004d; }
        .word-slot.filled { border-style: solid; background: linear-gradient(145deg, #ffd700, #ffed4e); color: #000; box-shadow: 0 0 15px #ffd70080; }
        .word-slot.drag-over { background-color: #ffd70033; transform: scale(1.1); }
        
        .word-card { cursor: grab; transition: all 0.2s ease; background: #2a2a2a; border: 1px solid #ffd700; }
        .word-card:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 15px rgba(255, 215, 0, 0.2); background: linear-gradient(145deg, #ffd700, #ffed4e); color: #000; }
        .word-card.dragging { opacity: 0.4; transform: rotate(8deg) scale(1.1); }
        .word-card.hidden-card { opacity: 0; pointer-events: none; }
        
        .avatar-select { border: 3px solid transparent; transition: all 0.2s ease; }
        .avatar-select.selected { border-color: #ffd700; box-shadow: 0 0 20px #ffd700; transform: scale(1.1); }
        
        .screen {
            position: fixed;
            inset: 0;
            display: none; /* Use 'flex' or 'block' to show */
            padding: 1rem;
            animation: fadeIn 0.5s ease;
        }
        .screen.active {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="min-h-screen text-white transition-all duration-500">

    <!-- Audio Elements -->
    <audio id="sound-click" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>
    <audio id="sound-success" src="https://www.soundjay.com/misc/sounds/coins-in-hand-2.mp3" preload="auto"></audio>
    <audio id="sound-error" src="https://www.soundjay.com/buttons/sounds/button-10.mp3" preload="auto"></audio>
    <audio id="sound-buy" src="https://www.soundjay.com/misc/sounds/cash-register-02.mp3" preload="auto"></audio>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="screen active items-center justify-center">
        <h1 class="text-6xl font-bold mb-6 text-yellow-400 gold-glow">Ù…Ø§ÙÛŒØ§ ÙÚ©Øª</h1>
        <div class="w-16 h-16 border-4 border-gray-700 border-t-yellow-400 rounded-full animate-spin"></div>
        <p class="mt-4 text-yellow-300">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
    </div>

    <!-- Registration Screen -->
    <div id="registrationScreen" class="screen items-center justify-center">
        <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-auto slide-up">
            <h2 class="text-3xl font-bold text-center text-yellow-400 mb-6">Ø«Ø¨Øª Ù†Ø§Ù…</h2>
            <input type="text" id="usernameInput" class="w-full px-5 py-3 rounded-xl bg-black/50 border-2 border-yellow-400/50 text-yellow-100 placeholder-yellow-300/60 focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
            <button id="registerBtn" class="mt-6 w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 rounded-xl button-hover">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</button>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="screen items-center justify-center">
        <div class="absolute top-4 right-4 glass-effect rounded-lg px-4 py-2 flex items-center space-x-2 space-x-reverse">
            <span class="text-2xl">ğŸ’°</span>
            <span id="goldDisplay" class="text-xl font-bold text-yellow-400">0</span>
        </div>
        <div class="text-center">
            <img id="mainMenuAvatar" src="" class="w-28 h-28 rounded-full mx-auto mb-4 border-4 border-yellow-400">
            <h1 id="mainMenuUsername" class="text-3xl font-bold text-white mb-10"></h1>
            <button data-target="gameScreen" class="nav-btn w-64 bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-4 rounded-xl text-xl mb-4 button-hover">ğŸ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
            <div class="grid grid-cols-2 gap-4 w-64 mx-auto">
                <button data-target="profileScreen" class="nav-btn glass-effect text-yellow-300 py-3 rounded-xl button-hover">ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
                <button data-target="shopScreen" class="nav-btn glass-effect text-yellow-300 py-3 rounded-xl button-hover">ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</button>
            </div>
        </div>
    </div>
    
    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <header class="flex justify-between items-center mb-4">
            <button data-target="mainMenu" class="nav-btn glass-effect px-4 py-2 rounded-lg button-hover">â† Ù…Ù†Ùˆ</button>
            <div class="text-center glass-effect rounded-lg px-4 py-1">
                <h2 class="font-bold text-yellow-400">Ù…Ø±Ø­Ù„Ù‡ <span id="currentLevel">1</span></h2>
            </div>
            <div class="flex items-center space-x-2 space-x-reverse glass-effect rounded-lg px-3 py-1">
                <span class="text-lg">ğŸ’°</span>
                <span id="gameGoldDisplay" class="font-bold text-yellow-400">0</span>
            </div>
        </header>
        <main class="max-w-4xl mx-auto w-full">
            <div class="glass-effect rounded-xl p-3 mb-4 slide-up">
                <h3 class="text-base font-bold text-yellow-400 mb-3 text-center">ğŸ¯ Ú©Ù„Ù…Ù‡ Ù…Ø®ÙÛŒ Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯</h3>
                <div id="wordSlots" class="flex justify-center flex-wrap gap-2 mb-3"></div>
                <p class="text-center text-yellow-300 text-xs">ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ: <span id="hint" class="text-yellow-100 font-medium"></span></p>
            </div>
            <div class="glass-effect rounded-xl p-3 mb-4 slide-up">
                <div id="wordCards" class="grid grid-cols-5 md:grid-cols-8 gap-2"></div>
            </div>
            <div class="flex justify-center gap-4 mt-4">
                <button id="hintBtn" class="glass-effect text-yellow-300 py-3 px-6 rounded-xl button-hover flex items-center gap-2">ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ (<span id="hintCount">0</span>)</button>
                <button id="resetLevelBtn" class="glass-effect text-yellow-300 py-3 px-6 rounded-xl button-hover">â†» Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
            </div>
        </main>
    </div>

    <!-- Profile Screen -->
    <div id="profileScreen" class="screen items-center">
        <button data-target="mainMenu" class="nav-btn absolute top-4 left-4 glass-effect px-4 py-2 rounded-lg button-hover">â† Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <div class="glass-effect p-6 rounded-2xl w-full max-w-md slide-up">
            <h2 class="text-3xl font-bold text-center text-yellow-400 mb-6">ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h2>
            <div id="avatarSelection" class="grid grid-cols-4 gap-4 mb-6"></div>
            <div class="text-center space-y-2">
                <p class="text-lg">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: <span id="profileUsername" class="font-bold text-yellow-300"></span></p>
                <p class="text-lg">Ù…Ø±Ø­Ù„Ù‡ ÙØ¹Ù„ÛŒ: <span id="profileLevel" class="font-bold text-yellow-300"></span></p>
                <p class="text-lg">ØªØ¹Ø¯Ø§Ø¯ Ø·Ù„Ø§: <span id="profileGold" class="font-bold text-yellow-300"></span></p>
                <p class="text-lg">Ú©Ù„Ù…Ø§Øª Ø­Ù„ Ø´Ø¯Ù‡: <span id="profileWords" class="font-bold text-yellow-300"></span></p>
            </div>
             <button id="clearDataBtn" class="mt-8 w-full bg-red-800/60 hover:bg-red-700/70 text-red-200 font-medium py-3 px-6 rounded-xl button-hover">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
        </div>
    </div>
    
    <!-- Shop Screen -->
    <div id="shopScreen" class="screen items-center">
        <button data-target="mainMenu" class="nav-btn absolute top-4 left-4 glass-effect px-4 py-2 rounded-lg button-hover">â† Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <div class="glass-effect p-6 rounded-2xl w-full max-w-lg slide-up">
            <h2 class="text-3xl font-bold text-center text-yellow-400 mb-6">ğŸ›’ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</h2>
            <div class="space-y-6">
                <div>
                    <h3 class="text-xl text-yellow-300 mb-2">Ø®Ø±ÛŒØ¯ Ø¢ÛŒØªÙ…</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="buyHintBtn" class="glass-effect p-4 rounded-xl button-hover text-center">
                            <p class="text-lg">ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ</p>
                            <p class="text-yellow-400 font-bold">ğŸ’° 25 Ø·Ù„Ø§</p>
                        </button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl text-yellow-300 mb-2">ØªØºÛŒÛŒØ± ØªÙ…</h3>
                    <div id="themeSelection" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modalContainer" class="fixed inset-0 bg-black/70 items-center justify-center z-50 hidden">
        <div id="genericModal" class="glass-effect rounded-2xl p-8 max-w-sm w-full mx-4 text-center slide-up hidden">
            <h3 id="modalTitle" class="text-2xl font-bold text-yellow-400 mb-4"></h3>
            <p id="modalText" class="text-yellow-100 mb-6 whitespace-pre-wrap"></p>
            <button id="modalBtn" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-8 rounded-xl button-hover">Ø¨Ø§Ø´Ù‡</button>
        </div>
        <div id="dailyRewardModal" class="glass-effect rounded-2xl p-8 max-w-sm w-full mx-4 text-center slide-up hidden">
            <h3 class="text-2xl font-bold text-yellow-400 mb-4">ğŸ Ù¾Ø§Ø¯Ø§Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡!</h3>
            <p class="text-yellow-100 mb-6">Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø§Ù…Ø±ÙˆØ²ØŒ ğŸ’° 50 Ø·Ù„Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒØ¯!</p>
            <button id="claimDailyRewardBtn" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-8 rounded-xl button-hover">Ø¹Ø§Ù„ÛŒÙ‡!</button>
        </div>
        <div id="tutorialOverlay" class="glass-effect rounded-2xl p-8 max-w-lg w-full text-center slide-up hidden">
            <h3 class="text-3xl font-bold text-yellow-400 mb-4">âœ¨ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h3>
            <p class="text-yellow-100 text-lg mb-6">Ø­Ø±ÙˆÙ Ø±Ø§ Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† Ø¨Ù‡ Ø¬Ø§ÛŒÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ù„Ø§ Ø¨Ú©Ø´ÛŒØ¯ ØªØ§ Ú©Ù„Ù…Ù‡ Ù…Ø®ÙÛŒ Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯.</p>
            <button id="tutorialConfirmBtn" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-10 rounded-xl button-hover">ÙÙ‡Ù…ÛŒØ¯Ù…!</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DATA & CONFIG ---
            const
                DB_KEY = 'mafiaFactUser_v2',
                HINT_COST = 25,
                THEME_COST = 200,
                DAILY_REWARD = 50,
                WIN_REWARD = 10;

            const levels = [
                { word: 'Ù…Ø§ÙÛŒØ§', hint: 'Ø³Ø§Ø²Ù…Ø§Ù† Ù…Ø®ÙÛŒ Ø¬Ù†Ø§ÛŒØªÚ©Ø§Ø±' }, { word: 'Ø¬Ù†Ø§ÛŒØª', hint: 'Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ù†ÙˆÙ†ÛŒ' },
                { word: 'Ù…Ø®ÙÛŒ', hint: 'Ù¾Ù†Ù‡Ø§Ù† Ùˆ Ù†Ø§Ù…Ø¹Ù„ÙˆÙ…' }, { word: 'Ø±Ø¦ÛŒØ³', hint: 'Ø±Ù‡Ø¨Ø± Ú¯Ø±ÙˆÙ‡' },
                { word: 'Ù…Ø­Ø±Ù…Ø§Ù†Ù‡', hint: 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø±ÛŒ' }, { word: 'Ù¾Ù„ÛŒØ³', hint: 'Ù†ÛŒØ±ÙˆÛŒ Ø§Ù†ØªØ¸Ø§Ù…ÛŒ' },
                { word: 'Ø¨Ø§Ø²Ø¬Ùˆ', hint: 'Ú©Ø³ÛŒ Ú©Ù‡ Ø³ÙˆØ§Ù„ Ù…ÛŒâ€ŒÙ¾Ø±Ø³Ø¯' }, { word: 'Ø®ÛŒØ§Ù†Øª', hint: 'Ù†Ù‚Ø¶ Ù¾ÛŒÙ…Ø§Ù† Ùˆ ÙˆÙØ§Ø¯Ø§Ø±ÛŒ' },
                { word: 'Ø§Ø³Ù„Ø­Ù‡', hint: 'ÙˆØ³ÛŒÙ„Ù‡ Ø¬Ù†Ú¯ÛŒ' }, { word: 'Ù‚Ø§Ú†Ø§Ù‚', hint: 'ØªØ¬Ø§Ø±Øª ØºÛŒØ±Ù‚Ø§Ù†ÙˆÙ†ÛŒ' },
                { word: 'Ø²Ù†Ø¯Ø§Ù†', hint: 'Ù…Ø­Ù„ Ø­Ø¨Ø³ Ù…Ø¬Ø±Ù…Ø§Ù†' }, { word: 'ÙˆÚ©ÛŒÙ„', hint: 'Ù…Ø¯Ø§ÙØ¹ Ø¯Ø± Ø¯Ø§Ø¯Ú¯Ø§Ù‡' },
                { word: 'Ø¯Ø§Ø¯Ú¯Ø§Ù‡', hint: 'Ù…Ø­Ù„ Ù‚Ø¶Ø§ÙˆØª' }, { word: 'Ø´Ø§Ù‡Ø¯', hint: 'Ø¨ÛŒÙ†Ù†Ø¯Ù‡ ÛŒÚ© Ø±ÙˆÛŒØ¯Ø§Ø¯' },
                { word: 'Ù…ØªÙ‡Ù…', hint: 'Ù…Ø¸Ù†ÙˆÙ† Ø¨Ù‡ Ø¬Ø±Ù…' }, { word: 'ÙˆØ«ÛŒÙ‚Ù‡', hint: 'Ø¶Ù…Ø§Ù†Øª Ù…Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¢Ø²Ø§Ø¯ÛŒ' },
                { word: 'Ú©Ø§Ø±Ø§Ú¯Ø§Ù‡', hint: 'Ù…Ø­Ù‚Ù‚ Ø®ØµÙˆØµÛŒ' }, { word: 'Ù…Ø§Ù…ÙˆØ±', hint: 'Ø¹Ø¶Ùˆ Ù†ÛŒØ±ÙˆÛŒ Ø¯ÙˆÙ„ØªÛŒ' },
                { word: 'Ø³Ø±Ù‚Øª', hint: 'Ø¯Ø²Ø¯ÛŒ' }, { word: 'Ú¯Ø±ÙˆÚ¯Ø§Ù†', hint: 'ÙØ±Ø¯ÛŒ Ú©Ù‡ Ø¨Ù‡ Ø§Ø³Ø§Ø±Øª Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡' }
            ];
            
            const avatars = {
                'avatar1': 'https://api.dicebear.com/7.x/adventurer/svg?seed=Felix',
                'avatar2': 'https://api.dicebear.com/7.x/adventurer/svg?seed=Mimi',
                'avatar3': 'https://api.dicebear.com/7.x/adventurer/svg?seed=Leo',
                'avatar4': 'https://api.dicebear.com/7.x/adventurer/svg?seed=Zoe'
            };

            const themes = {
                'theme-dark': { name: 'ØªØ§Ø±ÛŒÚ©', cost: 0 },
                'theme-godfather': { name: 'Ù¾Ø¯Ø±Ø®ÙˆØ§Ù†Ø¯Ù‡', cost: THEME_COST },
                'theme-classic': { name: 'Ú©Ù„Ø§Ø³ÛŒÚ©', cost: THEME_COST }
            };

            // --- STATE ---
            let currentUser = null;
            let currentLevel;
            let draggedCardId = null;

            // --- DOM ELEMENTS ---
            const allScreens = document.querySelectorAll('.screen');
            const goldDisplays = {
                main: document.getElementById('goldDisplay'),
                game: document.getElementById('gameGoldDisplay'),
                profile: document.getElementById('profileGold')
            };
            const modalContainer = document.getElementById('modalContainer');
            const genericModal = document.getElementById('genericModal');
            const dailyRewardModal = document.getElementById('dailyRewardModal');
            const tutorialOverlay = document.getElementById('tutorialOverlay');

            // --- SOUND ENGINE ---
            const sounds = {
                click: document.getElementById('sound-click'),
                success: document.getElementById('sound-success'),
                error: document.getElementById('sound-error'),
                buy: document.getElementById('sound-buy')
            };
            function playSound(soundId) {
                if (sounds[soundId]) {
                    sounds[soundId].currentTime = 0;
                    sounds[soundId].play().catch(e => console.log("Audio play failed:", e));
                }
            }
            
            // --- CORE FUNCTIONS ---
            function saveUser() {
                localStorage.setItem(DB_KEY, JSON.stringify(currentUser));
            }

            function loadUser() {
                const data = localStorage.getItem(DB_KEY);
                if (data) {
                    currentUser = JSON.parse(data);
                    // Ensure all properties exist for users from older versions
                    currentUser.stats = currentUser.stats || { words: 0 };
                    currentUser.hints = currentUser.hints === undefined ? 1 : currentUser.hints;
                    currentUser.ownedThemes = currentUser.ownedThemes || ['theme-dark'];
                    currentUser.activeTheme = currentUser.activeTheme || 'theme-dark';
                    return true;
                }
                return false;
            }

            function createUser(username) {
                currentUser = {
                    username: username,
                    levelIndex: 0,
                    gold: 50,
                    avatarId: 'avatar1',
                    hasSeenTutorial: false,
                    lastLoginDate: null,
                    hints: 1,
                    ownedThemes: ['theme-dark'],
                    activeTheme: 'theme-dark',
                    stats: { words: 0 }
                };
                saveUser();
            }

            // --- UI & NAVIGATION ---
            function navigateTo(screenId) {
                playSound('click');
                allScreens.forEach(s => s.classList.remove('active'));
                document.getElementById(screenId)?.classList.add('active');
                if (screenId === 'profileScreen') populateProfile();
                if (screenId === 'shopScreen') populateShop();
            }
            
            function showModal(title, text, btnText = 'Ø¨Ø§Ø´Ù‡', onConfirm = null) {
                modalContainer.style.display = 'flex';
                genericModal.style.display = 'block';
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalText').textContent = text;
                const modalBtn = document.getElementById('modalBtn');
                modalBtn.textContent = btnText;
                
                const newBtn = modalBtn.cloneNode(true);
                modalBtn.parentNode.replaceChild(newBtn, modalBtn);
                
                newBtn.onclick = () => {
                    playSound('click');
                    modalContainer.style.display = 'none';
                    genericModal.style.display = 'none';
                    if (onConfirm) onConfirm();
                };
            }

            function updateGoldUI() {
                const gold = currentUser.gold;
                goldDisplays.main.textContent = gold;
                goldDisplays.game.textContent = gold;
                if(document.getElementById('profileScreen').classList.contains('active')) {
                    goldDisplays.profile.textContent = gold;
                }
            }
            
            function applyTheme(themeId) {
                document.body.className = 'min-h-screen text-white transition-all duration-500'; // Reset
                document.body.classList.add(themeId);
            }

            // --- INITIALIZATION ---
            function init() {
                if (loadUser()) {
                    applyTheme(currentUser.activeTheme);
                    updateGoldUI();
                    document.getElementById('mainMenuUsername').textContent = currentUser.username;
                    document.getElementById('mainMenuAvatar').src = avatars[currentUser.avatarId];
                    navigateTo('mainMenu');
                    checkDailyReward();
                } else {
                    navigateTo('registrationScreen');
                }
                document.getElementById('loadingScreen').classList.remove('active');
            }
            
            function checkDailyReward() {
                const today = new Date().toISOString().split('T')[0];
                if (currentUser.lastLoginDate !== today) {
                    modalContainer.style.display = 'flex';
                    dailyRewardModal.style.display = 'block';
                    currentUser.lastLoginDate = today;
                    currentUser.gold += DAILY_REWARD;
                    playSound('success');
                    updateGoldUI();
                    saveUser();
                }
            }

            // --- GAME LOGIC ---
            function setupLevel() {
                if (currentUser.levelIndex >= levels.length) {
                    showModal('Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ!', 'Ø´Ù…Ø§ ØªÙ…Ø§Ù… Ù…Ø±Ø§Ø­Ù„ Ø±Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³Ø§Ù†Ø¯ÛŒØ¯!', 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†Ùˆ', () => navigateTo('mainMenu'));
                    return;
                }
                currentLevel = levels[currentUser.levelIndex];
                
                document.getElementById('currentLevel').textContent = currentUser.levelIndex + 1;
                document.getElementById('hint').textContent = currentLevel.hint;
                document.getElementById('hintCount').textContent = currentUser.hints;
                
                const wordSlots = document.getElementById('wordSlots');
                const wordCards = document.getElementById('wordCards');
                wordSlots.innerHTML = '';
                wordCards.innerHTML = '';

                currentLevel.word.split('').forEach((_, i) => {
                    const slot = document.createElement('div');
                    slot.className = 'word-slot rounded-lg flex items-center justify-center text-2xl font-bold';
                    slot.dataset.index = i;
                    wordSlots.appendChild(slot);
                });

                const letters = [...currentLevel.word].sort(() => Math.random() - 0.5);
                letters.forEach((letter, i) => {
                    const card = document.createElement('div');
                    card.className = 'word-card p-3 rounded-lg text-center text-2xl font-bold';
                    card.id = `card-${i}`;
                    card.textContent = letter;
                    card.draggable = true;
                    wordCards.appendChild(card);
                });
                
                addDragDropListeners();

                if (!currentUser.hasSeenTutorial) {
                    modalContainer.style.display = 'flex';
                    tutorialOverlay.style.display = 'block';
                }
            }
            
            function addDragDropListeners() {
                document.querySelectorAll('.word-card').forEach(card => {
                    card.addEventListener('dragstart', e => {
                        draggedCardId = e.target.id;
                        setTimeout(() => card.classList.add('dragging'), 0);
                    });
                    card.addEventListener('dragend', () => card.classList.remove('dragging'));
                });

                document.querySelectorAll('.word-slot').forEach(slot => {
                    slot.addEventListener('dragover', e => { e.preventDefault(); if (!slot.textContent) slot.classList.add('drag-over'); });
                    slot.addEventListener('dragleave', () => slot.classList.remove('drag-over'));
                    slot.addEventListener('drop', e => {
                        e.preventDefault();
                        slot.classList.remove('drag-over');
                        if (slot.textContent) return;
                        
                        const card = document.getElementById(draggedCardId);
                        if (card) {
                            slot.textContent = card.textContent;
                            slot.classList.add('filled');
                            slot.dataset.cardId = draggedCardId;
                            card.classList.add('hidden-card');
                            playSound('click');
                            checkAnswer();
                        }
                    });
                    slot.addEventListener('click', () => {
                        if (slot.dataset.cardId) {
                            const card = document.getElementById(slot.dataset.cardId);
                            if (card) card.classList.remove('hidden-card');
                            slot.textContent = '';
                            slot.classList.remove('filled');
                            delete slot.dataset.cardId;
                            playSound('click');
                        }
                    });
                });
            }

            function checkAnswer() {
                const slots = document.querySelectorAll('.word-slot');
                if ([...slots].some(s => !s.textContent)) return; // Not fully filled
                
                const constructedWord = [...slots].map(s => s.textContent).join('');
                if (constructedWord === currentLevel.word) {
                    playSound('success');
                    currentUser.gold += WIN_REWARD;
                    currentUser.levelIndex++;
                    currentUser.stats.words++;
                    updateGoldUI();
                    saveUser();
                    showModal('Ø¹Ø§Ù„ÛŒ Ø¨ÙˆØ¯!', `Ú©Ù„Ù…Ù‡ Ø±Ø§ Ø¯Ø±Ø³Øª Ø­Ø¯Ø³ Ø²Ø¯ÛŒØ¯.\n+${WIN_REWARD} Ø·Ù„Ø§ ğŸ’°`, 'Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯', setupLevel);
                } else {
                    playSound('error');
                    showModal('Ø§Ø´ØªØ¨Ø§Ù‡ Ø¨ÙˆØ¯!', 'Ú©Ù„Ù…Ù‡ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                }
            }
            
            function useHint() {
                playSound('click');
                if (currentUser.hints <= 0) {
                    showModal('Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!', 'Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¨ÛŒØ´ØªØ±ØŒ Ø§Ø² ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø®Ø±ÛŒØ¯ Ú©Ù†ÛŒØ¯.');
                    return;
                }
                const slots = document.querySelectorAll('.word-slot');
                const emptySlots = [...slots].filter(s => !s.textContent);
                if (emptySlots.length === 0) return;
                
                const targetSlot = emptySlots[0];
                const correctLetter = currentLevel.word[targetSlot.dataset.index];

                const availableCard = [...document.querySelectorAll('.word-card:not(.hidden-card)')].find(c => c.textContent === correctLetter);
                if (availableCard) {
                    currentUser.hints--;
                    document.getElementById('hintCount').textContent = currentUser.hints;
                    targetSlot.textContent = correctLetter;
                    targetSlot.classList.add('filled');
                    targetSlot.dataset.cardId = availableCard.id; // Mark which card was used
                    availableCard.classList.add('hidden-card');
                    saveUser();
                    checkAnswer();
                }
            }

            // --- PROFILE & SHOP LOGIC ---
            function populateProfile() {
                document.getElementById('profileUsername').textContent = currentUser.username;
                document.getElementById('profileLevel').textContent = currentUser.levelIndex + 1;
                document.getElementById('profileGold').textContent = currentUser.gold;
                document.getElementById('profileWords').textContent = currentUser.stats.words;
                
                const avatarContainer = document.getElementById('avatarSelection');
                avatarContainer.innerHTML = '';
                Object.entries(avatars).forEach(([id, url]) => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'w-16 h-16 rounded-full cursor-pointer avatar-select';
                    if (id === currentUser.avatarId) img.classList.add('selected');
                    img.onclick = () => {
                        playSound('click');
                        currentUser.avatarId = id;
                        document.querySelector('.avatar-select.selected').classList.remove('selected');
                        img.classList.add('selected');
                        document.getElementById('mainMenuAvatar').src = url;
                        saveUser();
                    };
                    avatarContainer.appendChild(img);
                });
            }
            
            function populateShop() {
                document.getElementById('buyHintBtn').onclick = () => {
                    playSound('click');
                    if (currentUser.gold >= HINT_COST) {
                        currentUser.gold -= HINT_COST;
                        currentUser.hints++;
                        playSound('buy');
                        updateGoldUI();
                        saveUser();
                        showModal('Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ²!', 'ÛŒÚ© Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¨Ù‡ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.');
                    } else {
                        playSound('error');
                        showModal('Ø®Ø·Ø§!', 'Ø·Ù„Ø§ÛŒ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.');
                    }
                };

                const themeContainer = document.getElementById('themeSelection');
                themeContainer.innerHTML = '';
                Object.entries(themes).forEach(([id, data]) => {
                    const owned = currentUser.ownedThemes.includes(id);
                    const active = currentUser.activeTheme === id;
                    
                    const btn = document.createElement('button');
                    btn.className = 'glass-effect p-4 rounded-xl button-hover flex flex-col items-center justify-center';
                    btn.innerHTML = `
                        <p class="text-lg">${data.name}</p>
                        <p class="text-yellow-400 font-bold">${active ? 'ÙØ¹Ø§Ù„' : (owned ? 'Ø§Ù†ØªØ®Ø§Ø¨' : `ğŸ’° ${data.cost}`)}</p>
                    `;
                    btn.disabled = active;
                    btn.onclick = () => {
                        playSound('click');
                        if (owned) {
                            currentUser.activeTheme = id;
                            applyTheme(id);
                            saveUser();
                            populateShop(); // Refresh shop UI
                        } else {
                            if (currentUser.gold >= data.cost) {
                                currentUser.gold -= data.cost;
                                currentUser.ownedThemes.push(id);
                                currentUser.activeTheme = id;
                                playSound('buy');
                                applyTheme(id);
                                updateGoldUI();
                                saveUser();
                                populateShop(); // Refresh shop UI
                            } else {
                                playSound('error');
                                showModal('Ø®Ø·Ø§!', 'Ø·Ù„Ø§ÛŒ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø§ÛŒÙ† ØªÙ… Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.');
                            }
                        }
                    };
                    themeContainer.appendChild(btn);
                });
            }

            // --- EVENT LISTENERS ---
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => navigateTo(btn.dataset.target));
            });

            document.getElementById('registerBtn').addEventListener('click', () => {
                const username = document.getElementById('usernameInput').value.trim();
                if (username) {
                    playSound('click');
                    createUser(username);
                    init();
                } else {
                    playSound('error');
                    showModal('Ø®Ø·Ø§', 'Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
                }
            });
            
            document.getElementById('startGameBtn')?.addEventListener('click', setupLevel);
            document.getElementById('resetLevelBtn').addEventListener('click', () => { playSound('click'); setupLevel(); });
            document.getElementById('hintBtn').addEventListener('click', useHint);
            
            document.getElementById('claimDailyRewardBtn').addEventListener('click', () => {
                playSound('click');
                modalContainer.style.display = 'none';
                dailyRewardModal.style.display = 'none';
            });
            
            document.getElementById('tutorialConfirmBtn').addEventListener('click', () => {
                playSound('click');
                modalContainer.style.display = 'none';
                tutorialOverlay.style.display = 'none';
                currentUser.hasSeenTutorial = true;
                saveUser();
            });

            document.getElementById('clearDataBtn').addEventListener('click', () => {
                playSound('click');
                if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ù¾ÛŒØ´Ø±ÙØª Ø´Ù…Ø§ØŒ Ø·Ù„Ø§ Ùˆ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!')) {
                    localStorage.removeItem(DB_KEY);
                    window.location.reload();
                }
            });

            // Start the application
            setTimeout(init, 1500);
        });
    </script>
</body>
</html>
